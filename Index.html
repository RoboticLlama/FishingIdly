<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fishing Idly</title>
  <style>
    body {
      background-color: #1b2735;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      height: 100vh; margin: 0; position: relative; overflow: hidden;
    }
    h1 { font-size: 3rem; margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 3px; }
    button {
      background-color: #3a506b; color: #fff; border: none; padding: 1rem 2rem;
      font-size: 1.1rem; border-radius: 10px; cursor: pointer; transition: background-color .2s;
    }
    button:hover { background-color: #5bc0be; color: #1b2735; }

    .signin-top { position: absolute; top: 20px; right: 30px; background: #3a506b; color:#e0e0e0; padding:.5rem 1rem; border-radius:8px; text-decoration:none; }
    .signin-top:hover { background:#5bc0be; color:#1b2735; }

    .overlay { position: fixed; inset:0; background: rgba(0,0,0,.65); display:none; justify-content:center; align-items:center; z-index: 20; }
    .signin-box {
      background: linear-gradient(135deg, #2a3d56, #3a506b);
      padding: 2rem; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,.4);
      width: 300px; text-align:center; transform: scale(.8); opacity: 0; animation: pop .3s forwards;
    }
    .signin-box input {
      width: 90%; padding: .7rem; margin: .5rem 0; border: none; border-radius: 8px;
      outline: none; background:#1b2735; color:#e0e0e0;
    }
    .toggle-link { display:block; margin-top:1rem; color:#9ad4d6; cursor:pointer; text-decoration:underline; font-size:.9rem; }
    @keyframes pop { to { transform: scale(1); opacity: 1; } }

    /* --- Game Layout --- */
    .game-container { display: none; width: 100%; height: 100vh; flex-direction: row; }
    .sidebar {
      width: 200px; background:#2a3d56; display:flex; flex-direction:column; justify-content:space-between; align-items:center;
      padding: 20px 0; border-right: 2px solid #5bc0be;
    }
    .nav-buttons { display:flex; flex-direction:column; align-items:center; width:100%; }
    .nav-buttons button { width:80%; margin:10px 0; background:#3a506b; }
    .nav-buttons button:hover { background:#5bc0be; color:#1b2735; }
    .logout-btn { background:#b0413e; color:#fff; width:80%; margin-bottom:10px; white-space:nowrap; }
    .logout-btn:hover { background:#e24e4b; }
    .main-content { flex:1; display:flex; justify-content:center; align-items:center; text-align:center; padding: 30px; position: relative; }

    /* Admin reset button */
    .admin-reset-btn { background:#7a1f1b; color:#fff; width:80%; margin-bottom:10px; }
    .admin-reset-btn:hover { background:#a52b25; color:#fff; }

    /* HUD */
    .hud {
      position: absolute; top: 12px; right: 16px; background: rgba(0,0,0,.35);
      padding: 8px 12px; border-radius: 10px; font-size: .95rem; box-shadow: 0 0 0 1px rgba(255,255,255,.08) inset;
    }

    /* Pond/Area UI */
    .location-btn {
      margin: 10px; padding: 1rem 2rem; border-radius: 10px;
      background:#3a506b; color:#fff; font-size:1.05rem;
    }
    .location-btn:hover { background:#5bc0be; color:#1b2735; }

    /* üîí Locked area button style */
    .location-btn.locked {
      background: #2b394d;
      color: #9aa7b7;
      cursor: not-allowed;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    }
    .location-btn.locked:hover {
      background: #2b394d;
      color: #9aa7b7;
    }
    .lock-note {
      font-size: .9rem;
      opacity: .85;
      margin-top: 6px;
    }

    .pond-wrap { max-width: 640px; width: 100%; margin: 0 auto; }
    .status { margin: 10px 0 16px; opacity: .9; min-height: 1.2em; }

    .progress {
      position: relative; height: 10px; width: 100%; max-width: 560px;
      background:#0f1824; border-radius: 8px; overflow: hidden; margin: 10px auto 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .progress-fill { height: 100%; width: 0%; transition: width .06s linear; background: linear-gradient(90deg, #2e86ab, #6fffe9); }

    .meter {
      position: relative; height: 20px; width: 100%; max-width: 560px; background:#0f1824; border-radius: 12px;
      overflow: hidden; margin: 8px auto 12px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .meter-zone { position: absolute; top:0; bottom:0; border-left: 2px solid rgba(91,192,190,.9); border-right: 2px solid rgba(91,192,190,.9); background: rgba(91,192,190,.18); }
    .meter-fill { position: absolute; top:0; bottom:0; left:0; width: 20%; background: linear-gradient(90deg, #58a, #6fffe9); box-shadow: 0 0 10px rgba(111,255,233,.35); transition: left .03s linear, width .03s linear; }

    .row { display:flex; gap: 10px; justify-content:center; align-items:center; margin-top: 12px; flex-wrap: wrap; }
    .row button { min-width: 120px; }
    .small { font-size: .9rem; opacity: .8; }
    .success { color:#6fffe9; }
    .fail { color:#ff7a7a; }

    /* Backpack */
    .bp-wrap { width: 720px; max-width: 95vw; margin: 0 auto; text-align: left; }
    .bp-row {
      display: grid; grid-template-columns: 1fr auto 40px; gap: 12px; align-items: center; padding: 10px 12px; margin: 6px 0;
      background: rgba(0,0,0,.25); border-radius: 10px; box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
    }
    .bp-name { font-weight: 600; }
    .bp-meta { opacity: .85; }

    .heart { width: 36px; height: 36px; border-radius: 8px; background: rgba(0,0,0,.2); display: flex; align-items: center; justify-content: center; user-select: none; }
    .heart-btn {
      padding: 0 !important; background: transparent !important; border: none; box-shadow: none;
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      font-size: 18px; line-height: 1; color: #9ad4d6; cursor: pointer; border-radius: 6px;
    }
    .heart-btn:hover { background: rgba(255,255,255,0.08) !important; }
    .heart-btn.fav { color: #ff7aa2; }
    .heart-btn:focus-visible { outline: 2px solid #5bc0be; outline-offset: 2px; }

    .bp-hint { margin-top: 8px; font-size: .9rem; opacity: .8; }

    /* Popups */
    .gold-pop { position: absolute; right: 24px; top: 36px; font-weight: bold; animation: floatUp 1s ease forwards; }
    .xp-pop { position: absolute; right: 24px; top: 64px; font-weight: bold; animation: floatUp 1s ease forwards; color: #9ad4d6; }
    @keyframes floatUp { 0%{opacity:0; transform: translateY(10px);} 15%{opacity:1;} 85%{opacity:1;} 100%{opacity:0; transform: translateY(-12px);} }

    /* Shop */
    .shop-wrap { width: 720px; max-width: 95vw; margin: 0 auto; text-align: left; }
    .sell-list .sell-row {
      display:grid; grid-template-columns: 1fr auto auto; gap:12px; align-items:center;
      padding:10px 12px; margin:6px 0; background: rgba(0,0,0,.25); border-radius:10px; box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
    }
    .sell-summary { margin-top: 10px; opacity:.9; }

    /* Variant colors (text color) */
    .variant-bronze   { color: #b87333; font-weight: 600; }
    .variant-silver   { color: #c0c0c0; font-weight: 600; }
    .variant-gold     { color: #ffd700; font-weight: 700; text-shadow: 0 0 6px rgba(255,215,0,.25); }
    .variant-diamond  { color: #7dd3fc; font-weight: 700; text-shadow: 0 0 6px rgba(125,211,252,.25); }
    .variant-rainbow  { font-weight: 800; background: linear-gradient(90deg,#ff6,#f9f,#6ff,#9f6,#f96);
                        -webkit-background-clip: text; background-clip: text; color: transparent;
                        text-shadow: 0 0 10px rgba(255,255,255,.15); }

    /* Status highlights: background only (don‚Äôt override variant color) */
    .status-frozen       { background: rgba(120, 180, 255, 0.85); color: inherit; padding: 0 .25em; border-radius: 6px; }
    .status-electrocuted { background: rgba(250, 230,  90, 0.85); color: inherit; padding: 0 .25em; border-radius: 6px; }
    .status-burned       { background: rgba(255, 120,  90, 0.85); color: inherit; padding: 0 .25em; border-radius: 6px; }

    /* Leaderboard */
    .board-wrap { width: 720px; max-width: 95vw; margin: 0 auto; text-align:left; }
    .board-table { width:100%; border-collapse: collapse; }
    .board-table th, .board-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,.08); }
    .board-table th { text-align:left; opacity:.9; }
    .me-row { background: rgba(155, 201, 255, 0.08); }

    /* Scrollable panels for long lists */
    .scroll-panel {
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 6px;
    }
    .scroll-panel::-webkit-scrollbar { width: 8px; }
    .scroll-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 6px; }
    .scroll-panel::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }

    /* Hide XP column visually (kept for ranking) */
    .col-xp { display: none; }
    thead .col-xp { display: none; }
  </style>
</head>
<body>
  <a href="#" class="signin-top" id="signinLink">Sign In</a>

  <h1 id="title">Fishing Idly</h1>
  <button id="startButton">Start</button>

  <!-- Sign In / Up -->
  <div class="overlay" id="overlay">
    <div class="signin-box">
      <div id="signinForm">
        <h2>Sign In</h2>
        <input type="text" id="signin-username" placeholder="Username"/>
        <input type="password" id="signin-password" placeholder="Password"/>
        <button id="loginButton">Log In</button>
        <span class="toggle-link" id="showSignup">Don‚Äôt have an account? Sign Up</span>
      </div>
      <div id="signupForm" style="display:none;">
        <h2>Create Account</h2>
        <input type="email" id="signup-email" placeholder="Email"/>
        <input type="text" id="signup-username" placeholder="Username"/>
        <input type="password" id="signup-password" placeholder="Password"/>
        <button id="signupButton">Sign Up</button>
        <span class="toggle-link" id="showSignin">Already have an account? Sign In</span>
      </div>
    </div>
  </div>

  <!-- üîì Area Unlock Modal -->
  <div class="overlay" id="unlockOverlay" style="display:none;">
    <div class="signin-box" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
      <h2 id="unlockTitle">New Area Unlocked!</h2>
      <p>You can now access: <b>üåä Stream</b></p>
      <button id="unlockOkBtn">Let‚Äôs go</button>
    </div>
  </div>

  <!-- Game UI -->
  <div class="game-container" id="gameContainer">
    <div class="sidebar">
      <div class="nav-buttons">
        <button id="fishingSpotBtn">üé£ Fishing Spot</button>
        <button id="farmBtn">üåæ Farm</button>
        <button id="backpackBtn">üéí Backpack</button>
        <button id="shopBtn">üõí Shop</button>
        <button id="leaderboardBtn">üèÜ Leaderboard</button>
      </div>
      <button class="admin-reset-btn" id="adminResetBtn" style="display:none;">‚ö† Reset All Data</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <div class="main-content" id="mainContent">
      <div class="hud" id="goldHud">üí∞ 0 ¬∑ ‚≠ê Lv 1 (0/20)</div>
      Welcome back, fisherman! Choose an option from the left to begin.
    </div>
  </div>

  <script>
    // Elements
    const overlay = document.getElementById('overlay');
    const signinLink = document.getElementById('signinLink');
    const startButton = document.getElementById('startButton');
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    const showSignup = document.getElementById('showSignup');
    const showSignin = document.getElementById('showSignin');
    const gameContainer = document.getElementById('gameContainer');
    const mainContent = document.getElementById('mainContent');
    const title = document.getElementById('title');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminResetBtn = document.getElementById('adminResetBtn');

    // Unlock modal controls
    const unlockOverlay = document.getElementById('unlockOverlay');
    function showUnlockModal(areaName = 'Stream') {
      if (!unlockOverlay) return;
      unlockOverlay.style.display = 'flex';
      const btn = document.getElementById('unlockOkBtn');
      if (btn) {
        btn.onclick = () => { unlockOverlay.style.display = 'none'; };
      }
    }

    // Modal behavior (fix: preventDefault on anchors)
    const openModal = () => overlay.style.display = 'flex';
    signinLink.addEventListener('click', (e) => { e.preventDefault(); openModal(); });
    startButton.addEventListener('click', (e) => { e.preventDefault?.(); openModal(); });
    showSignup.addEventListener('click', () => { signinForm.style.display='none'; signupForm.style.display='block'; });
    showSignin.addEventListener('click', () => { signupForm.style.display='none'; signinForm.style.display='block'; });
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.style.display = 'none'; });

    // Storage helpers
    const getPlayers = () => JSON.parse(localStorage.getItem('players')) || [];
    const savePlayers = (players) => localStorage.setItem('players', JSON.stringify(players));
    const getCurrentUser = () => JSON.parse(localStorage.getItem('currentUser'));
    const setCurrentUser = (u) => localStorage.setItem('currentUser', JSON.stringify(u));

    // --- Per-user flags (e.g., unlock notifications)
    function getUserFlags() {
      const cu = getCurrentUser(); if (!cu) return {};
      return cu.flags || {};
    }
    function setUserFlags(nextFlags) {
      const cu = getCurrentUser(); if (!cu) return;
      cu.flags = { ...(cu.flags||{}), ...nextFlags };
      setCurrentUser(cu);
      const players = getPlayers();
      const idx = players.findIndex(p => p.username === cu.username);
      if (idx !== -1) { players[idx].flags = cu.flags; savePlayers(players); }
    }
    function isStreamUnlocked() {
      return (getStats().level || 1) >= 10;
    }

    // Master check
    function isMasterUser(u = getCurrentUser()) { return !!u && (u.username === 'Llama'); }

    // Stats helpers
    function defaultStats() { return { rodLevel: 1, baitTier: 0, level: 1, xp: 0 }; }
    function getStats() {
      const cu = getCurrentUser(); if (!cu) return defaultStats();
      cu.rodLevel = cu.rodLevel ?? 1;
      cu.baitTier = cu.baitTier ?? 0;
      cu.level    = cu.level ?? 1;
      cu.xp       = cu.xp ?? 0;
      setCurrentUser(cu);
      const players = getPlayers();
      const idx = players.findIndex(p => p.username === cu.username);
      if (idx !== -1) {
        players[idx].rodLevel = cu.rodLevel;
        players[idx].baitTier = cu.baitTier;
        players[idx].level    = cu.level;
        players[idx].xp       = cu.xp;
        savePlayers(players);
      }
      return { rodLevel: cu.rodLevel, baitTier: cu.baitTier, level: cu.level, xp: cu.xp };
    }
    function setStats(stats) {
      const cu = getCurrentUser(); if (!cu) return;
      cu.rodLevel = stats.rodLevel ?? 1;
      cu.baitTier = stats.baitTier ?? 0;
      cu.level    = stats.level ?? 1;
      cu.xp       = stats.xp ?? 0;
      setCurrentUser(cu);
      const players = getPlayers();
      const idx = players.findIndex(p => p.username === cu.username);
      if (idx !== -1) {
        players[idx].rodLevel = cu.rodLevel;
        players[idx].baitTier = cu.baitTier;
        players[idx].level    = cu.level;
        players[idx].xp       = cu.xp;
        savePlayers(players);
      }
      updateGoldHud();
    }

    // XP / Level (with unlock check at 10)
    function xpNeededFor(level) { return 20 + (level - 1) * 10; }
    function addXP(amount) {
      const before = getStats();
      let xp = (before.xp ?? 0) + amount;
      let level = before.level ?? 1;
      let leveled = 0;

      while (xp >= xpNeededFor(level)) {
        xp -= xpNeededFor(level);
        level += 1;
        leveled += 1;
      }

      setStats({ ...before, xp, level });
      xpPopup(`+${amount} XP`);
      if (leveled > 0) {
        goldPopup(`‚≠ê Level Up! Lv ${level - leveled} ‚Üí ${level}`);

        // First time reaching Level 10+: show unlock modal once
        const flags = getUserFlags();
        if (level >= 10 && !flags.streamUnlockNotified) {
          setUserFlags({ streamUnlockNotified: true });
          showUnlockModal('Stream');
        }
      }
    }

    // HUD
    function goldHudEl() { return document.getElementById('goldHud'); }
    function updateGoldHud() {
      const cu = getCurrentUser();
      const s = getStats();
      const el = goldHudEl();
      if (el) el.textContent = `üí∞ ${cu?.coins ?? 0} ¬∑ ‚≠ê Lv ${s.level} (${s.xp}/${xpNeededFor(s.level)})`;
    }
    function addGold(amount) {
      const cu = getCurrentUser(); if (!cu) return;
      cu.coins = (cu.coins ?? 0) + amount; setCurrentUser(cu);
      const players = getPlayers();
      const idx = players.findIndex(p => p.username === cu.username);
      if (idx !== -1) { players[idx].coins = cu.coins; savePlayers(players); }
      updateGoldHud(); goldPopup(`+${amount} gold`);
    }
    function goldPopup(text) {
      const el = document.createElement('div');
      el.className = 'gold-pop'; el.textContent = text;
      mainContent.appendChild(el); setTimeout(()=> el.remove(), 1000);
    }
    function xpPopup(text) {
      const el = document.createElement('div');
      el.className = 'xp-pop'; el.textContent = text;
      mainContent.appendChild(el); setTimeout(()=> el.remove(), 1100);
    }

    // ---------- Variant normalization helpers ----------
    const VALID_VARIANTS = new Set(['none','bronze','silver','gold','diamond','rainbow']);
    function normalizeVariantKey(v){
      if (!v) return 'none';
      const s = String(v).toLowerCase().trim();
      if (s === 'copper') return 'bronze'; // legacy remap
      return VALID_VARIANTS.has(s) ? s : 'none';
    }
    function prettyLabelFromKey(k){
      switch (normalizeVariantKey(k)) {
        case 'bronze':   return 'Bronze';
        case 'silver':   return 'Silver';
        case 'gold':     return 'Gold';
        case 'diamond':  return 'Diamond';
        case 'rainbow':  return 'Rainbow';
        default:         return '';
      }
    }

    // Inventory
    function getInventory() {
      const cu = getCurrentUser(); if (!cu) return [];
      const raw = cu.items || [];
      const upgraded = raw.map(it => {
        if (typeof it === 'string') {
          const meta = lookupItemMeta(it);
          return {
            name: meta.name, type: meta.type, value: meta.value ?? 0, favorite: false,
            variantBaseKey: 'none', variantBaseLabel: '', statusLabel: ''
          };
        }
        const normKey = normalizeVariantKey(
          it.variantBaseKey ?? it.variantBase ?? it.variant ?? it.variantBaseLabel
        );
        const label = it.variantBaseLabel ?? prettyLabelFromKey(normKey);

        return {
          name: it.name,
          type: it.type ?? lookupItemMeta(it.name).type,
          value: (typeof it.value === 'number') ? it.value : (lookupItemMeta(it.name).value ?? 0),
          favorite: !!it.favorite,
          variantBaseKey: normKey,
          variantBaseLabel: label,
          statusLabel: it.statusLabel || ''
        };
      });
      if (JSON.stringify(raw) !== JSON.stringify(upgraded)) setInventory(upgraded);
      return upgraded;
    }
    function setInventory(newInv) {
      const cu = getCurrentUser(); if (!cu) return;
      cu.items = newInv; setCurrentUser(cu);
      const players = getPlayers();
      const idx = players.findIndex(p => p.username === cu.username);
      if (idx !== -1) { players[idx].items = newInv; savePlayers(players); }
    }

    // Gear
    function ensureStarterGear() {
      let inv = getInventory();
      if (!inv.some(i => i.type === 'gear-rod')) inv.push({ name: 'Starter Rod (Lv1)', type: 'gear-rod', value: 0, favorite: false });
      if (!inv.some(i => i.type === 'gear-bait')) inv.push({ name: 'No Bait (T0)', type: 'gear-bait', value: 0, favorite: false });
      setInventory(inv);
    }
    function equipRod(level) {
      let inv = getInventory();
      inv = inv.filter(i => i.type !== 'gear-rod');
      inv.push({ name: `Rod (Lv${level})`, type: 'gear-rod', value: 0, favorite: false });
      setInventory(inv);
    }
    function equipBait(tier) {
      let inv = getInventory();
      inv = inv.filter(i => i.type !== 'gear-bait');
      inv.push({ name: `Bait (T${tier})`, type: 'gear-bait', value: 0, favorite: false });
      setInventory(inv);
    }

    // ---------- Fishing difficulty + minigame ----------
    const rarityConfig = {
      common:    { zoneMin: 28, zoneMax: 72, drift: 0.25, wobble: 0.6,  timeToLand: 2200 },
      uncommon:  { zoneMin: 33, zoneMax: 67, drift: 0.38, wobble: 0.9,  timeToLand: 3000 },
      rare:      { zoneMin: 40, zoneMax: 60, drift: 0.55, wobble: 1.2,  timeToLand: 3800 },
      epic:      { zoneMin: 42, zoneMax: 58, drift: 0.65, wobble: 1.4,  timeToLand: 4600 },
      legendary: { zoneMin: 44, zoneMax: 56, drift: 0.75, wobble: 1.6,  timeToLand: 5200 }
    };

    function weightedPick(table) {
      const total = table.reduce((a,c)=>a+c.weight,0);
      let roll = Math.random() * total;
      for (const item of table) { if ((roll -= item.weight) <= 0) return item; }
      return table[0];
    }

    // Variants (one base + one elemental)
    const VARIANT_BASES = [
      { key:'none',     label:'',        mult:1.00, chance:null,  wobble:0,    zoneNarrow:0,    timeUp:0,   driftUp:0 },
      { key:'bronze',   label:'Bronze',  mult:1.25, chance:0.050, wobble:0.05, zoneNarrow:0.02, timeUp:0.02, driftUp:0.05 },
      { key:'silver',   label:'Silver',  mult:1.50, chance:0.045, wobble:0.10, zoneNarrow:0.03, timeUp:0.04, driftUp:0.08 },
      { key:'gold',     label:'Gold',    mult:2.00, chance:0.040, wobble:0.15, zoneNarrow:0.04, timeUp:0.06, driftUp:0.12 },
      { key:'diamond',  label:'Diamond', mult:3.00, chance:0.020, wobble:0.25, zoneNarrow:0.06, timeUp:0.09, driftUp:0.18 },
      { key:'rainbow',  label:'Rainbow', mult:5.00, chance:0.007, wobble:0.35, zoneNarrow:0.08, timeUp:0.12, driftUp:0.22 },
    ];
    const STATUS_POOL = [
      { key:'frozen',       label:'Frozen',       add:0.25, chance:0.10, wobble:0.05, zoneNarrow:0.01,  timeUp:0.02, driftUp:0.03 },
      { key:'electrocuted', label:'Electrocuted', add:0.50, chance:0.10, wobble:0.08, zoneNarrow:0.015, timeUp:0.03, driftUp:0.05 },
      { key:'burned',       label:'Burned',       add:0.75, chance:0.10, wobble:0.10, zoneNarrow:0.02,  timeUp:0.04, driftUp:0.06 },
    ];
    function rollBaseVariant() {
      const sorted = VARIANT_BASES.filter(v=>v.key!=='none').sort((a,b)=>a.chance-b.chance);
      const r = Math.random(); let acc = 0;
      for (const v of sorted) { acc += v.chance; if (r < acc) return v; }
      return VARIANT_BASES[0];
    }
    function rollSingleStatus() {
      for (const s of STATUS_POOL) { if (Math.random() < s.chance) return s; }
      return null;
    }
    function buildVariantResult() {
      const base = rollBaseVariant();
      const status = rollSingleStatus();
      const statusMult = status ? (1 + status.add) : 1;
      const totalMult = base.mult * statusMult;
      const diff = {
        wobble: (base.wobble) + (status?.wobble || 0),
        zoneNarrow: (base.zoneNarrow) + (status?.zoneNarrow || 0),
        timeUp: (base.timeUp) + (status?.timeUp || 0),
        driftUp: (base.driftUp) + (status?.driftUp || 0),
      };
      return { base, status, totalMult, diff };
    }

    // Styled fish-name rendering (variant color + status highlight)
    function variantClassFor(key){ if (!key || key==='none') return ''; return `variant-${key}`; }
    function statusClassFor(key){ return key ? `status-${key}` : ''; }
    function renderStyledFishName(item) {
      const baseKey   = normalizeVariantKey(item.variantBaseKey || item.variantBase || item.variant || item.variantBaseLabel);
      const statusKey = (item.statusLabel ? item.statusLabel.toLowerCase() : '').replace(/\s+/g,'');
      const vClass = baseKey && baseKey !== 'none' ? `variant-${baseKey}` : '';
      const sClass = statusKey ? `status-${statusKey}` : '';
      if (sClass && vClass) {
        return `<span class="${sClass}"><span class="${vClass}">${item.name}</span></span>`;
      } else if (sClass) {
        return `<span class="${sClass}">${item.name}</span>`;
      } else if (vClass) {
        return `<span class="${vClass}">${item.name}</span>`;
      }
      return item.name;
    }

    // ---------- Auth ----------
    document.getElementById('signupButton').addEventListener('click', () => {
      const email = document.getElementById('signup-email').value.trim();
      const username = document.getElementById('signup-username').value.trim();
      const password = document.getElementById('signup-password').value.trim();
      if (!email || !username || !password) return alert("Please fill all fields.");
      let players = getPlayers();
      if (players.find(p => p.username === username)) return alert("Username already exists!");
      players.push({ email, username, password, items: [], coins: 0, ...defaultStats() });
      savePlayers(players);
      alert("Account created!");
      signupForm.style.display = 'none'; signinForm.style.display = 'block';
    });

    function ensureMasterRecord() {
      const players = getPlayers();
      let rec = players.find(p => p.username === "Llama");
      if (!rec) {
        rec = { email: "llama@test.local", username: "Llama", password: "Helloworld", items: [], coins: 0, testAccount: true, ...defaultStats() };
        players.push(rec);
        savePlayers(players);
      } else {
        rec.password = "Helloworld";
        rec.email = rec.email || "llama@test.local";
        rec.testAccount = true;
        rec.rodLevel = rec.rodLevel ?? 1;
        rec.baitTier = rec.baitTier ?? 0;
        rec.level    = rec.level ?? 1;
        rec.xp       = rec.xp ?? 0;
        savePlayers(players);
      }
      return rec;
    }

    document.getElementById('loginButton').addEventListener('click', () => {
      const u = document.getElementById('signin-username').value.trim();
      const p = document.getElementById('signin-password').value.trim();

      if (u === "Llama" && p === "Helloworld") {
        const rec = ensureMasterRecord();
        setCurrentUser(rec);
        launchGame(rec.username);
        return;
      }

      const players = getPlayers();
      const user = players.find(x => x.username === u && x.password === p);
      if (user) { setCurrentUser(user); launchGame(user.username); }
      else alert("Invalid credentials!");
    });

    function adminResetAllData() {
      if (!isMasterUser()) return;
      const sure = confirm("‚ö† This will delete ALL saved players, items, coins, and progress on this device. Continue?");
      if (!sure) return;
      const extra = confirm("Are you absolutely sure? This cannot be undone.");
      if (!extra) return;
      localStorage.removeItem('players');
      localStorage.removeItem('currentUser');
      alert("All saved data has been cleared.");
      location.reload();
    }

    function launchGame(username) {
      overlay.style.display = 'none';
      title.style.display = 'none';
      startButton.style.display = 'none';
      signinLink.style.display = 'none';
      gameContainer.style.display = 'flex';
      ensureStarterGear();
      mainContent.innerHTML = `<div class="hud" id="goldHud">üí∞ ${(getCurrentUser()?.coins ?? 0)} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>Welcome back, ${username}! Choose where to go.`;
      updateGoldHud();

      if (isMasterUser()) {
        adminResetBtn.style.display = 'block';
        adminResetBtn.onclick = adminResetAllData;
      } else {
        adminResetBtn.style.display = 'none';
        adminResetBtn.onclick = null;
      }
    }

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      gameContainer.style.display = 'none';
      title.style.display = 'block';
      startButton.style.display = 'block';
      signinLink.style.display = 'block';
      mainContent.innerHTML = "";
      adminResetBtn.style.display = 'none';
      adminResetBtn.onclick = null;
    });

    (function autoLogin(){
      const saved = getCurrentUser();
      if (saved?.username) {
        const players = getPlayers();
        const stored = players.find(p => p.username === saved.username);
        if (stored) setCurrentUser(stored);
        launchGame((stored || saved).username);
      }
      // Notify once if already level 10+
      const s = getStats();
      const flags = getUserFlags();
      if (s.level >= 10 && !flags.streamUnlockNotified) {
        setUserFlags({ streamUnlockNotified: true });
        showUnlockModal('Stream');
      }
    })();

    // ---------- Pond Table ----------
    const pondTable = [
      // Common (total 40)
      { name: "Crappie",         type: "fish",  weight: 16, rarity: "common",   value: 4  },
      { name: "Pumpkinseed",     type: "fish",  weight: 12, rarity: "common",   value: 4  },
      { name: "Yellow Perch",    type: "fish",  weight: 12, rarity: "common",   value: 4  },

      // Uncommon (total 20)
      { name: "Bluegill",        type: "fish",  weight: 9,  rarity: "uncommon", value: 6  },
      { name: "Catfish",         type: "fish",  weight: 7,  rarity: "uncommon", value: 8  },
      { name: "Carp",            type: "fish",  weight: 4,  rarity: "uncommon", value:10  },

      // Rare (total 10)
      { name: "Goldfish",        type: "fish",  weight: 10, rarity: "rare",     value:15  },

      // Epic (total 4)
      { name: "Largemouth Bass", type: "fish",  weight: 4,  rarity: "epic",     value:20  },

      // Legendary (total 1)
      { name: "Golden Koi",      type: "fish",  weight: 1,  rarity: "legendary",value:40  },

      // Trash (total 25 ‚Üí each 5)
      { name: "Old Boot",        type: "trash", weight: 5,  value: 1 },
      { name: "Tin Can",         type: "trash", weight: 5,  value: 1 },
      { name: "Tangled Line",    type: "trash", weight: 5,  value: 1 },
      { name: "Broken Glass",    type: "trash", weight: 5,  value: 1 },
      { name: "Rusty Hook",      type: "trash", weight: 5,  value: 1 }
    ];
    function lookupItemMeta(name) {
      return pondTable.find(i => i.name === name) || { name, type:'unknown', value:0, rarity:'common' };
    }

    // ---------- Navigation ----------
    document.getElementById('fishingSpotBtn').addEventListener('click', () => {
      const s = getStats();
      const unlocked = s.level >= 10;

      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${(getCurrentUser()?.coins ?? 0)} ¬∑ ‚≠ê Lv ${s.level} (${s.xp}/${xpNeededFor(s.level)})</div>
        <div class="pond-wrap">
          <h2>üé£ Fishing Spot</h2>
          <p>Select your location:</p>
          <button class="location-btn" id="pondBtn">üêü Pond</button>
          <button class="location-btn ${unlocked ? '' : 'locked'}" id="streamBtn" ${unlocked ? '' : 'disabled'}>üåä Stream</button>
          ${unlocked ? '' : '<div class="lock-note">Reach <b>Level 10</b> to access the Stream.</div>'}
        </div>
      `;
      updateGoldHud();
      document.getElementById('pondBtn').addEventListener('click', showPond);

      const streamBtn = document.getElementById('streamBtn');
      if (streamBtn) {
        if (unlocked) {
          streamBtn.addEventListener('click', showStream);
        } else {
          streamBtn.addEventListener('click', () => alert('Locked: Reach Level 10 to access the Stream.'));
        }
      }
    });

    document.getElementById('farmBtn').addEventListener('click', renderFarm);
    function renderFarm() {
      const coins = getCurrentUser()?.coins ?? 0;
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="pond-wrap">
          <h2>üåæ Farm</h2>
          <p>Coming soon: plant seeds, harvest crops for bait and buffs.</p>
        </div>
      `;
      updateGoldHud();
    }

    document.getElementById('leaderboardBtn').addEventListener('click', renderLeaderboard);
    function renderLeaderboard() {
      const coins = getCurrentUser()?.coins ?? 0;
      const me = getCurrentUser();
      const players = getPlayers().slice().sort((a,b)=>{
        if ((b.level||1)!==(a.level||1)) return (b.level||1)-(a.level||1);
        if ((b.xp||0)!==(a.xp||0)) return (b.xp||0)-(a.xp||0);
        if ((b.coins||0)!==(a.coins||0)) return (b.coins||0)-(a.coins||0);
        return (a.username||'').localeCompare(b.username||'');
      });

      const rows = players.map((p, i) => {
        const isMe = me && p.username === me.username;
        const cls = isMe ? ' class="me-row"' : '';
        return `
          <tr${cls}>
            <td>#${i+1}</td>
            <td>${p.username || '‚Äî'}</td>
            <td>Lv ${p.level ?? 1}</td>
            <td class="col-xp">${p.xp ?? 0}</td>
            <td>${p.coins ?? 0}g</td>
          </tr>
        `;
      }).join('');

      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="board-wrap">
          <h2>üèÜ Leaderboard</h2>
          <p class="small">Sorted by Level ‚Üí XP ‚Üí Coins.</p>
          <table class="board-table" aria-label="Leaderboard">
            <thead>
              <tr><th>Rank</th><th>Player</th><th>Level</th><th class="col-xp">XP</th><th>Coins</th></tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="5">No players yet.</td></tr>`}
            </tbody>
          </table>
        </div>
      `;
      updateGoldHud();
    }

    // ---------- Stream Area (gated at Lv10) ----------
    function showStream() {
      if (!isStreamUnlocked()) {
        alert('Locked: Reach Level 10 to access the Stream.');
        return;
      }

      const s = getStats();
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${(getCurrentUser()?.coins ?? 0)} ¬∑ ‚≠ê Lv ${s.level} (${s.xp}/${xpNeededFor(s.level)})</div>
        <div class="pond-wrap">
          <h2>üåä Stream</h2>
          <div class="status" id="streamStatus">The current is swift and the water is clear. (Area WIP)</div>
          <div class="row" id="streamControls">
            <button id="backToSpots">‚Üê Back to Spots</button>
          </div>
          <p class="small" style="margin-top:10px;">(We‚Äôll hook up unique fish and tuning here next.)</p>
        </div>
      `;
      updateGoldHud();
      const backBtn = document.getElementById('backToSpots');
      if (backBtn) backBtn.onclick = () => document.getElementById('fishingSpotBtn').click();
    }

    // ---------- Pond + Minigame (one-time Cast, then Recast; Space support) ----------
    function showPond() {
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${(getCurrentUser()?.coins ?? 0)} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="pond-wrap">
          <h2>üêü Pond</h2>
          <div class="status" id="pondStatus">Cast your line into the quiet pond.</div>

          <div class="progress" id="searchProg" style="display:none;">
            <div class="progress-fill" id="searchFill"></div>
          </div>

          <div class="row" id="castRow">
            <button id="castBtn">Cast</button>
          </div>

          <div id="minigameArea" style="margin-top:14px;"></div>
          <div class="small" style="margin-top:10px;">
            Tip: Hold <b>Reel</b> (or hold <b>Space</b>) to raise tension; release to let it fall.
            Keep it inside the glowing zone to land the fish.
          </div>
        </div>
      `;
      updateGoldHud();

      const status = document.getElementById('pondStatus');
      const area = document.getElementById('minigameArea');
      const searchProg = document.getElementById('searchProg');
      const searchFill = document.getElementById('searchFill');
      const castRow = document.getElementById('castRow');
      const castBtn = document.getElementById('castBtn');

      // Space-to-Recast toggle
      let spaceRecastKeydown = null;
      function setSpaceRecast(handler) {
        if (spaceRecastKeydown) {
          window.removeEventListener('keydown', spaceRecastKeydown);
          spaceRecastKeydown = null;
        }
        if (handler) {
          spaceRecastKeydown = (e) => {
            if (e.code === 'Space' || e.key === ' ') {
              e.preventDefault();
              handler();
            }
          };
          window.addEventListener('keydown', spaceRecastKeydown);
        }
      }

      const runCastCycle = async () => {
        setSpaceRecast(null); // disable space-recast while searching/reeling
        castRow.style.display = 'none';
        area.innerHTML = '';
        status.textContent = "Looking for the next fish...";
        searchProg.style.display = 'block';
        searchFill.style.width = '0%';

        const { baitTier } = getStats();
        const baseWait = 900 + Math.random()*1800;
        const waitMs = Math.max(300, baseWait * (1 - 0.1 * baitTier));
        await animateProgress(searchFill, waitMs);
        searchProg.style.display = 'none';

        const hooked = weightedPick(pondTable);

        if (hooked.type === 'trash') {
          status.innerHTML = `You reeled in <b>${hooked.name}</b> (+${hooked.value}g).`;
          saveCatchToUser(hooked.name);
          addXP(1);
          area.innerHTML = `
            <div class="row">
              <button id="recastBtn">Recast</button>
            </div>
          `;
          document.getElementById('recastBtn').onclick = runCastCycle;
          setSpaceRecast(runCastCycle); // Spacebar to recast
          return;
        }

        // Build variant + status
        const vr = buildVariantResult();
        const statusLabel = vr.status ? vr.status.label : '';

        // Difficulty with modifiers
        const cfg = { ...(rarityConfig[hooked.rarity] || rarityConfig.common) };
        const zoneCenter = (cfg.zoneMin + cfg.zoneMax)/2;
        const width = (cfg.zoneMax - cfg.zoneMin);
        const newWidth = Math.max(8, width * (1 - vr.diff.zoneNarrow));
        cfg.zoneMin = Math.max(5, zoneCenter - newWidth/2);
        cfg.zoneMax = Math.min(95, zoneCenter + newWidth/2);
        cfg.wobble  = cfg.wobble * (1 + vr.diff.wobble);
        cfg.drift   = (cfg.drift || 0.35) * (1 + vr.diff.driftUp);
        cfg.timeToLand = Math.round(cfg.timeToLand * (1 + vr.diff.timeUp));

        status.innerHTML = `Bite! Keep the tension in the zone to land it!`;

        startReelMinigameWithConfig(area, hooked, cfg, (success, reelBtnRef) => {
          if (success) {
            const baseValue = hooked.value || 0;
            const finalValue = Math.max(0, Math.round(baseValue * vr.totalMult));

            const tempItemForStyle = {
              name: hooked.name,
              variantBaseKey: normalizeVariantKey(vr.base.key),
              statusLabel
            };
            status.innerHTML = `<span class="success">Success!</span> You caught a <b>${renderStyledFishName(tempItemForStyle)}</b> (+${finalValue}g).`;

            saveCatchToUser({
              name: hooked.name,
              type: hooked.type,
              value: finalValue,
              favorite: false,
              variantBaseKey: normalizeVariantKey(vr.base.key),
              variantBaseLabel: prettyLabelFromKey(vr.base.key),
              statusLabel
            });

            const xpByRarity = { common: 2, uncommon: 4, rare: 8, epic: 12, legendary: 20 };
            addXP(xpByRarity[hooked.rarity] ?? 2);
          } else {
            status.innerHTML = `<span class="fail">It got away!</span>`;
          }

          if (reelBtnRef) {
            reelBtnRef.textContent = 'Recast';
            reelBtnRef.disabled = false;
            reelBtnRef.onmousedown = null;
            reelBtnRef.onmouseup = null;
            reelBtnRef.onmouseleave = null;
            reelBtnRef.ontouchstart = null;
            reelBtnRef.ontouchend = null;
            reelBtnRef.onclick = () => runCastCycle();
            setSpaceRecast(runCastCycle); // Spacebar to recast
          } else {
            area.innerHTML = `
              <div class="row">
                <button id="recastBtn">Recast</button>
              </div>
            `;
            document.getElementById('recastBtn').onclick = runCastCycle;
            setSpaceRecast(runCastCycle); // Spacebar to recast
          }
        });
      };

      castBtn.onclick = runCastCycle; // first cast only
    }

    async function animateProgress(fillEl, durationMs){
      const start = performance.now();
      return new Promise(resolve=>{
        function step(ts){
          const t = Math.min(1, (ts - start)/durationMs);
          fillEl.style.width = (t*100).toFixed(1) + '%';
          if (t < 1) requestAnimationFrame(step); else resolve();
        }
        requestAnimationFrame(step);
      });
    }

    // Minigame core (Space support, no Give Up) ‚Äî with edge grace
    function startReelMinigame(container, fish, onDone) {
      const cfg = rarityConfig[fish.rarity] || rarityConfig.common;

      const { rodLevel } = getStats();
      const eff = { ...cfg };
      const widen = Math.min(10, 2 * rodLevel);
      const center = (eff.zoneMin + eff.zoneMax) / 2;
      const width = (eff.zoneMax - eff.zoneMin) + widen;
      eff.zoneMin = Math.max(5, center - width/2);
      eff.zoneMax = Math.min(95, center + width/2);
      eff.wobble  = Math.max(0.25, eff.wobble * (1 - 0.08 * rodLevel));

      container.innerHTML = `
        <div class="progress" id="landProg">
          <div class="progress-fill" id="landFill"></div>
        </div>
        <div class="meter" id="meter">
          <div class="meter-zone" id="zone"></div>
          <div class="meter-fill" id="fill"></div>
        </div>
        <div class="row">
          <button id="reelBtn">Reel</button>
        </div>
      `;

      const reelBtn = document.getElementById('reelBtn');
      const fill = document.getElementById('fill');
      const zone = document.getElementById('zone');
      const landFill = document.getElementById('landFill');

      zone.style.left = eff.zoneMin + '%';
      zone.style.width = (eff.zoneMax - eff.zoneMin) + '%';

      let tension = 50, holding = false, landedTime = 0, lastTs = performance.now(), timer;

      // edge grace
      const FAIL_GRACE_MS = 220;
      let outOfBoundsMs = 0;

      const onHold = () => { holding = true; };
      const onRelease = () => { holding = false; };

      reelBtn.addEventListener('mousedown', onHold);
      reelBtn.addEventListener('mouseup', onRelease);
      reelBtn.addEventListener('mouseleave', onRelease);
      reelBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); onHold(); }, {passive:false});
      reelBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); onRelease(); }, {passive:false});

      // Space key hold
      const onKeyDown = (e) => {
        if (e.code === 'Space' || e.key === ' ') { e.preventDefault(); holding = true; }
      };
      const onKeyUp = (e) => {
        if (e.code === 'Space' || e.key === ' ') { e.preventDefault(); holding = false; }
      };
      window.addEventListener('keydown', onKeyDown);
      window.addEventListener('keyup', onKeyUp);

      function cleanup() {
        cancelAnimationFrame(timer);
        window.removeEventListener('keydown', onKeyDown);
        window.removeEventListener('keyup', onKeyUp);
      }

      function step(ts) {
        const dt = Math.min(50, ts - lastTs); lastTs = ts;
        const baseDrift = (eff.drift != null ? eff.drift : 0.25);

        // Drift up when holding, drop when not
        let drift = (holding ? baseDrift*2.2 : -baseDrift*1.6);
        // Natural wobble
        const wobble = (Math.sin(ts/140) + Math.cos(ts/310)) * eff.wobble;

        // Integrate and clamp
        tension += (drift + wobble) * (dt/16.7);
        tension = Math.max(0, Math.min(100, tension));

        // Move bar
        fill.style.left = (tension - 10) + '%';
        fill.style.width = '20%';

        // In-zone check
        const inZone = tension >= eff.zoneMin && tension <= eff.zoneMax;
        landedTime = inZone ? (landedTime + dt) : Math.max(0, landedTime - dt*0.35);
        const pct = Math.max(0, Math.min(100, (landedTime / eff.timeToLand) * 100));
        landFill.style.width = pct.toFixed(1) + '%';

        // Edge grace handling
        const atEdge = (tension <= 0.5 || tension >= 99.5);
        if (atEdge) {
          outOfBoundsMs += dt;
          if (outOfBoundsMs >= FAIL_GRACE_MS) return end(false);
        } else {
          outOfBoundsMs = Math.max(0, outOfBoundsMs - dt*0.5);
        }

        if (landedTime >= eff.timeToLand) return end(true);
        timer = requestAnimationFrame(step);
      }
      timer = requestAnimationFrame(step);

      function end(success) {
        cleanup();
        reelBtn.disabled = true;
        setTimeout(()=>onDone(success, reelBtn), 120);
      }
    }

    function startReelMinigameWithConfig(container, fish, customCfg, onDone) {
      const cfgKey = fish.rarity;
      const tempKey = `__temp_${cfgKey}`;
      rarityConfig[tempKey] = customCfg;
      const tempFish = { ...fish, rarity: tempKey };
      startReelMinigame(container, tempFish, (ok, btn) => {
        delete rarityConfig[tempKey];
        onDone(ok, btn);
      });
    }

    // Backpack
    document.getElementById('backpackBtn').addEventListener('click', renderBackpack);
    function friendlyMeta(item) {
      if (item.type === 'gear-rod')  return 'gear ¬∑ rod';
      if (item.type === 'gear-bait') return 'gear ¬∑ bait';
      return `${item.type}${item.value ? ` ¬∑ ${item.value}g` : ''}`;
    }
    function renderBackpack() {
      const inv = getInventory();
      const coins = getCurrentUser()?.coins ?? 0;

      const rows = inv.map((item, idx) => {
        const heartClass = item.favorite ? 'heart-btn fav' : 'heart-btn';
        const heartChar = item.favorite ? '‚ô•' : '‚ô°';
        const meta = friendlyMeta(item);
        return `
          <div class="bp-row" data-idx="${idx}">
            <div class="bp-name">${renderStyledFishName(item)}</div>
            <div class="bp-meta">${meta}</div>
            <div class="heart">
              <button class="${heartClass}" title="Favorite (left-click) / Toggle (right-click)" data-idx="${idx}">${heartChar}</button>
            </div>
          </div>
        `;
      }).join('');

      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="bp-wrap">
          <h2>üéí Backpack</h2>
          <div class="scroll-panel">
            ${rows || '<p>No items yet.</p>'}
          </div>
          <div class="bp-hint">Tip: Left-click the heart to favorite. Or right-click an item row to toggle favorite. Gear can‚Äôt be sold.</div>
        </div>
      `;
      updateGoldHud();

      document.querySelectorAll('.heart-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          toggleFavorite(idx);
        });
      });
      document.querySelectorAll('.bp-row').forEach(row => {
        row.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          const idx = Number(row.getAttribute('data-idx'));
          toggleFavorite(idx);
        });
      });
    }
    function toggleFavorite(index) {
      const inv = getInventory();
      if (!inv[index]) return;
      inv[index].favorite = !inv[index].favorite;
      setInventory(inv);
      renderBackpack();
    }

    // Shop
    document.getElementById('shopBtn').addEventListener('click', renderShopMenu);
    function isSellable(item) { return (item && !item.favorite && (item.type === 'fish' || item.type === 'trash')); }
    function sellValue(item) { return typeof item.value === 'number' ? item.value : 0; }
    function renderShopMenu() {
      const coins = getCurrentUser()?.coins ?? 0;
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="shop-wrap">
          <h2>üõí Shop</h2>
          <p>What would you like to do?</p>
          <button class="location-btn" id="buyBtn">üß∫ Buy</button>
          <button class="location-btn" id="sellBtn">üí∞ Sell</button>
        </div>
      `;
      updateGoldHud();
      document.getElementById('buyBtn').addEventListener('click', showBuy);
      document.getElementById('sellBtn').addEventListener('click', showSell);
    }

    function canAfford(cost){ return (getCurrentUser()?.coins ?? 0) >= cost; }
    function spendGold(amount){
      const cu = getCurrentUser(); if (!cu) return false;
      if ((cu.coins ?? 0) < amount) return false;
      cu.coins -= amount; setCurrentUser(cu);
      const players = getPlayers();
      const idx = players.findIndex(p => p.username === cu.username);
      if (idx !== -1) { players[idx].coins = cu.coins; savePlayers(players); }
      updateGoldHud(); return true;
    }

    const PRICE_RULES = { rodBase1: 50, rodBase2: 100, baitBase1: 25, baitBase2: 50 };
    function seqPrice(base1, base2, n) {
      if (n <= 1) return base1;
      if (n === 2) return base2;
      let a = base1, b = base2;
      for (let i = 3; i <= n; i++) { const c = a + b; a = b; b = c; }
      return b;
    }
    function nextRodCost() {
      const { rodLevel } = getStats();
      return seqPrice(PRICE_RULES.rodBase1, PRICE_RULES.rodBase2, Math.max(rodLevel, 1));
    }
    function nextBaitCost() {
      const { baitTier } = getStats();
      return seqPrice(PRICE_RULES.baitBase1, PRICE_RULES.baitBase2, Math.max(baitTier + 1, 1));
    }

    const SHOP_ITEMS = [
      { id:'rod',  name:'Sturdy Rod (+1 zone / -wobble)',   getCost: () => nextRodCost(),  apply:(s)=>({ ...s, rodLevel: (s.rodLevel??1)+1 }) },
      { id:'bait', name:'Basic Bait (+1 bite speed)',       getCost: () => nextBaitCost(), apply:(s)=>({ ...s, baitTier: (s.baitTier??0)+1 }) },
    ];

    function showBuy() {
      const coins = getCurrentUser()?.coins ?? 0;

      const body = SHOP_ITEMS.map(it => {
        const cost = it.getCost();
        const disabled = coins < cost ? 'disabled' : '';
        return `
          <div class="sell-row">
            <div><strong>${it.name}</strong></div>
            <div>${cost}g</div>
            <button data-id="${it.id}" class="buy-btn" ${disabled}>Buy</button>
          </div>
        `;
      }).join('');

      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="shop-wrap">
          <h2>üõí Shop ¬∑ Buy</h2>
          <div class="row" style="margin-bottom:10px;">
            <button id="backToShop">‚Üê Back</button>
          </div>
          <div class="sell-list scroll-panel">${body}</div>
          <p class="small" style="opacity:.8;margin-top:8px;">
            Prices grow by adding the previous two costs (e.g., Rod: 50 ‚Üí 100 ‚Üí 150 ‚Üí 250‚Ä¶). Upgrades stack and auto-equip (replacing old gear).
          </p>
        </div>
      `;
      updateGoldHud();
      document.getElementById('backToShop').onclick = renderShopMenu;

      document.querySelectorAll('.buy-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const item = SHOP_ITEMS.find(x => x.id === id);
          if (!item) return;

          const cost = item.getCost();
          if (!canAfford(cost)) { alert("Not enough gold!"); return; }
          if (!spendGold(cost)) { alert("Purchase failed."); return; }

          const s = getStats();
          const after = item.apply(s);
          setStats(after);
          if (id === 'rod')  equipRod(after.rodLevel);
          if (id === 'bait') equipBait(after.baitTier);

          goldPopup(`Purchased: ${item.name}`);
          showBuy();
        });
      });
    }

    function showSell() {
      const coins = getCurrentUser()?.coins ?? 0;
      const inv = getInventory();
      const sellable = inv.map((it, idx) => ({...it, _idx: idx})).filter(it => isSellable(it));
      const list = sellable.map(it => `
        <div class="sell-row">
          <div><strong>${renderStyledFishName(it)}</strong> <span style="opacity:.85">¬∑ ${it.type}</span></div>
          <div>${sellValue(it)}g</div>
          <button data-idx="${it._idx}" class="sell-one-btn">Sell</button>
        </div>
      `).join('');
      const totalGold = sellable.reduce((a,c)=>a+sellValue(c),0);

      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="shop-wrap">
          <h2>üõí Shop ¬∑ Sell</h2>
          <div class="row" style="margin-bottom:10px;">
            <button id="backToShop">‚Üê Back</button>
            <button id="sellAllBtnTop" ${sellable.length ? '' : 'disabled'}>Sell All</button>
          </div>
          ${sellable.length ? `<div class="sell-list scroll-panel">${list}</div>` : `<p>No sellable items. Favorited fish are protected, and gear can‚Äôt be sold.</p>`}
          <div class="sell-summary">
            <p>Total (non-favorited, sellable): <strong>${totalGold}g</strong></p>
            <div class="row">
              <button id="sellAllBtn" ${sellable.length ? '' : 'disabled'}>Sell All</button>
            </div>
          </div>
        </div>
      `;
      updateGoldHud();

      document.getElementById('backToShop').onclick = renderShopMenu;

      const sellAllHandler = () => sellAll();
      const sellAllTop = document.getElementById('sellAllBtnTop');
      const sellAllBottom = document.getElementById('sellAllBtn');
      if (sellAllTop) sellAllTop.onclick = sellAllHandler;
      if (sellAllBottom) sellAllBottom.onclick = sellAllHandler;

      document.querySelectorAll('.sell-one-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          sellSingle(idx);
        });
      });
    }

    function sellSingle(indexInInventory) {
      const inv = getInventory();
      const item = inv[indexInInventory];
      if (!item) return;
      if (!isSellable(item)) { alert("That item can't be sold."); return; }
      const value = sellValue(item);
      inv.splice(indexInInventory, 1);
      setInventory(inv);
      addGold(value);
      showSell();
    }

    function sellAll() {
      const inv = getInventory();
      let earned = 0;
      const remaining = [];
      for (const it of inv) {
        if (isSellable(it)) earned += sellValue(it);
        else remaining.push(it);
      }
      if (earned === 0) { alert("Nothing to sell."); return; }
      setInventory(remaining);
      addGold(earned);
      showSell();
    }

    // Fishing Spot convenience re-render
    document.getElementById('fishingSpotBtn').addEventListener('click', () => {
      const s = getStats();
      const unlocked = s.level >= 10;

      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${(getCurrentUser()?.coins ?? 0)} ¬∑ ‚≠ê Lv ${s.level} (${s.xp}/${xpNeededFor(s.level)})</div>
        <div class="pond-wrap">
          <h2>üé£ Fishing Spot</h2>
          <p>Select your location:</p>
          <button class="location-btn" id="pondBtn">üêü Pond</button>
          <button class="location-btn ${unlocked ? '' : 'locked'}" id="streamBtn" ${unlocked ? '' : 'disabled'}>üåä Stream</button>
          ${unlocked ? '' : '<div class="lock-note">Reach <b>Level 10</b> to access the Stream.</div>'}
        </div>
      `;
      updateGoldHud();
      document.getElementById('pondBtn').addEventListener('click', showPond);

      const streamBtn = document.getElementById('streamBtn');
      if (streamBtn) {
        if (unlocked) {
          streamBtn.addEventListener('click', showStream);
        } else {
          streamBtn.addEventListener('click', () => alert('Locked: Reach Level 10 to access the Stream.'));
        }
      }
    });

    // Save catch (supports variants/elementals) ‚Äî normalized
    function saveCatchToUser(catchData) {
      const inv = getInventory();
      if (typeof catchData === 'string') {
        const meta = lookupItemMeta(catchData);
        inv.push({
          name: meta.name, type: meta.type, value: meta.value ?? 0, favorite: false,
          variantBaseKey: 'none', variantBaseLabel: '', statusLabel: ''
        });
      } else {
        const key = normalizeVariantKey(catchData.variantBaseKey);
        inv.push({
          name: catchData.name,
          type: catchData.type,
          value: catchData.value,
          favorite: false,
          variantBaseKey: key,
          variantBaseLabel: prettyLabelFromKey(key),
          statusLabel: catchData.statusLabel || ''
        });
      }
      setInventory(inv);
    }

    // Admin reset bind (after elements exist)
    document.getElementById('adminResetBtn').addEventListener('click', adminResetAllData);
  </script>
</body>
</html>
