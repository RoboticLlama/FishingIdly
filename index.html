<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fishing Idly</title>
  <style>
    /* ===== your styles unchanged, plus size-tier styles ===== */
    body { background-color: #1b2735; color: #e0e0e0; font-family: 'Courier New', monospace;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      height: 100vh; margin: 0; position: relative; overflow: hidden; }
    h1 { font-size: 3rem; margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 3px; }
    button { background-color: #3a506b; color: #fff; border: none; padding: 1rem 2rem;
      font-size: 1.1rem; border-radius: 10px; cursor: pointer; transition: background-color .2s; }
    button:hover { background-color: #5bc0be; color:#1b2735; }
    .signin-top { position: absolute; top: 20px; right: 30px; background: #3a506b; color:#e0e0e0; padding:.5rem 1rem; border-radius:8px; text-decoration:none; }
    .signin-top:hover { background:#5bc0be; color:#1b2735; }
    .overlay { position: fixed; inset:0; background: rgba(0,0,0,.65); display:none; justify-content:center; align-items:center; z-index: 20; }
    .signin-box { background: linear-gradient(135deg, #2a3d56, #3a506b); padding: 2rem; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,.4);
      width: 300px; text-align:center; transform: scale(.8); opacity: 0; animation: pop .3s forwards; }
    .signin-box input { width: 90%; padding: .7rem; margin: .5rem 0; border: none; border-radius: 8px;
      outline: none; background:#1b2735; color:#e0e0e0; }
    .toggle-link { display:block; margin-top:1rem; color:#9ad4d6; cursor:pointer; text-decoration:underline; font-size:.9rem; }
    @keyframes pop { to { transform: scale(1); opacity: 1; } }
    .game-container { display: none; width: 100%; height: 100vh; flex-direction: row; }
    .sidebar { width: 220px; background:#2a3d56; display:flex; flex-direction:column; justify-content:space-between; align-items:center;
      padding: 16px 10px; border-right: 2px solid #5bc0be; }
    .nav-buttons { display:flex; flex-direction:column; align-items:center; width:100%; }
    .nav-buttons button { width:88%; margin:8px 0; background:#3a506b; }
    .nav-buttons button:hover { background:#5bc0be; color:#1b2735; }
    .logout-btn { background:#b0413e; color:#fff; width:88%; margin-top:8px; white-space:nowrap; }
    .logout-btn:hover { background:#e24e4b; }
    .main-content { flex:1; display:flex; justify-content:center; align-items:center; text-align:center; padding: 30px; position: relative; }
    .admin-reset-btn { background:#7a1f1b; color:#fff; width:88%; margin-top:8px; }
    .admin-reset-btn:hover { background:#a52b25; color:#fff; }
    .hud { position: absolute; top: 12px; right: 16px; background: rgba(0,0,0,.35);
      padding: 8px 12px; border-radius: 10px; font-size: .95rem; box-shadow: 0 0 0 1px rgba(255,255,255,.08) inset; }
    .location-btn { margin: 10px; padding: 1rem 2rem; border-radius: 10px; background:#3a506b; color:#fff; font-size:1.05rem; }
    .location-btn:hover { background:#5bc0be; color:#1b2735; }
    .location-btn.locked { background: #2b394d; color: #9aa7b7; cursor: not-allowed; box-shadow: inset 0 0 0 1px rgba(255,255,255,.05); }
    .lock-note { font-size: .9rem; opacity: .85; margin-top: 6px; }
    .pond-wrap { max-width: 640px; width: 100%; margin: 0 auto; position: relative; }
    .status { margin: 10px 0 16px; opacity: .9; min-height: 1.2em; }
    .pond-header { position: relative; display:flex; justify-content:center; align-items:center; }
    .back-inline { position:absolute; right:0; top:0; padding:.6rem 1rem; border-radius:10px; }
    .back-left { left: 0; right: auto; }
    .progress { position: relative; height: 10px; width: 100%; max-width: 560px; background:#0f1824; border-radius: 8px; overflow: hidden; margin: 10px auto 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }
    .progress-fill { height: 100%; width: 0%; transition: width .06s linear; background: linear-gradient(90deg, #2e86ab, #6fffe9); }
    .meter { position: relative; height: 20px; width: 100%; max-width: 560px; background:#0f1824; border-radius: 12px;
      overflow: hidden; margin: 8px auto 12px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }
    .meter-zone { position: absolute; top:0; bottom:0; border-left: 2px solid rgba(91,192,190,.9); border-right: 2px solid rgba(91,192,190,.9); background: rgba(91,192,190,.18); }
    .meter-fill { position: absolute; top:0; bottom:0; left:0; width: 20%; box-shadow: 0 0 10px rgba(111,255,233,.35); background: linear-gradient(90deg, #58a, #6fffe9); transition: left .03s linear, width .03s linear; }
    .row { display:flex; gap: 10px; justify-content:center; align-items:center; margin-top: 12px; flex-wrap: wrap; }
    .row button { min-width: 120px; }
    .small { font-size: .9rem; opacity: .8; }
    .success { color:#6fffe9; } .fail { color:#ff7a7a; }
    .bp-wrap, .shop-wrap, .board-wrap { width: 880px; max-width: 96vw; margin: 0 auto; display: flex; flex-direction: column; align-items: center; text-align: center; }
    .bp-row { display: grid; grid-template-columns: 1fr auto 120px; gap: 12px; align-items: center; padding: 10px 12px; margin: 6px 0;
      background: rgba(0,0,0,.25); border-radius: 10px; box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; width: 100%; }
    .bp-name { font-weight: 600; text-align: left; } .bp-meta { opacity: .85; text-align: right; }
    .heart { width: 36px; height: 36px; border-radius: 8px; background: rgba(0,0,0,.2); display:flex; align-items:center; justify-content:center; user-select:none; }
    .heart-btn { padding: 0 !important; background: transparent !important; border: none; box-shadow: none; width: 28px; height: 28px; display:flex; align-items:center; justify-content:center;
      font-size: 18px; line-height: 1; color: #9ad4d6; cursor: pointer; border-radius: 6px; }
    .heart-btn:hover { background: rgba(255,255,255,0.08) !important; } .heart-btn.fav { color: #ff7aa2; }
    .heart-btn:focus-visible { outline: 2px solid #5bc0be; outline-offset: 2px; }
    .bp-hint { margin-top: 8px; font-size: .9rem; opacity: .8; }
    .gold-pop { position: absolute; right: 24px; top: 36px; font-weight: bold; animation: floatUp 1s ease forwards; }
    .xp-pop { position: absolute; right: 24px; top: 64px; font-weight: bold; animation: floatUp 1s ease forwards; color: #9ad4d6; }
    @keyframes floatUp { 0%{opacity:0; transform: translateY(10px);} 15%{opacity:1;} 85%{opacity:1;} 100%{opacity:0; transform: translateY(-12px);} }
    .sell-list .sell-row { display:grid; grid-template-columns: 1fr auto auto; gap:12px; align-items:center; padding:10px 12px; margin:6px 0; background: rgba(0,0,0,.25); border-radius:10px;
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; width: 100%; }
    .sell-summary { margin-top: 10px; opacity:.9; }
    .variant-bronze{ color:#b87333; font-weight:600; }
    .variant-silver{ color:#c0c0c0; font-weight:600; }
    .variant-gold{ color:#ffd700; font-weight:700; text-shadow:0 0 6px rgba(255,215,0,.25); }
    .variant-diamond{ color:#7dd3fc; font-weight:700; text-shadow:0 0 6px rgba(125,211,252,.25); }
    .variant-rainbow{ font-weight:800; background: linear-gradient(90deg,#ff6,#f9f,#6ff,#9f6,#f96); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 0 10px rgba(255,255,255,.15); }
    .status-frozen{ background: rgba(120,180,255,.35); color:inherit; padding:0 .25em; border-radius:6px; }
    .status-electrocuted{ background: rgba(250,230,90,.35); color:inherit; padding:0 .25em; border-radius:6px; }
    .status-burned{ background: rgba(255,120,90,.35); color:inherit; padding:0 .25em; border-radius:6px; }
    .board-table { width:100%; border-collapse: collapse; table-layout:fixed; }
    .board-table th, .board-table td { padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08); text-align:center; }
    .me-row { background: rgba(155,201,255,.08); }
    .scroll-panel { max-height: 75vh; overflow-y: auto; overflow-x: hidden; padding-right: 10px; width:100%; box-sizing: border-box; }
    .scroll-panel::-webkit-scrollbar { width: 8px; }
    .scroll-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 6px; }
    .scroll-panel::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
    .col-xp { display:none; } thead .col-xp { display:none; }
    .admin-panel{ width:88%; background: rgba(0,0,0,.18); border-radius:10px; box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; padding:10px; margin-top:8px; font-size:.9rem; }
    .admin-row{ display:flex; justify-content:space-between; align-items:center; margin:6px 0; gap:8px; }
    .admin-row .btn-sm{ padding:.4rem .7rem; border-radius:8px; min-width:auto; }
    .admin-title{ font-weight:700; opacity:.9; margin-bottom:4px; }
    .showcase-mode .bp-row { grid-template-columns: 1fr auto 120px; }
    .showcase-mode .sc-action { display:flex; justify-content:flex-end; }
    .showcase-mode .sc-btn{ padding:.48rem 1rem; border-radius:10px; background:#3a506b; color:#fff; border:none; font-weight:600; cursor:pointer; }
    .showcase-mode .sc-btn:hover{ background:#5bc0be; color:#1b2735; }
    .showcase-mode .heart { background: transparent; width:auto; height:auto; box-shadow:none; }
    .showcase-mode .heart-btn { display:none; }
    .displayed-list { width:100%; }
    .displayed-row{ display:grid; grid-template-columns: 1fr 120px; gap:12px; align-items:center; padding:10px 12px; margin:6px 0; background: rgba(0,0,0,.25);
      border-radius:10px; box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; }
    .remove-btn{ padding:.48rem 1rem; border-radius:10px; background:#5b6d86; color:#fff; border:none; font-weight:600; cursor:pointer; }
    .remove-btn:hover{ background:#8ea8c6; color:#1b2735; }
    .profile-box{ width: 560px; max-width: 95vw; text-align: left; }
    .profile-list{ width:100%; max-height: 60vh; overflow-y:auto; padding-right:6px; }
    .profile-row{ display:grid; grid-template-columns: 1fr; gap:12px; align-items:center; padding:10px 12px; margin:6px 0; background: rgba(0,0,0,.25); border-radius:10px; box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; }
    .board-table a.lb-player { color:#e0e0e0; text-decoration: underline; }
    .board-table a.lb-player:hover, .board-table a.lb-player:focus { color:#5bc0be; outline:none; }
    /* size tiers */
    .size-wrap { display:inline-flex; align-items:center; gap:6px; }
    .size-tag { display:inline-block; line-height:1; }
    .size-micro  .size-tag::before { content:"ü§π"; }
    .size-queen  .size-tag::before { content:"‚ôõ"; color:#c0c0c0; }
    .size-king   .size-tag::before { content:"üëë"; }
    .size-micro  .fish-name { font-size:0.90em; }
    .size-small  .fish-name { font-size:0.95em; }
    .size-normal .fish-name { font-size:1.00em; }
    .size-big    .fish-name { font-size:1.05em; }
    .size-queen  .fish-name { font-size:1.08em; }
    .size-king   .fish-name { font-size:1.12em; }
  </style>
</head>
<body>
  <a href="#" class="signin-top" id="signinLink">Sign In</a>

  <h1 id="title">Fishing Idly</h1>
  <button id="startButton">Start</button>

  <!-- Sign In / Up -->
  <div class="overlay" id="overlay">
    <div class="signin-box">
      <div id="signinForm">
        <h2>Sign In</h2>
        <!-- NOTE: this field is now Email for Firebase Auth -->
        <input type="email" id="signin-email" placeholder="Email"/>
        <input type="password" id="signin-password" placeholder="Password"/>
        <button id="loginButton">Log In</button>
        <span class="toggle-link" id="showSignup">Don‚Äôt have an account? Sign Up</span>
      </div>
      <div id="signupForm" style="display:none;">
        <h2>Create Account</h2>
        <input type="email" id="signup-email" placeholder="Email"/>
        <input type="text" id="signup-username" placeholder="Username"/>
        <input type="password" id="signup-password" placeholder="Password"/>
        <button id="signupButton">Sign Up</button>
        <span class="toggle-link" id="showSignin">Already have an account? Sign In</span>
      </div>
    </div>
  </div>

  <!-- üîì Area Unlock Modal -->
  <div class="overlay" id="unlockOverlay" style="display:none;">
    <div class="signin-box" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
      <h2 id="unlockTitle">New Area Unlocked!</h2>
      <p>You can now access: <b>üåä Stream</b></p>
      <button id="unlockOkBtn">Let‚Äôs go</button>
    </div>
  </div>

  <!-- üë§ Player Profile Modal -->
  <div class="overlay" id="profileOverlay" style="display:none;">
    <div class="signin-box profile-box" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
      <h2 id="profileTitle">Player</h2>
      <div id="profileBody"></div>
      <div class="row" style="margin-top:12px;">
        <button id="profileCloseBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Game UI -->
  <div class="game-container" id="gameContainer">
    <div class="sidebar">
      <div class="nav-buttons">
        <button id="homeBtn">üè† Home</button>
        <button id="fishingSpotBtn">üé£ Fishing Spot</button>
        <button id="backpackBtn">üéí Backpack</button>
        <button id="shopBtn">üõí Shop</button>
        <button id="leaderboardBtn">üèÜ Leaderboard</button>
      </div>

      <div id="adminPanel" style="display:none;"></div>

      <button class="admin-reset-btn" id="adminResetBtn" style="display:none;">‚ö† Reset All Data</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <div class="main-content" id="mainContent">
      <div class="hud" id="goldHud">üí∞ 0 ¬∑ ‚≠ê Lv 1 (0/20)</div>
      Welcome back, fisherman! Choose an option from the left to begin.
    </div>
  </div>

  <!-- ===================== GAME LOGIC + FIREBASE ===================== -->
  <script type="module">
    /* ---------------- Firebase Setup (CDN ESM imports) ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot,
      collection, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Your Firebase config (safe to expose in client; lock with Rules) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBpY-Lqr8jg81saEXZ-JV1JWjdrS66ZIKg",
      authDomain: "fishingidly.firebaseapp.com",
      projectId: "fishingidly",
      storageBucket: "fishingidly.firebasestorage.app",
      messagingSenderId: "321327929567",
      appId: "1:321327929567:web:5cd5a0184167fdaeb4716a",
      measurementId: "G-G2R1SNZE4N"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch (_) {} // analytics optional
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* --------------------- Utility / Defaults --------------------- */
    const overlay = document.getElementById('overlay');
    const signinLink = document.getElementById('signinLink');
    const startButton = document.getElementById('startButton');
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    const showSignup = document.getElementById('showSignup');
    const showSignin = document.getElementById('showSignin');
    const gameContainer = document.getElementById('gameContainer');
    const mainContent = document.getElementById('mainContent');
    const title = document.getElementById('title');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminResetBtn = document.getElementById('adminResetBtn');
    const adminPanel = document.getElementById('adminPanel');
    const unlockOverlay = document.getElementById('unlockOverlay');

    const openModal = () => overlay.style.display = 'flex';
    signinLink.addEventListener('click', (e) => { e.preventDefault(); openModal(); });
    startButton.addEventListener('click', (e) => { e.preventDefault?.(); openModal(); });
    showSignup.addEventListener('click', () => { signinForm.style.display='none'; signupForm.style.display='block'; });
    showSignin.addEventListener('click', () => { signupForm.style.display='none'; signinForm.style.display='block'; });
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.style.display = 'none'; });

    // Simple helpers
    function defaultStats() { return { rodLevel: 1, baitTier: 0, level: 1, xp: 0 }; }
    function xpNeededFor(level) { return 20 + (level - 1) * 10; }
    function goldHudEl() { return document.getElementById('goldHud'); }
    function goldPopup(text) { const el = document.createElement('div'); el.className = 'gold-pop'; el.textContent = text; mainContent.appendChild(el); setTimeout(()=> el.remove(), 1000); }
    function xpPopup(text)   { const el = document.createElement('div'); el.className = 'xp-pop';  el.textContent = text; mainContent.appendChild(el); setTimeout(()=> el.remove(), 1100); }
    function isMasterUser()  { return auth.currentUser && auth.currentUser.email?.toLowerCase() === "llama@test.local"; }
    function showUnlockModal() { unlockOverlay.style.display = 'flex'; document.getElementById('unlockOkBtn').onclick = ()=> unlockOverlay.style.display='none'; }

    /* ===================== FIRESTORE DATA MODEL =====================
       Collection: users
       Doc ID: auth.uid
       Fields:
         username: string
         email: string
         coins: number
         items: array<object>
         flags: object
         rodLevel, baitTier, level, xp: numbers (top-level for easy sorting)
    ==================================================================*/

    // in-memory cache of current doc
    let currentUserDoc = null;         // full data from Firestore
    let currentUserUnsub = null;       // live listener

    async function ensureUserDoc(uid, data) {
      const dref = doc(db, "users", uid);
      const snap = await getDoc(dref);
      if (!snap.exists()) {
        const base = {
          username: data.username || (auth.currentUser?.displayName || "Player"),
          email: auth.currentUser?.email || data.email || "",
          coins: 0,
          items: [],
          flags: {},
          ...defaultStats()
        };
        await setDoc(dref, base);
        return base;
      }
      return snap.data();
    }

    function startUserListener(uid) {
      if (currentUserUnsub) currentUserUnsub(); // cleanup previous
      const dref = doc(db, "users", uid);
      currentUserUnsub = onSnapshot(dref, (snap) => {
        if (snap.exists()) {
          currentUserDoc = { id: uid, ...snap.data() };
          updateGoldHud();
          renderAdminPanel();
        }
      });
    }

    function getStats() {
      if (!currentUserDoc) return defaultStats();
      return {
        rodLevel: currentUserDoc.rodLevel ?? 1,
        baitTier: currentUserDoc.baitTier ?? 0,
        level:    currentUserDoc.level ?? 1,
        xp:       currentUserDoc.xp ?? 0
      };
    }

    async function setStats(next) {
      if (!auth.currentUser) return;
      const prev = getStats();
      const safe = {
        rodLevel: Math.max(1, next.rodLevel ?? prev.rodLevel ?? 1),
        baitTier: Math.max(0, next.baitTier ?? prev.baitTier ?? 0),
        level:    Math.max(1, next.level ?? prev.level ?? 1),
        xp:       Math.max(0, next.xp ?? prev.xp ?? 0)
      };
      await updateDoc(doc(db, "users", auth.currentUser.uid), safe);
      // Unlock notice
      if ((prev.level < 10) && (safe.level >= 10) && !(currentUserDoc?.flags?.streamUnlockNotified)) {
        await updateDoc(doc(db, "users", auth.currentUser.uid), { "flags.streamUnlockNotified": true });
        showUnlockModal();
      }
    }

    function updateGoldHud() {
      const s = getStats();
      const coins = currentUserDoc?.coins ?? 0;
      const el = goldHudEl();
      if (el) el.textContent = `üí∞ ${coins} ¬∑ ‚≠ê Lv ${s.level} (${s.xp}/${xpNeededFor(s.level)})`;
    }

    async function addGold(amount) {
      if (!auth.currentUser) return;
      const coins = Math.max(0, (currentUserDoc?.coins ?? 0) + amount);
      await updateDoc(doc(db, "users", auth.currentUser.uid), { coins });
      goldPopup(`+${amount} gold`);
    }
    async function setGold(newAmount) {
      if (!auth.currentUser) return;
      await updateDoc(doc(db, "users", auth.currentUser.uid), { coins: Math.max(0, Math.floor(newAmount||0)) });
    }

    function getInventory() { return Array.isArray(currentUserDoc?.items) ? currentUserDoc.items : []; }
    async function setInventory(newInv) {
      if (!auth.currentUser) return;
      await updateDoc(doc(db, "users", auth.currentUser.uid), { items: newInv });
    }

    async function addXP(amount) {
      const before = getStats();
      let xp = (before.xp ?? 0) + amount;
      let level = before.level ?? 1;
      let ups = 0;
      while (xp >= xpNeededFor(level)) { xp -= xpNeededFor(level); level += 1; ups += 1; }
      await setStats({ ...before, xp, level });
      xpPopup(`+${amount} XP`);
      if (ups > 0) goldPopup(`‚≠ê Level Up! Lv ${before.level} ‚Üí ${level}`);
    }

    function isStreamUnlocked(){ return (getStats().level || 1) >= 10; }

    /* --------------------- Sign Up / Sign In / Out --------------------- */
    document.getElementById('signupButton').addEventListener('click', async () => {
      const email = document.getElementById('signup-email').value.trim();
      const username = document.getElementById('signup-username').value.trim();
      const password = document.getElementById('signup-password').value.trim();
      if (!email || !username || !password) { alert("Please fill all fields."); return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        if (username) { try { await updateProfile(cred.user, { displayName: username }); } catch(_){} }
        await ensureUserDoc(cred.user.uid, { username, email });
        startUserListener(cred.user.uid);
        launchGame(username || cred.user.email || "Player");
        overlay.style.display = 'none';
      } catch (e) {
        alert("Sign up failed: " + (e.message || e));
      }
    });

    document.getElementById('loginButton').addEventListener('click', async () => {
      const email = document.getElementById('signin-email').value.trim();
      const password = document.getElementById('signin-password').value.trim();
      if (!email || !password) { alert("Please enter email and password."); return; }
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        await ensureUserDoc(cred.user.uid, {});
        startUserListener(cred.user.uid);
        launchGame(cred.user.displayName || cred.user.email || "Player");
        overlay.style.display = 'none';
      } catch (e) {
        alert("Login failed: " + (e.message || e));
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try { if (currentUserUnsub) currentUserUnsub(); currentUserUnsub = null; currentUserDoc = null; await signOut(auth); } catch(_){}
      location.reload();
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        await ensureUserDoc(user.uid, {});
        startUserListener(user.uid);
        launchGame(user.displayName || user.email || "Player");
      }
    });

    /* --------------------- Game: shared helpers from your code --------------------- */
    function renderAdminPanel() {
      if (!isMasterUser()) {
        adminPanel.style.display = 'none';
        adminResetBtn.style.display = 'none';
        return;
      }
      const s = getStats();
      const coins = currentUserDoc?.coins ?? 0;
      adminPanel.style.display = 'block';
      adminResetBtn.style.display = 'block';
      adminPanel.className = 'admin-panel';
      adminPanel.innerHTML = `
        <div class="admin-title">üß∞ Admin (Master)</div>
        <div class="admin-row">
          <span>Level: <strong>${s.level}</strong></span>
          <div>
            <button class="btn-sm" id="lvlMinus">‚àí1</button>
            <button class="btn-sm" id="lvlPlus">+1</button>
          </div>
        </div>
        <div class="admin-row">
          <span>Gold: <strong>${coins}g</strong></span>
          <div>
            <button class="btn-sm" id="goldMinus">‚àí100</button>
            <button class="btn-sm" id="goldPlus">+100</button>
          </div>
        </div>
      `;
      document.getElementById('lvlPlus').onclick  = () => setStats({ ...getStats(), level: getStats().level + 1 });
      document.getElementById('lvlMinus').onclick = () => setStats({ ...getStats(), level: Math.max(1, getStats().level - 1) });
      document.getElementById('goldPlus').onclick = () => addGold(100);
      document.getElementById('goldMinus').onclick= () => setGold((currentUserDoc?.coins ?? 0) - 100);
      adminResetBtn.onclick = async () => {
        if (!isMasterUser()) return;
        const a = confirm("‚ö† Delete ALL your saved data on Firestore?"); if (!a) return;
        await setDoc(doc(db,"users",auth.currentUser.uid), { username: auth.currentUser.displayName || "Player", email: auth.currentUser.email||"", coins:0, items:[], flags:{}, ...defaultStats() });
        alert("Your user data has been reset.");
      };
    }

    function launchGame(username) {
      document.getElementById('title').style.display = 'none';
      startButton.style.display = 'none';
      signinLink.style.display = 'none';
      gameContainer.style.display = 'flex';
      mainContent.innerHTML = `<div class="hud" id="goldHud">üí∞ ${(currentUserDoc?.coins ?? 0)} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>Welcome back, ${username}! Choose where to go.`;
      updateGoldHud();
      renderAdminPanel();
    }

    /* --------------------- Size/Variants (unchanged) --------------------- */
    const VALID_VARIANTS = new Set(['none','bronze','silver','gold','diamond','rainbow']);
    function normalizeVariantKey(v){ if (!v) return 'none'; const s = String(v).toLowerCase().trim(); if (s==='copper') return 'bronze'; return VALID_VARIANTS.has(s)?s:'none'; }
    function prettyLabelFromKey(k){ switch (normalizeVariantKey(k)) { case 'bronze': return 'Bronze'; case 'silver': return 'Silver'; case 'gold': return 'Gold'; case 'diamond': return 'Diamond'; case 'rainbow': return 'Rainbow'; default: return ''; } }
    const SIZE_TIERS = [
      { key:'micro',  label:'Micro',  chance:0.06,  mult:0.75 },
      { key:'small',  label:'Small',  chance:0.13,  mult:0.90 },
      { key:'big',    label:'Big',    chance:0.07,  mult:1.15 },
      { key:'queen',  label:'Queen',  chance:0.035, mult:1.35 },
      { key:'king',   label:'King',   chance:0.010, mult:1.60 },
    ];
    function rollSizeTier(){
      const pool = SIZE_TIERS;
      const r = Math.random(); let acc = 0;
      for (const s of pool) { acc += (s.chance||0); if (r < acc) return s; }
      return { key:'normal', label:'', mult:1.0 };
    }
    function renderStyledFishName(item) {
      const baseKey   = normalizeVariantKey(item.variantBaseKey || item.variantBase || item.variant || item.variantBaseLabel);
      const statusKey = (item.statusLabel ? item.statusLabel.toLowerCase() : '').replace(/\s+/g,'');
      const sizeKey   = (item.sizeKey || 'normal').toLowerCase();
      const validSizes = ['micro','small','normal','big','queen','king'];
      const sizeClass = `size-${validSizes.includes(sizeKey) ? sizeKey : 'normal'}`;
      const vClass = baseKey && baseKey !== 'none' ? `variant-${baseKey}` : '';
      const sClass = statusKey ? `status-${statusKey}` : '';
      const nameInner = vClass ? `<span class="${vClass} fish-name">${item.name}</span>` : `<span class="fish-name">${item.name}</span>`;
      return `
        <span class="size-wrap ${sizeClass}">
          ${sizeKey !== 'normal' ? `<span class="size-tag" title="${item.sizeLabel||''}"></span>` : ''}
          ${sClass ? `<span class="${sClass}">${nameInner}</span>` : nameInner}
        </span>
      `;
    }

    /* --------------------- Items & Tables (unchanged data) --------------------- */
    const pondTable = [
      { name: "Crappie",         type: "fish",  weight: 16, rarity: "common",   value: 4  },
      { name: "Pumpkinseed",     type: "fish",  weight: 12, rarity: "common",   value: 4  },
      { name: "Yellow Perch",    type: "fish",  weight: 12, rarity: "common",   value: 4  },
      { name: "Bluegill",        type: "fish",  weight: 9,  rarity: "uncommon", value: 6  },
      { name: "Catfish",         type: "fish",  weight: 7,  rarity: "uncommon", value: 8  },
      { name: "Carp",            type: "fish",  weight: 4,  rarity: "uncommon", value:10  },
      { name: "Goldfish",        type: "fish",  weight: 10, rarity: "rare",     value:15  },
      { name: "Largemouth Bass", type: "fish",  weight: 4,  rarity: "epic",     value:20  },
      { name: "Golden Koi",      type: "fish",  weight: 1,  rarity: "legendary",value:40  },
      { name: "Old Boot",        type: "trash", weight: 5,  value: 1 },
      { name: "Tin Can",         type: "trash", weight: 5,  value: 1 },
      { name: "Tangled Line",    type: "trash", weight: 5,  value: 1 },
      { name: "Broken Glass",    type: "trash", weight: 5,  value: 1 },
      { name: "Rusty Hook",      type: "trash", weight: 5,  value: 1 }
    ];
    const streamTable = [
      { name: "Creek Chub",        type: "fish",  weight: 10, rarity: "common",   value: 4 },
      { name: "Fallfish",          type: "fish",  weight: 10, rarity: "common",   value: 4 },
      { name: "White Sucker",      type: "fish",  weight: 8,  rarity: "common",   value: 5 },
      { name: "Common Shiner",     type: "fish",  weight: 6,  rarity: "common",   value: 4 },
      { name: "Redbreast Sunfish", type: "fish",  weight: 6,  rarity: "common",   value: 4 },
      { name: "Smallmouth Bass",   type: "fish",  weight: 7,  rarity: "uncommon", value: 10 },
      { name: "Rock Bass",         type: "fish",  weight: 5,  rarity: "uncommon", value: 7 },
      { name: "Rainbow Darter",    type: "fish",  weight: 4,  rarity: "uncommon", value: 8 },
      { name: "Brook Stickleback", type: "fish",  weight: 4,  rarity: "uncommon", value: 6 },
      { name: "Brook Trout",       type: "fish",  weight: 4,  rarity: "rare",     value: 16 },
      { name: "Brown Trout",       type: "fish",  weight: 3,  rarity: "rare",     value: 18 },
      { name: "Tiger Trout",       type: "fish",  weight: 3,  rarity: "rare",     value: 19 },
      { name: "Atlantic Salmon",   type: "fish",  weight: 4,  rarity: "epic",     value: 28 },
      { name: "Ancient River Sturgeon", type: "fish", weight: 1, rarity: "legendary", value: 45 },
      { name: "Waterlogged Branch", type: "trash", weight: 8, value: 1 },
      { name: "Torn Fishing Net",   type: "trash", weight: 8, value: 1 },
      { name: "Muddy Bottle",       type: "trash", weight: 9, value: 1 }
    ];
    function lookupItemMeta(name) {
      return pondTable.find(i => i.name === name) || streamTable.find(i => i.name === name) || { name, type:'unknown', value:0, rarity:'common' };
    }

    /* --------------------- Catch save (Firestore) --------------------- */
    async function saveCatchToUser(catchData) {
      if (!auth.currentUser) return;
      if (typeof catchData === 'string') {
        const meta = lookupItemMeta(catchData);
        if (meta && meta.type === 'trash') { await addGold(meta.value || 0); return; }
        const inv = getInventory();
        inv.push({ name: catchData, type: meta?.type || 'unknown', value: meta?.value || 0, favorite: false, variantBaseKey:'none', variantBaseLabel:'', statusLabel:'', showcased:false, sizeKey:'normal', sizeLabel:'' });
        await setInventory(inv);
        return;
      }
      const inv = getInventory();
      inv.push({
        name: catchData.name,
        type: catchData.type || 'fish',
        value: typeof catchData.value === 'number' ? catchData.value : (lookupItemMeta(catchData.name).value || 0),
        favorite: !!catchData.favorite,
        variantBaseKey: normalizeVariantKey(catchData.variantBaseKey || catchData.variant || catchData.variantBaseLabel),
        variantBaseLabel: catchData.variantBaseLabel || prettyLabelFromKey(catchData.variantBaseKey || catchData.variant || catchData.variantBaseLabel),
        statusLabel: catchData.statusLabel || '',
        showcased:false,
        sizeKey: (catchData.sizeKey || 'normal'),
        sizeLabel: (catchData.sizeLabel || '')
      });
      await setInventory(inv);
    }

    /* --------------------- UI Nav handlers (unchanged) --------------------- */
    document.getElementById('fishingSpotBtn').addEventListener('click', () => {
      const s = getStats();
      const unlocked = s.level >= 10;
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${(currentUserDoc?.coins ?? 0)} ¬∑ ‚≠ê Lv ${s.level} (${s.xp}/${xpNeededFor(s.level)})</div>
        <div class="pond-wrap">
          <h2>üé£ Fishing Spot</h2>
          <p>Select your location:</p>
          <button class="location-btn" id="pondBtn">üêü Pond</button>
          <button class="location-btn ${unlocked ? '' : 'locked'}" id="streamBtn" ${unlocked ? '' : 'disabled'}>üåä Stream</button>
          ${unlocked ? '' : '<div class="lock-note">Reach <b>Level 10</b> to access the Stream.</div>'}
        </div>
      `;
      updateGoldHud();
      const streamBtn = document.getElementById('streamBtn');
      if (streamBtn && !unlocked) streamBtn.addEventListener('click', () => alert('Locked: Reach Level 10 to access the Stream.'));
    });
    document.getElementById('homeBtn').addEventListener('click', renderHome);
    document.getElementById('backpackBtn').addEventListener('click', renderBackpack);
    document.getElementById('shopBtn').addEventListener('click', renderShopMenu);
    document.getElementById('leaderboardBtn').addEventListener('click', renderLeaderboard);
    mainContent.addEventListener('click', (e) => {
      const btn = e.target.closest && e.target.closest('button');
      if (!btn) return;
      if (btn.id === 'pondBtn')   { e.preventDefault(); showPond(); }
      if (btn.id === 'streamBtn') { e.preventDefault(); showStream(); }
    });

    function renderHome() {
      const coins = currentUserDoc?.coins ?? 0;
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="pond-wrap">
          <h2>üè† Home</h2>
          <p class="small">Your cozy base. Visit the Showcase or tend to your Nursery.</p>
          <div class="row" style="margin-top:12px;">
            <button id="showcaseBtn">üñº Showcase</button>
            <button id="nurseryBtn">üå± Nursery</button>
          </div>
        </div>
      `;
      updateGoldHud();
      document.getElementById('showcaseBtn').onclick = renderShowcase;
      document.getElementById('nurseryBtn').onclick = renderNursery;
    }

    function getShowcaseItems() {
      return getInventory().map((it, idx) => ({ ...it, _idx: idx })).filter(it => it.type === 'fish' && it.showcased === true);
    }
    async function setShowcaseForIndex(index, enabled) {
      const inv = getInventory();
      if (!inv[index] || inv[index].type !== 'fish') return;
      inv[index].showcased = !!enabled;
      await setInventory(inv);
    }

    async function renderShowcase() {
      const coins = currentUserDoc?.coins ?? 0;
      const inv = getInventory();
      const showcased = getShowcaseItems();
      const SHOWCASE_LIMIT = 10;
      const remainingSlots = Math.max(0, SHOWCASE_LIMIT - showcased.length);

      const manageList = inv.map((it, idx) => ({ ...it, _idx: idx }))
        .filter(it => it.type === 'fish' && it.showcased !== true)
        .map(it => {
          const btnId = `sc-btn-${it._idx}`;
          const meta = `${it.value || 0}g`;
          const addDisabled = remainingSlots === 0 ? 'disabled' : '';
          return `
            <div class="bp-row" data-idx="${it._idx}">
              <div class="bp-name">${renderStyledFishName(it)}</div>
              <div class="bp-meta">fish ¬∑ ${meta}</div>
              <div class="sc-action">
                <button id="${btnId}" class="sc-btn" ${addDisabled} title="Add to Showcase">Add</button>
              </div>
            </div>
          `;
        }).join('');

      const displayedRows = showcased.map(i => {
        const rid = `sc-rem-${i._idx}`;
        const meta = `${i.value || 0}g`;
        return `
          <div class="displayed-row">
            <div class="bp-name">${renderStyledFishName(i)} <span class="small">¬∑ ${meta}</span></div>
            <div style="display:flex;justify-content:flex-end;">
              <button id="${rid}" class="remove-btn" title="Remove from Showcase">Remove</button>
            </div>
          </div>
        `;
      }).join('');

      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="pond-wrap showcase-mode">
          <div class="pond-header">
            <h2>üñº Showcase</h2>
            <button id="backHome" class="back-inline">‚Üê Back</button>
          </div>
          <p class="small" style="margin-top:8px;">Selected: <b>${showcased.length}</b> / <b>${SHOWCASE_LIMIT}</b> ¬∑ Slots left: <b>${remainingSlots}</b></p>
          <div style="width:100%; text-align:left; margin-top:8px;">
            <h3 style="margin:8px 0 6px;">Currently Displayed</h3>
            <div class="displayed-list">
              ${displayedRows || `<p class="small" style="opacity:.85;">No fish displayed yet.</p>`}
            </div>
          </div>
          <div style="width:100%; text-align:left; margin-top:12px;">
            <h3 style="margin:8px 0 6px;">Manage Selection</h3>
            <div class="scroll-panel">
              ${manageList || `<p class="small" style="opacity:.85;">No fish available to add.</p>`}
            </div>
            <p class="small" style="opacity:.8; margin-top:8px;">You can favorite as many fish as you want in your Backpack ‚Äî favorites are separate from the Showcase.</p>
          </div>
        </div>
      `;
      updateGoldHud();

      document.getElementById('backHome').onclick = renderHome;
      inv.forEach((it, idx) => {
        if (it?.type !== 'fish' || it.showcased === true) return;
        const btn = document.getElementById(`sc-btn-${idx}`);
        if (btn) btn.onclick = async () => {
          if (getShowcaseItems().length >= SHOWCASE_LIMIT) { alert('Showcase is full. Remove one first.'); return; }
          await setShowcaseForIndex(idx, true);
          renderShowcase();
        };
      });
      showcased.forEach(it => {
        const rbtn = document.getElementById(`sc-rem-${it._idx}`);
        if (rbtn) rbtn.onclick = async () => { await setShowcaseForIndex(it._idx, false); renderShowcase(); };
      });
    }

    function renderNursery() {
      const coins = currentUserDoc?.coins ?? 0;
      const NURSERY_UNLOCK_COST = 2500;
      const hasNurseryAccess = !!(currentUserDoc?.flags?.nurseryAccess);
      if (!hasNurseryAccess) {
        const canBuy = coins >= NURSERY_UNLOCK_COST;
        mainContent.innerHTML = `
          <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
          <div class="pond-wrap">
            <div class="pond-header">
              <h2>üå± Nursery (Locked)</h2>
              <button id="backHome" class="back-inline">‚Üê Back</button>
            </div>
            <p class="small">Unlock the Nursery to raise fish eggs and grow helpful buffs.</p>
            <div class="status" style="margin-top:10px;">Cost to unlock: <b>${NURSERY_UNLOCK_COST}g</b></div>
            <div class="row" style="margin-top:12px;">
              <button id="unlockNurseryBtn" ${canBuy ? "" : "disabled"}>Unlock Nursery</button>
            </div>
            <div class="small" style="margin-top:6px; opacity:.85;">
              ${canBuy ? "You have enough gold to unlock the Nursery." : "You need more gold to unlock the Nursery."}
            </div>
          </div>
        `;
        updateGoldHud();
        document.getElementById('backHome').onclick = renderHome;
        const unlockBtn = document.getElementById('unlockNurseryBtn');
        if (unlockBtn) {
          unlockBtn.onclick = async () => {
            if ((currentUserDoc?.coins ?? 0) < NURSERY_UNLOCK_COST) { alert("Not enough gold."); return; }
            const ok = confirm(`Spend ${NURSERY_UNLOCK_COST} gold to unlock the Nursery?`); if (!ok) return;
            await setGold((currentUserDoc?.coins ?? 0) - NURSERY_UNLOCK_COST);
            await updateDoc(doc(db,"users",auth.currentUser.uid), { "flags.nurseryAccess": true });
            goldPopup("üå± Nursery unlocked!");
            renderNursery();
          };
        }
        return;
      }
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="pond-wrap">
          <div class="pond-header">
            <h2>üå± Nursery</h2>
            <button id="backHome" class="back-inline">‚Üê Back</button>
          </div>
          <p>Coming soon: incubate eggs, feed fry, and earn time-limited boosts.</p>
        </div>
      `;
      updateGoldHud();
      document.getElementById('backHome').onclick = renderHome;
    }

    /* --------------------- Leaderboard (Firestore) --------------------- */
    async function renderLeaderboard() {
      const coins = currentUserDoc?.coins ?? 0;
      // Pull all users and sort client-side
      const all = [];
      const snap = await getDocs(collection(db, "users"));
      snap.forEach(d => all.push({ id: d.id, ...d.data() }));
      all.sort((a,b)=>{
        if ((b.level||1)!==(a.level||1)) return (b.level||1)-(a.level||1);
        if ((b.xp||0)!==(a.xp||0))       return (b.xp||0)-(a.xp||0);
        if ((b.coins||0)!==(a.coins||0)) return (b.coins||0)-(a.coins||0);
        return (a.username||'').localeCompare(b.username||'');
      });

      const meId = auth.currentUser?.uid;
      const rows = all.map((p, i) => {
        const isMe = meId && p.id === meId;
        const cls = isMe ? ' class="me-row"' : '';
        const safeName = p.username || p.email || '‚Äî';
        return `
          <tr${cls}>
            <td>#${i+1}</td>
            <td><a href="#" class="lb-player" data-username="${safeName}">${safeName}</a></td>
            <td>Lv ${p.level ?? 1}</td>
            <td class="col-xp">${p.xp ?? 0}</td>
            <td>${p.coins ?? 0}g</td>
          </tr>
        `;
      }).join('');

      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="board-wrap">
          <h2>üèÜ Leaderboard</h2>
          <p class="small">Sorted by Level ‚Üí XP ‚Üí Coins.</p>
          <table class="board-table" aria-label="Leaderboard">
            <thead>
              <tr><th>Rank</th><th>Player</th><th>Level</th><th class="col-xp">XP</th><th>Coins</th></tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="5">No players yet.</td></tr>`}
            </tbody>
          </table>
        </div>
      `;
      updateGoldHud();

      document.querySelectorAll('.lb-player').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const u = e.currentTarget.getAttribute('data-username');
          if (u && u !== '‚Äî') showPlayerProfile(u, all);
        });
      });
    }

    function showPlayerProfile(username, allUsers){
      const p = (allUsers || []).find(q => (q.username||q.email) === username);
      if(!p){ alert("Player not found."); return; }
      const level = p.level ?? 1, xp = p.xp ?? 0;
      const showcased = (p.items || []).map((it, idx) => ({...it, _idx: idx})).filter(it => it && it.type === 'fish' && it.showcased === true);
      const listHTML = showcased.length
        ? showcased.map(i => `
            <div class="profile-row">
              <div class="bp-name">${renderStyledFishName(i)} <span class="small">¬∑ ${i.value || 0}g</span></div>
            </div>`).join('')
        : `<p class="small" style="opacity:.85;">No fish in Showcase.</p>`;

      const ov   = document.getElementById('profileOverlay');
      const body = document.getElementById('profileBody');
      const ttl  = document.getElementById('profileTitle');

      ttl.textContent = username;
      body.innerHTML = `
        <div class="small" style="opacity:.9;margin-bottom:8px;">
          ‚≠ê Level ${level} ¬∑ XP ${xp}/${xpNeededFor(level)}
        </div>
        <h3 style="margin:8px 0 6px;">Showcase</h3>
        <div class="profile-list">${listHTML}</div>
      `;
      ov.style.display = 'flex';
      const close = () => { ov.style.display = 'none'; };
      document.getElementById('profileCloseBtn').onclick = close;
      const outsideHandler = (e) => { if (e.target === ov) close(); };
      ov.addEventListener('click', outsideHandler, { once: true });
    }

    /* --------------------- Shop / Backpack (Firestore-aware) --------------------- */
    function friendlyMeta(item) {
      if (item.type === 'gear-rod')  return 'gear ¬∑ rod';
      if (item.type === 'gear-bait') return 'gear ¬∑ bait';
      return `${item.type}${item.value ? ` ¬∑ ${item.value}g` : ''}`;
    }

    async function renderBackpack() {
      const inv = getInventory().map((it, original) => ({ ...it, _idx: original })).filter(i => i.showcased !== true);
      const coins = currentUserDoc?.coins ?? 0;
      const rows = inv.map(item => {
        const heartClass = item.favorite ? 'heart-btn fav' : 'heart-btn';
        return `
          <div class="bp-row" data-idx="${item._idx}">
            <div class="bp-name">${renderStyledFishName(item)}</div>
            <div class="bp-meta">${friendlyMeta(item)}</div>
            <div class="heart">
              <button class="${heartClass}" title="Favorite (left-click) / Toggle (right-click)" data-idx="${item._idx}">
                ${item.favorite ? '‚ô•' : '‚ô°'}
              </button>
            </div>
          </div>
        `;
      }).join('');
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="bp-wrap">
          <h2>üéí Backpack</h2>
          <div class="scroll-panel">
            ${rows || '<p>No items yet.</p>'}
          </div>
          <div class="bp-hint">
            Tip: Showcased fish are hidden here and can‚Äôt be sold until you remove them from üñº Showcase.
          </div>
        </div>
      `;
      updateGoldHud();
      document.querySelectorAll('.heart-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          const inv = getInventory(); if (!inv[idx]) return;
          inv[idx].favorite = !inv[idx].favorite;
          await setInventory(inv);
          renderBackpack();
        });
      });
      document.querySelectorAll('.bp-row').forEach(row => {
        row.addEventListener('contextmenu', async (e) => {
          e.preventDefault();
          const idx = Number(row.getAttribute('data-idx'));
          const inv = getInventory(); if (!inv[idx]) return;
          inv[idx].favorite = !inv[idx].favorite;
          await setInventory(inv);
          renderBackpack();
        });
      });
    }

    document.getElementById('shopBtn').addEventListener('click', renderShopMenu);
    function isSellable(item) { return (item && item.showcased !== true && !item.favorite && (item.type === 'fish' || item.type === 'trash')); }
    function sellValue(item) { return typeof item.value === 'number' ? item.value : 0; }

    function renderShopMenu() {
      const coins = currentUserDoc?.coins ?? 0;
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="shop-wrap">
          <h2>üõí Shop</h2>
          <p>What would you like to do?</p>
          <div class="row" style="margin-top:6px;">
            <button class="location-btn" id="buyBtn">üß∫ Buy</button>
            <button class="location-btn" id="sellBtn">üí∞ Sell</button>
          </div>
        </div>
      `;
      updateGoldHud();
      document.getElementById('buyBtn').addEventListener('click', showBuy);
      document.getElementById('sellBtn').addEventListener('click', showSell);
    }

    function canAfford(cost){ return (currentUserDoc?.coins ?? 0) >= cost; }
    const PRICE_RULES = { rodBase1: 50, rodBase2: 100, baitBase1: 25, baitBase2: 50 };
    function seqPrice(base1, base2, n) {
      if (n <= 1) return base1; if (n === 2) return base2;
      let a = base1, b = base2; for (let i = 3; i <= n; i++) { const c = a + b; a = b; b = c; } return b;
    }
    function nextRodCost()  { return seqPrice(PRICE_RULES.rodBase1,  PRICE_RULES.rodBase2,  Math.max(getStats().rodLevel, 1)); }
    function nextBaitCost() { return seqPrice(PRICE_RULES.baitBase1, PRICE_RULES.baitBase2, Math.max(getStats().baitTier + 1, 1)); }

    async function equipRod(level) {
      const inv = getInventory().filter(i => i.type !== 'gear-rod');
      inv.push({ name: `Rod (Lv${level})`, type: 'gear-rod', value: 0, favorite: false, showcased:false, sizeKey:'normal', sizeLabel:'' });
      await setInventory(inv);
    }
    async function equipBait(tier) {
      const inv = getInventory().filter(i => i.type !== 'gear-bait');
      inv.push({ name: `Bait (T${tier})`, type: 'gear-bait', value: 0, favorite: false, showcased:false, sizeKey:'normal', sizeLabel:'' });
      await setInventory(inv);
    }

    const SHOP_ITEMS = [
      { id:'rod',  name:'Sturdy Rod (+1 zone / -wobble)',   getCost: () => nextRodCost(),  apply: async (s)=>{ const next = { ...s, rodLevel: (s.rodLevel??1)+1 }; await setStats(next); await equipRod(next.rodLevel); } },
      { id:'bait', name:'Basic Bait (+1 bite speed)',       getCost: () => nextBaitCost(), apply: async (s)=>{ const next = { ...s, baitTier: (s.baitTier??0)+1 }; await setStats(next); await equipBait(next.baitTier); } },
    ];

    async function showBuy() {
      const coins = currentUserDoc?.coins ?? 0;
      const body = SHOP_ITEMS.map(it => {
        const cost = it.getCost();
        const disabled = coins < cost ? 'disabled' : '';
        return `
          <div class="sell-row">
            <div><strong>${it.name}</strong></div>
            <div>${cost}g</div>
            <button data-id="${it.id}" class="buy-btn" ${disabled}>Buy</button>
          </div>
        `;
      }).join('');
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="shop-wrap">
          <h2>üõí Shop ¬∑ Buy</h2>
          <div class="row" style="margin-bottom:10px;"><button id="backToShop">‚Üê Back</button></div>
          <div class="sell-list scroll-panel">${body}</div>
          <p class="small" style="opacity:.8;margin-top:8px;">
            Prices grow by adding the previous two costs (e.g., Rod: 50 ‚Üí 100 ‚Üí 150 ‚Üí 250‚Ä¶). Upgrades stack and auto-equip (replacing old gear).
          </p>
        </div>
      `;
      updateGoldHud();
      document.getElementById('backToShop').onclick = renderShopMenu;
      document.querySelectorAll('.buy-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const item = SHOP_ITEMS.find(x => x.id === id); if (!item) return;
          const cost = item.getCost();
          if (!canAfford(cost)) { alert("Not enough gold!"); return; }
          await setGold((currentUserDoc?.coins ?? 0) - cost);
          await item.apply(getStats());
          goldPopup(`Purchased: ${item.name}`);
          showBuy();
        });
      });
    }

    async function showSell() {
      const coins = currentUserDoc?.coins ?? 0;
      const sellable = getInventory().map((it, idx) => ({...it, _idx: idx})).filter(it => isSellable(it));
      const list = sellable.map(it => `
        <div class="sell-row">
          <div><strong>${renderStyledFishName(it)}</strong> <span style="opacity:.85">¬∑ ${it.type}</span></div>
          <div>${sellValue(it)}g</div>
          <button data-idx="${it._idx}" class="sell-one-btn">Sell</button>
        </div>
      `).join('');
      const totalGold = sellable.reduce((a,c)=>a+sellValue(c),0);
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${coins} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="shop-wrap">
          <h2>üõí Shop ¬∑ Sell</h2>
          <div class="row" style="margin-bottom:10px;">
            <button id="backToShop">‚Üê Back</button>
            <button id="sellAllBtnTop" ${sellable.length ? '' : 'disabled'}>Sell All</button>
          </div>
          ${sellable.length ? `<div class="sell-list scroll-panel">${list}</div>` : `<p>No sellable items. Favorited or Showcased fish are protected, and gear can‚Äôt be sold.</p>`}
          <div class="sell-summary">
            <p>Total (non-favorited, non-showcased, sellable): <strong>${totalGold}g</strong></p>
            <div class="row"><button id="sellAllBtn" ${sellable.length ? '' : 'disabled'}>Sell All</button></div>
          </div>
        </div>
      `;
      updateGoldHud();
      document.getElementById('backToShop').onclick = renderShopMenu;
      const sellAll = async () => {
        const inv = getInventory(); let earned = 0; const remaining = [];
        for (const it of inv) { if (isSellable(it)) earned += sellValue(it); else remaining.push(it); }
        if (earned === 0) { alert("Nothing to sell."); return; }
        await setInventory(remaining); await addGold(earned); showSell();
      };
      const sellAllTop = document.getElementById('sellAllBtnTop');
      const sellAllBottom = document.getElementById('sellAllBtn');
      if (sellAllTop) sellAllTop.onclick = sellAll;
      if (sellAllBottom) sellAllBottom.onclick = sellAll;

      document.querySelectorAll('.sell-one-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          const inv = getInventory(); const item = inv[idx]; if (!item || !isSellable(item)) { alert("That item can't be sold."); return; }
          const value = sellValue(item); inv.splice(idx, 1); await setInventory(inv); await addGold(value); showSell();
        });
      });
    }

    /* --------------------- Minigame core (your logic) --------------------- */
    const rarityConfig = {
      common:    { zoneMin: 28, zoneMax: 72, drift: 0.25, wobble: 0.6,  timeToLand: 2200 },
      uncommon:  { zoneMin: 33, zoneMax: 67, drift: 0.38, wobble: 0.9,  timeToLand: 3000 },
      rare:      { zoneMin: 40, zoneMax: 60, drift: 0.55, wobble: 1.2,  timeToLand: 3800 },
      epic:      { zoneMin: 42, zoneMax: 58, drift: 0.75, wobble: 1.6,  timeToLand: 5200 },
      legendary: { zoneMin: 44, zoneMax: 56, drift: 0.95, wobble: 1.9,  timeToLand: 6200 }
    };
    function weightedPick(table) {
      const total = table.reduce((a,c)=>a+c.weight,0);
      let roll = Math.random() * total;
      for (const item of table) { if ((roll -= item.weight) <= 0) return item; }
      return table[0];
    }
    async function animateProgress(fillEl, durationMs){
      const start = performance.now();
      return new Promise(resolve=>{
        function step(ts){
          const t = Math.min(1, (ts - start)/durationMs);
          fillEl.style.width = (t*100).toFixed(1) + '%';
          if (t < 1) requestAnimationFrame(step); else resolve();
        }
        requestAnimationFrame(step);
      });
    }
    function startReelMinigame(container, fish, onDone) {
      const cfg = rarityConfig[fish.rarity] || rarityConfig.common;
      const { rodLevel } = getStats();
      const eff = { ...cfg };
      const widen = Math.min(10, 2 * rodLevel);
      const center = (eff.zoneMin + eff.zoneMax) / 2;
      const width = (eff.zoneMax - eff.zoneMin) + widen;
      eff.zoneMin = Math.max(5, center - width/2);
      eff.zoneMax = Math.min(95, center + width/2);
      eff.wobble  = Math.max(0.25, eff.wobble * (1 - 0.08 * rodLevel));

      const START_PROGRESS_FRAC = 0.45;
      container.innerHTML = `
        <div class="progress" id="landProg"><div class="progress-fill" id="landFill"></div></div>
        <div class="meter" id="meter">
          <div class="meter-zone" id="zone"></div>
          <div class="meter-fill" id="fill"></div>
        </div>
        <div class="row"><button id="reelBtn">Reel</button></div>
      `;
      const reelBtn = document.getElementById('reelBtn');
      const fill = document.getElementById('fill');
      const zone = document.getElementById('zone');
      const landFill = document.getElementById('landFill');

      zone.style.left = eff.zoneMin + '%';
      zone.style.width = (eff.zoneMax - eff.zoneMin) + '%';

      let tension = 50, holding = false, lastTs = performance.now(), timer;
      let progress = Math.round(eff.timeToLand * START_PROGRESS_FRAC);

      const onHold = () => { holding = true; };
      const onRelease = () => { holding = false; };
      reelBtn.addEventListener('mousedown', onHold);
      reelBtn.addEventListener('mouseup', onRelease);
      reelBtn.addEventListener('mouseleave', onRelease);
      reelBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); onHold(); }, {passive:false});
      reelBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); onRelease(); }, {passive:false});
      const onKeyDown = (e) => { if (e.code === 'Space' || e.key === ' ') { e.preventDefault(); holding = true; } };
      const onKeyUp   = (e) => { if (e.code === 'Space' || e.key === ' ') { e.preventDefault(); holding = false; } };
      window.addEventListener('keydown', onKeyDown);
      window.addEventListener('keyup', onKeyUp);

      function cleanup() {
        cancelAnimationFrame(timer);
        window.removeEventListener('keydown', onKeyDown);
        window.removeEventListener('keyup', onKeyUp);
      }

      function step(ts) {
        const dt = Math.min(50, ts - lastTs); lastTs = ts;
        const baseDrift = (eff.drift != null ? eff.drift : 0.25);
        let drift = (holding ? baseDrift*2.2 : -baseDrift*1.6);
        const wobble = (Math.sin(ts/140) + Math.cos(ts/310)) * eff.wobble;
        tension += (drift + wobble) * (dt/16.7);
        tension = Math.max(0, Math.min(100, tension));
        fill.style.left = (tension - 10) + '%'; fill.style.width = '20%';
        const inZone = tension >= eff.zoneMin && tension <= eff.zoneMax;
        const FILL_RATE=1.0, DRAIN_RATE=0.9;
        progress += inZone ? (dt*FILL_RATE) : (-dt*DRAIN_RATE);
        if (progress < 0) progress = 0; if (progress > eff.timeToLand) progress = eff.timeToLand;
        landFill.style.width = Math.max(0, Math.min(100, (progress / eff.timeToLand) * 100)).toFixed(1) + '%';
        if (progress >= eff.timeToLand) return end(true);
        if (progress <= 0)             return end(false);
        timer = requestAnimationFrame(step);
      }
      timer = requestAnimationFrame(step);

      function end(success) { cleanup(); reelBtn.disabled = true; setTimeout(()=>onDone(success, reelBtn), 120); }
    }
    function startReelMinigameWithConfig(container, fish, customCfg, onDone) {
      const cfgKey = fish.rarity; const tempKey = `__temp_${cfgKey}`;
      rarityConfig[tempKey] = customCfg;
      const tempFish = { ...fish, rarity: tempKey };
      startReelMinigame(container, tempFish, (ok, btn) => { delete rarityConfig[tempKey]; onDone(ok, btn); });
    }

    /* --------------------- Pond / Stream (uses Firestore saves) --------------------- */
    function showPond() {
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${(currentUserDoc?.coins ?? 0)} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="pond-wrap">
          <div class="pond-header">
            <h2>üêü Pond</h2>
            <button id="backToSpots" class="back-inline back-left">‚Üê Back to Spots</button>
          </div>
          <div class="status" id="pondStatus">The pond is calm and reflective.</div>
          <div class="progress" id="searchProg" style="display:none;"><div class="progress-fill" id="searchFill"></div></div>
          <div class="row" id="castRow"><button id="castBtn">Cast</button></div>
          <div id="minigameArea" style="margin-top:14px;"></div>
          <div class="small" style="margin-top:10px;">Tip: Hold <b>Reel</b> (or <b>Space</b>) to raise tension; release to let it fall.</div>
        </div>
      `;
      updateGoldHud();
      const backBtn   = document.getElementById('backToSpots');
      const status    = document.getElementById('pondStatus');
      const area      = document.getElementById('minigameArea');
      const searchProg= document.getElementById('searchProg');
      const searchFill= document.getElementById('searchFill');
      const castRow   = document.getElementById('castRow');
      const castBtn   = document.getElementById('castBtn');
      if (backBtn) backBtn.onclick = () => document.getElementById('fishingSpotBtn').click();

      let spaceRecastKeydown = null;
      function setSpaceRecast(handler) {
        if (spaceRecastKeydown) { window.removeEventListener('keydown', spaceRecastKeydown); spaceRecastKeydown = null; }
        if (handler) {
          spaceRecastKeydown = (e) => { if (e.code === 'Space' || e.key === ' ') { e.preventDefault(); handler(); } };
          window.addEventListener('keydown', spaceRecastKeydown);
        }
      }

      const runCastCycle = async () => {
        setSpaceRecast(null);
        castRow.style.display = 'none';
        area.innerHTML = '';
        status.textContent = "Watching for ripples...";
        searchProg.style.display = 'block';
        searchFill.style.width = '0%';

        const { baitTier } = getStats();
        const baseWait = 1000 + Math.random()*2000;
        const waitMs = Math.max(350, baseWait * (1 - 0.1 * baitTier));
        await animateProgress(searchFill, waitMs);
        searchProg.style.display = 'none';

        const hooked = weightedPick(pondTable);

        if (hooked.type === 'trash') {
          status.innerHTML = `You snagged <b>${hooked.name}</b> (+${hooked.value}g).`;
          await saveCatchToUser(hooked.name);
          await addXP(1);
          area.innerHTML = `<div class="row"><button id="recastBtn">Recast</button></div>`;
          document.getElementById('recastBtn').onclick = runCastCycle;
          setSpaceRecast(runCastCycle);
          return;
        }

        const vr = buildVariantResult();
        const statusLabel = vr.status ? vr.status.label : '';
        const cfg = { ...(rarityConfig[hooked.rarity] || rarityConfig.common) };
        const zoneCenter = (cfg.zoneMin + cfg.zoneMax)/2;
        const width = (cfg.zoneMax - cfg.zoneMin);
        const narrow = Math.max(8, width * (1 - vr.diff.zoneNarrow));
        cfg.zoneMin = Math.max(5, zoneCenter - narrow/2);
        cfg.zoneMax = Math.min(95, zoneCenter + narrow/2);
        cfg.wobble  = cfg.wobble * (1 + vr.diff.wobble) * 1.10;
        cfg.drift   = (cfg.drift || 0.35) * (1 + vr.diff.driftUp) * 1.10;
        cfg.timeToLand = Math.round(cfg.timeToLand * (1 + vr.diff.timeUp));

        status.innerHTML = `Bite! Keep the tension in the zone to land it!`;

        startReelMinigameWithConfig(area, hooked, cfg, async (success, reelBtnRef) => {
          if (success) {
            const sz = rollSizeTier();
            const baseValue = hooked.value || 0;
            const finalValue = Math.max(0, Math.round(baseValue * vr.totalMult * (sz.mult || 1)));
            const tempItemForStyle = { name: hooked.name, variantBaseKey: normalizeVariantKey(vr.base.key), statusLabel, sizeKey: sz.key, sizeLabel: sz.label };
            status.innerHTML = `<span class="success">Success!</span> You caught a <b>${renderStyledFishName(tempItemForStyle)}</b>!`;
            await saveCatchToUser({
              name: hooked.name, type: hooked.type, value: finalValue, favorite: false,
              variantBaseKey: normalizeVariantKey(vr.base.key), variantBaseLabel: prettyLabelFromKey(vr.base.key),
              statusLabel, sizeKey: sz.key, sizeLabel: sz.label
            });
            const xpByRarity = { common: 2, uncommon: 4, rare: 8, epic: 12, legendary: 20 };
            await addXP(xpByRarity[hooked.rarity] ?? 2);
          } else {
            status.innerHTML = `<span class="fail">It got away!</span>`;
          }
          if (reelBtnRef) {
            reelBtnRef.textContent = 'Recast'; reelBtnRef.disabled = false;
            reelBtnRef.onclick = () => runCastCycle(); setSpaceRecast(runCastCycle);
          } else {
            area.innerHTML = `<div class="row"><button id="recastBtn">Recast</button></div>`;
            document.getElementById('recastBtn').onclick = runCastCycle; setSpaceRecast(runCastCycle);
          }
        });
      };

      if (castBtn) castBtn.onclick = runCastCycle;
    }

    function showStream() {
      if (!isStreamUnlocked()) { alert('Locked: Reach Level 10 to access the Stream.'); return; }
      mainContent.innerHTML = `
        <div class="hud" id="goldHud">üí∞ ${(currentUserDoc?.coins ?? 0)} ¬∑ ‚≠ê Lv ${getStats().level} (${getStats().xp}/${xpNeededFor(getStats().level)})</div>
        <div class="pond-wrap">
          <div class="pond-header">
            <h2>üåä Stream</h2>
            <button id="backToSpots" class="back-inline back-left">‚Üê Back to Spots</button>
          </div>
          <div class="status" id="streamStatus">The current is swift and the water is clear.</div>
          <div class="progress" id="searchProg" style="display:none;"><div class="progress-fill" id="searchFill"></div></div>
          <div class="row" id="castRow"><button id="castBtn">Cast</button></div>
          <div id="minigameArea" style="margin-top:14px;"></div>
          <div class="small" style="margin-top:10px;">Tip: Hold <b>Reel</b> (or <b>Space</b>) to raise tension; release to let it fall.</div>
        </div>
      `;
      updateGoldHud();
      const backBtn   = document.getElementById('backToSpots');
      const status    = document.getElementById('streamStatus');
      const area      = document.getElementById('minigameArea');
      const searchProg= document.getElementById('searchProg');
      const searchFill= document.getElementById('searchFill');
      const castRow   = document.getElementById('castRow');
      const castBtn   = document.getElementById('castBtn');

      if (backBtn) backBtn.onclick = () => document.getElementById('fishingSpotBtn').click();

      let spaceRecastKeydown = null;
      function setSpaceRecast(handler) {
        if (spaceRecastKeydown) { window.removeEventListener('keydown', spaceRecastKeydown); spaceRecastKeydown = null; }
        if (handler) {
          spaceRecastKeydown = (e) => { if (e.code === 'Space' || e.key === ' ') { e.preventDefault(); handler(); } };
          window.addEventListener('keydown', spaceRecastKeydown);
        }
      }

      const runCastCycle = async () => {
        setSpaceRecast(null);
        castRow.style.display = 'none';
        area.innerHTML = '';
        status.textContent = "Scanning the fast current...";
        searchProg.style.display = 'block';
        searchFill.style.width = '0%';

        const { baitTier } = getStats();
        const baseWait = 1000 + Math.random()*2000;
        const waitMs = Math.max(350, baseWait * (1 - 0.1 * baitTier));
        await animateProgress(searchFill, waitMs);
        searchProg.style.display = 'none';

        const hooked = weightedPick(streamTable);

        if (hooked.type === 'trash') {
          status.innerHTML = `You snagged <b>${hooked.name}</b> (+${hooked.value}g).`;
          await saveCatchToUser(hooked.name);
          await addXP(1);
          area.innerHTML = `<div class="row"><button id="recastBtn">Recast</button></div>`;
          document.getElementById('recastBtn').onclick = runCastCycle;
          setSpaceRecast(runCastCycle);
          return;
        }

        const vr = buildVariantResult();
        const statusLabel = vr.status ? vr.status.label : '';
        const cfg = { ...(rarityConfig[hooked.rarity] || rarityConfig.common) };
        const zoneCenter = (cfg.zoneMin + cfg.zoneMax)/2;
        const width = (cfg.zoneMax - cfg.zoneMin);
        const narrow = Math.max(8, width * (1 - vr.diff.zoneNarrow));
        cfg.zoneMin = Math.max(5, zoneCenter - narrow/2);
        cfg.zoneMax = Math.min(95, zoneCenter + narrow/2);
        cfg.wobble  = cfg.wobble * (1 + vr.diff.wobble) * 1.10;
        cfg.drift   = (cfg.drift || 0.35) * (1 + vr.diff.driftUp) * 1.10;
        cfg.timeToLand = Math.round(cfg.timeToLand * (1 + vr.diff.timeUp));

        status.innerHTML = `Bite! Keep the tension in the zone to land it!`;

        startReelMinigameWithConfig(area, hooked, cfg, async (success, reelBtnRef) => {
          if (success) {
            const sz = rollSizeTier();
            const baseValue = hooked.value || 0;
            const finalValue = Math.max(0, Math.round(baseValue * vr.totalMult * (sz.mult || 1)));
            const tempItemForStyle = { name: hooked.name, variantBaseKey: normalizeVariantKey(vr.base.key), statusLabel, sizeKey: sz.key, sizeLabel: sz.label };
            status.innerHTML = `<span class="success">Success!</span> You caught a <b>${renderStyledFishName(tempItemForStyle)}</b>!`;
            await saveCatchToUser({
              name: hooked.name, type: hooked.type, value: finalValue, favorite: false,
              variantBaseKey: normalizeVariantKey(vr.base.key), variantBaseLabel: prettyLabelFromKey(vr.base.key),
              statusLabel, sizeKey: sz.key, sizeLabel: sz.label
            });
            const xpByRarity = { common: 2, uncommon: 4, rare: 8, epic: 12, legendary: 20 };
            await addXP(xpByRarity[hooked.rarity] ?? 2);
          } else {
            status.innerHTML = `<span class="fail">It got away!</span>`;
          }
          if (reelBtnRef) {
            reelBtnRef.textContent = 'Recast'; reelBtnRef.disabled = false;
            reelBtnRef.onclick = () => runCastCycle(); setSpaceRecast(runCastCycle);
          } else {
            area.innerHTML = `<div class="row"><button id="recastBtn">Recast</button></div>`;
            document.getElementById('recastBtn').onclick = runCastCycle; setSpaceRecast(runCastCycle);
          }
        });
      };
      if (castBtn) castBtn.onclick = runCastCycle;
    }

    function buildVariantResult() {
      const VARIANT_BASES = [
        { key:'none',     label:'',        mult:1.00, chance:null,  wobble:0,    zoneNarrow:0,    timeUp:0,   driftUp:0 },
        { key:'bronze',   label:'Bronze',  mult:1.25, chance:0.050, wobble:0.05, zoneNarrow:0.02, timeUp:0.02, driftUp:0.05 },
        { key:'silver',   label:'Silver',  mult:1.50, chance:0.045, wobble:0.10, zoneNarrow:0.03, timeUp:0.04, driftUp:0.08 },
        { key:'gold',     label:'Gold',    mult:2.00, chance:0.040, wobble:0.15, zoneNarrow:0.04, timeUp:0.06, driftUp:0.12 },
        { key:'diamond',  label:'Diamond', mult:3.00, chance:0.020, wobble:0.25, zoneNarrow:0.06, timeUp:0.09, driftUp:0.18 },
        { key:'rainbow',  label:'Rainbow', mult:5.00, chance:0.007, wobble:0.35, zoneNarrow:0.08, timeUp:0.12, driftUp:0.22 },
      ];
      const STATUS_POOL = [
        { key:'frozen',       label:'Frozen',       add:0.25, chance:0.10, wobble:0.05, zoneNarrow:0.01,  timeUp:0.02, driftUp:0.03 },
        { key:'electrocuted', label:'Electrocuted', add:0.50, chance:0.10, wobble:0.08, zoneNarrow:0.015, timeUp:0.03, driftUp:0.05 },
        { key:'burned',       label:'Burned',       add:0.75, chance:0.10, wobble:0.10, zoneNarrow:0.02,  timeUp:0.04, driftUp:0.06 },
      ];
      const sorted = VARIANT_BASES.filter(v=>v.key!=='none').sort((a,b)=>a.chance-b.chance);
      const r = Math.random(); let acc = 0; let base = VARIANT_BASES[0];
      for (const v of sorted) { acc += v.chance; if (r < acc){ base = v; break; } }
      let status = null; for (const s of STATUS_POOL) { if (Math.random() < s.chance) { status = s; break; } }
      const statusMult = status ? (1 + status.add) : 1;
      const totalMult = base.mult * statusMult;
      const diff = {
        wobble: (base.wobble) + (status?.wobble || 0),
        zoneNarrow: (base.zoneNarrow) + (status?.zoneNarrow || 0),
        timeUp: (base.timeUp) + (status?.timeUp || 0),
        driftUp: (base.driftUp) + (status?.driftUp || 0),
      };
      return { base, status, totalMult, diff };
    }

    /* --------------------- Initial Home screen --------------------- */
    function renderShopMenu() {/* defined above; listener set earlier */}
    renderHome(); // default content until user signs in
  </script>
</body>
</html>
