<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fishing Idly - Sidebar Base</title>
  <style>
    /* --- 1. Global Reset & Theme --- */
    body {
      background-color: #1b2735;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      margin: 0; 
      height: 100vh; 
      overflow: hidden; /* Stop scrolling on full page */
      display: flex;    /* For the landing page centering */
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
    }
    
    h1 { font-size: 3rem; margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 3px; }
    
    button {
      background-color: #3a506b; color: #fff; border: none; padding: 1rem 2rem;
      font-size: 1.1rem; border-radius: 10px; cursor: pointer; transition: background-color .2s;
    }
    button:hover { background-color: #5bc0be; color:#1b2735; }

    /* --- 2. Landing Page Elements (Hidden when Game Starts) --- */
    .signin-top { position: absolute; top: 20px; right: 30px; background: #3a506b; color:#e0e0e0; padding:.5rem 1rem; border-radius:8px; text-decoration:none; }
    
    .overlay { position: fixed; inset:0; background: rgba(0,0,0,.65); display:flex; justify-content:center; align-items:center; z-index: 20; }
    
    .signin-box {
      background: linear-gradient(135deg, #2a3d56, #3a506b);
      padding: 2rem; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,.4);
      width: 300px; text-align:center; transform: scale(.8); opacity: 0; animation: pop .3s forwards;
    }
    @keyframes pop { to { transform: scale(1); opacity: 1; } }

    .signin-box input {
      width: 90%; padding: .7rem; margin: .5rem 0; border: none; border-radius: 8px;
      outline: none; background:#1b2735; color:#e0e0e0;
    }
    .toggle-link { display:block; margin-top:1rem; color:#9ad4d6; cursor:pointer; text-decoration:underline; font-size:.9rem; }

    /* --- 3. Game Layout (Sidebar + Main) --- */
    
    /* The container acts as a Flex Row: [Sidebar] [Main Content] */
    .game-container { 
      display: none; /* Hidden until login */
      width: 100%; 
      height: 100vh; 
      flex-direction: row; 
      background-color: #1b2735; /* Ensure background persists */
    }

    /* Left Sidebar Styling */
    .sidebar {
      width: 220px; 
      background: #2a3d56; 
      display: flex; 
      flex-direction: column; 
      justify-content: space-between; /* Pushes logout to bottom */
      align-items: center; 
      padding: 16px 10px; 
      border-right: 2px solid #5bc0be;
      box-sizing: border-box; /* Ensures padding doesn't break width */
    }

    .nav-buttons { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      width: 100%; 
    }

    .nav-buttons button { 
      width: 95%; 
      margin: 6px 0; 
      background: #3a506b; 
      font-size: 0.95rem; 
      padding: 0.8rem; 
      text-align: left;
    }
    .nav-buttons button:hover { background: #5bc0be; color: #1b2735; }

    .logout-btn { 
      background: #b0413e; 
      width: 95%; 
      font-size: 0.9rem; 
      padding: 0.6rem; 
      margin-bottom: 10px;
    }
    .logout-btn:hover { background: #e24e4b; }

    /* Right Main Content Styling */
    .main-content { 
      flex: 1; /* Takes remaining width */
      display: flex; 
      flex-direction: column;
      justify-content: center; 
      align-items: center; 
      text-align: center; 
      padding: 30px; 
      position: relative; 
    }

    /* HUD (Top Right of Main Content) */
    .hud {
      position: absolute; top: 12px; right: 16px;
      background: rgba(0,0,0,.35); padding: 8px 12px; border-radius: 10px; font-size: .95rem;
      box-shadow: 0 0 0 1px rgba(255,255,255,.08) inset;
    }
  </style>
</head>
<body>

  <!-- Landing Screen (Visible initially) -->
  <a href="#" class="signin-top" id="signinLink">Sign In</a>
  <h1 id="title">Fishing Idly</h1>
  <button id="startButton">Start</button>

  <!-- Login Overlay -->
  <div class="overlay" id="overlay" style="display:none;">
    <div class="signin-box">
      <!-- Sign In Form -->
      <div id="signinForm">
        <h2>Sign In</h2>
        <input type="text" id="signin-username" placeholder="Username"/>
        <input type="password" id="signin-password" placeholder="Password"/>
        <button id="loginButton">Log In</button>
        <span class="toggle-link" id="showSignup">Don‚Äôt have an account? Sign Up</span>
      </div>
      <!-- Sign Up Form -->
      <div id="signupForm" style="display:none;">
        <h2>Create Account</h2>
        <input type="email" id="signup-email" placeholder="Email"/>
        <input type="text" id="signup-username" placeholder="Username"/>
        <input type="password" id="signup-password" placeholder="Password"/>
        <button id="signupButton">Sign Up</button>
        <span class="toggle-link" id="showSignin">Already have an account? Sign In</span>
      </div>
    </div>
  </div>

  <!-- Game UI (Visible after login) -->
  <div class="game-container" id="gameContainer">
    
    <!-- LEFT SIDEBAR -->
    <div class="sidebar">
      <div class="nav-buttons">
        <!-- These are empty placeholders for now -->
        <button id="homeBtn">üè† Home</button>
        <button id="fishingSpotBtn">üé£ Fishing Spot</button>
        <button id="backpackBtn">üéí Backpack</button>
        <button id="shopBtn">üõí Shop</button>
        <button id="leaderboardBtn">üèÜ Leaderboard</button>
      </div>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <!-- RIGHT MAIN CONTENT -->
    <div class="main-content" id="mainContent">
      <div class="hud" id="hud">Loading...</div>
      <h2 id="welcomeMsg">Welcome!</h2>
      <p>Select an option from the sidebar to begin.</p>
    </div>

  </div>

  <!-- Logic -->
  <script type="module">
    /* ---------------- Firebase Setup ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnoFqUUjddA6ipJSisLOS7MsFklhQKt_w",
      authDomain: "fishingidly-c1613.firebaseapp.com",
      projectId: "fishingidly-c1613",
      storageBucket: "fishingidly-c1613.firebasestorage.app",
      messagingSenderId: "531215063717",
      appId: "1:531215063717:web:dea4ce7aa7a64d3f374b4c",
      measurementId: "G-SR67MT90SE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ---------------- Helper Functions ---------------- */
    function cleanForFirestore(obj) {
      const cleaned = { ...obj };
      Object.keys(cleaned).forEach(key => {
        if (cleaned[key] === undefined || cleaned[key] === null) delete cleaned[key];
      });
      return cleaned;
    }

    function setCurrentUser(user) {
      if (!user) return;
      localStorage.setItem('currentUser', JSON.stringify(cleanForFirestore(user)));
    }

    function getCurrentUser() {
      try {
        const raw = localStorage.getItem('currentUser');
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    async function savePlayerToCloud(user) {
      if (!user || !user.username) return;
      await setDoc(doc(db, "players", user.username), cleanForFirestore(user), { merge: true });
    }

    /* ---------------- UI Handling ---------------- */
    const overlay = document.getElementById('overlay');
    const title = document.getElementById('title');
    const startButton = document.getElementById('startButton');
    const signinLink = document.getElementById('signinLink');
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    
    // Game Elements
    const gameContainer = document.getElementById('gameContainer');
    const mainContent = document.getElementById('mainContent');
    const hud = document.getElementById('hud');
    const welcomeMsg = document.getElementById('welcomeMsg');

    // Button Logic
    document.getElementById('showSignup').onclick = () => { signinForm.style.display='none'; signupForm.style.display='block'; };
    document.getElementById('showSignin').onclick = () => { signupForm.style.display='none'; signinForm.style.display='block'; };
    
    function openModal() { overlay.style.display = 'flex'; }
    signinLink.onclick = openModal;
    startButton.onclick = openModal;
    overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };

    /* ---------------- Auth & Game Start ---------------- */
    
    // START GAME FUNCTION (Switches Layout)
    function startGame(user) {
      // Hide Landing Elements
      overlay.style.display = 'none';
      title.style.display = 'none';
      startButton.style.display = 'none';
      signinLink.style.display = 'none';
      
      // Show Game Container (Flex Row)
      gameContainer.style.display = 'flex';
      
      // Update UI
      welcomeMsg.innerHTML = `Welcome back, <strong>${user.username}</strong>!`;
      hud.textContent = `üí∞ ${user.coins || 0} ¬∑ ‚≠ê Lv ${user.level || 1}`;
    }

    // SIGN UP
    document.getElementById('signupButton').onclick = async () => {
      const email = document.getElementById('signup-email').value.trim();
      const username = document.getElementById('signup-username').value.trim();
      const password = document.getElementById('signup-password').value.trim();

      if (!email || !username || !password) return alert("Please fill all fields.");

      const snap = await getDoc(doc(db, "players", username));
      if (snap.exists()) return alert("Username already exists!");

      const newUser = { 
        email, username, password, 
        coins: 0, items: [], level: 1, xp: 0 
      };

      await savePlayerToCloud(newUser);
      alert("Account created! Please Log In.");
      signupForm.style.display = 'none';
      signinForm.style.display = 'block';
    };

    // LOG IN
    document.getElementById('loginButton').onclick = async () => {
      const u = document.getElementById('signin-username').value.trim();
      const p = document.getElementById('signin-password').value.trim();

      // Master Account
      if (u === "Llama" && p === "Helloworld") {
        const masterUser = { username: "Llama", email: "llama@master.local", coins: 99999, level: 100, isAdmin: true };
        setCurrentUser(masterUser);
        startGame(masterUser);
        return;
      }

      // Normal Account
      const snap = await getDoc(doc(db, "players", u));
      if (!snap.exists()) return alert("User not found.");
      
      const user = snap.data();
      if (user.password !== p) return alert("Wrong password.");

      setCurrentUser(user);
      startGame(user);
    };

    // LOGOUT
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('currentUser');
      location.reload();
    };

    /* ---------------- Sidebar Navigation (Placeholders) ---------------- */
    document.getElementById('homeBtn').onclick = () => {
      // Just updating the text for now
      mainContent.innerHTML = `<div class="hud" id="hud">${hud.textContent}</div><h2>üè† Home</h2><p>This is your base.</p>`;
    };
    document.getElementById('fishingSpotBtn').onclick = () => {
      mainContent.innerHTML = `<div class="hud" id="hud">${hud.textContent}</div><h2>üé£ Fishing Spot</h2><p>Pond logic will go here.</p>`;
    };
    document.getElementById('backpackBtn').onclick = () => {
      mainContent.innerHTML = `<div class="hud" id="hud">${hud.textContent}</div><h2>üéí Backpack</h2><p>Items will go here.</p>`;
    };
    document.getElementById('shopBtn').onclick = () => {
      mainContent.innerHTML = `<div class="hud" id="hud">${hud.textContent}</div><h2>üõí Shop</h2><p>Store will go here.</p>`;
    };
    document.getElementById('leaderboardBtn').onclick = () => {
      mainContent.innerHTML = `<div class="hud" id="hud">${hud.textContent}</div><h2>üèÜ Leaderboard</h2><p>Rankings will go here.</p>`;
    };

    // Auto-Login Check
    (async function init() {
      const saved = getCurrentUser();
      if (saved) startGame(saved);
    })();
  </script>
</body>
</html>
