<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fishing Idly - Region Multipliers</title>
  <style>
    /* --- Global & Layout --- */
    body {
      background-color: #1b2735;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      margin: 0; 
      height: 100vh; 
      overflow: hidden; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
      user-select: none;
    }
    
    h1 { font-size: 3rem; margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 3px; }
    
    button {
      background-color: #3a506b; color: #fff; border: none; padding: 1rem 2rem;
      font-size: 1.1rem; border-radius: 10px; cursor: pointer; transition: background-color .2s;
    }
    button:hover { background-color: #5bc0be; color:#1b2735; }
    button:disabled { background-color: #2b394d; color: #9aa7b7; cursor: not-allowed; }

    /* --- PIXEL ART STYLES --- */
    .pixel-icon {
      width: 64px;
      height: 64px;
      object-fit: contain;
      image-rendering: pixelated; 
      image-rendering: crisp-edges;
    }
    .emoji-icon { font-size: 2rem; }

    /* --- Landing --- */
    .signin-top { position: absolute; top: 20px; right: 30px; background: #3a506b; color:#e0e0e0; padding:.5rem 1rem; border-radius:8px; text-decoration:none; }
    .overlay { position: fixed; inset:0; background: rgba(0,0,0,.65); display:flex; justify-content:center; align-items:center; z-index: 50; }
    .signin-box {
      background: linear-gradient(135deg, #2a3d56, #3a506b);
      padding: 2rem; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,.4);
      width: 300px; text-align:center; transform: scale(.8); opacity: 0; animation: pop .3s forwards;
    }
    .signin-box input { width: 90%; padding: .7rem; margin: .5rem 0; border: none; border-radius: 8px; outline: none; background:#1b2735; color:#e0e0e0; }
    .toggle-link { display:block; margin-top:1rem; color:#9ad4d6; cursor:pointer; text-decoration:underline; font-size:.9rem; }
    @keyframes pop { to { transform: scale(1); opacity: 1; } }

    /* --- Game UI --- */
    .game-container { display: none; width: 100%; height: 100vh; flex-direction: row; background-color: #1b2735; }

    .sidebar {
      width: 240px; background: #2a3d56; display: flex; flex-direction: column; 
      justify-content: space-between; align-items: center; padding: 16px 10px; border-right: 2px solid #5bc0be;
      box-sizing: border-box;
    }
    .nav-buttons { display: flex; flex-direction: column; align-items: center; width: 100%; }
    .nav-buttons button { width: 95%; margin: 6px 0; background: #3a506b; font-size: 0.95rem; padding: 0.8rem; text-align: left; }
    .nav-buttons button:hover { background: #5bc0be; color: #1b2735; }
    .logout-btn { background: #b0413e; width: 95%; font-size: 0.9rem; padding: 0.6rem; }
    .logout-btn:hover { background: #e24e4b; }

    .admin-panel { width: 95%; background: rgba(0,0,0,.18); border-radius: 10px; padding: 10px; margin-bottom: 10px; font-size: .9rem; }
    .admin-title { font-weight: 700; opacity: .9; margin-bottom: 6px; text-align: center; color: #ff7a7a; }
    .admin-row { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; }
    .btn-sm { padding: .3rem .6rem; border-radius: 6px; font-size: 0.8rem; min-width: auto; }
    .admin-reset-btn { background: #7a1f1b; width: 95%; margin-bottom: 10px; font-size: 0.9rem; padding: 0.6rem; }
    .admin-reset-btn:hover { background: #a52b25; }

    .main-content { 
      flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; 
      text-align: center; padding: 30px; position: relative; 
    }
    
    /* --- HUD --- */
    .hud {
      position: absolute; top: 12px; right: 16px;
      background: rgba(0,0,0,.5); padding: 10px 15px; border-radius: 12px; font-size: .95rem;
      box-shadow: 0 0 0 1px rgba(255,255,255,.1) inset;
      z-index: 15; min-width: 260px;
    }
    .hud-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .xp-container {
      width: 100%; height: 8px; background: #111; border-radius: 4px;
      overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1);
    }
    .xp-fill { height: 100%; background: linear-gradient(90deg, #a06cd5, #b886e6); width: 0%; transition: width 0.3s ease-out; }

    /* --- POND --- */
    .pond-wrap { max-width: 800px; width: 100%; height: 500px; position: relative; display: flex; flex-direction: column; align-items: center; }
    .pond-header { width: 100%; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
    .back-inline { position: absolute; left: 0; padding: .5rem 1rem; border-radius: 8px; font-size: 0.9rem; }
    .location-btn { margin: 10px; width: 200px; }
    .status { margin: 10px 0; font-size: 1.1rem; min-height: 1.5em; color: #9ad4d6; }
    .wait-bar { position: relative; height: 10px; width: 200px; background: #0f1824; border-radius: 8px; overflow: hidden; margin: 10px auto; display: none; }
    .wait-fill { height: 100%; width: 0%; background: #5bc0be; transition: width 0.1s linear; }

    /* --- MINIGAME --- */
    .minigame-area {
      position: relative; width: 100%; height: 350px;
      background: rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px; overflow: hidden; display: none; cursor: crosshair;
    }
    .game-bar-container {
      width: 100%; max-width: 400px; height: 20px; background: #2b1d1d;
      border: 2px solid #555; border-radius: 10px; margin-bottom: 10px;
      position: relative; display: none; overflow: hidden;
    }
    .game-bar-fill {
      height: 100%; width: 35%; background: linear-gradient(90deg, #ff8a00, #e52e71);
      transition: width 0.1s linear;
    }
    .target-circle {
      position: absolute; width: 50px; height: 50px; background: #5bc0be;
      border-radius: 50%; transform: translate(-50%, -50%); z-index: 5;
      pointer-events: auto; box-shadow: 0 0 10px rgba(91,192,190,0.5);
    }
    .target-ring {
      position: absolute; width: 150px; height: 150px; border: 4px solid #fff;
      border-radius: 50%; transform: translate(-50%, -50%); z-index: 4;
      pointer-events: none; opacity: 0.8;
    }

    /* --- ROD SHOP & BACKPACK --- */
    .bp-grid { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
      gap: 12px; width: 100%; max-height: 60vh; overflow-y: auto; padding: 10px;
    }
    .bp-item {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px; padding: 12px; text-align: center; position: relative;
      overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: space-between;
    }
    .rod-stats { font-size: 0.8rem; color: #aaa; margin: 8px 0; line-height: 1.4; }
    .rod-stats b { color: #fff; }
    .shop-btn { width: 100%; padding: 6px; font-size: 0.9rem; margin-top: 5px; }
    .btn-buy { background: #4caf50; }
    .btn-buy:hover { background: #66bb6a; }
    .btn-equip { background: #5bc0be; color: #1b2735; }
    .btn-owned { background: #555; color: #aaa; cursor: default; }
    .btn-locked { background: #2b1d1d; color: #ff7a7a; border:1px solid #7a1f1b; }
    
    .upgrade-item { border: 1px solid #ffd700; background: rgba(255, 215, 0, 0.1); }

    .star-btn {
      position: absolute; top: 4px; right: 4px;
      background: none; border: none; padding: 0;
      font-size: 1.4rem; cursor: pointer; line-height: 1;
      color: rgba(255,255,255,0.3); transition: color 0.2s, transform 0.1s; z-index: 10;
    }
    .star-btn:hover { color: rgba(255,255,255,0.6); transform: scale(1.1); }
    .star-btn.fav-active { color: #ffd700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.6); opacity: 1; }

    /* --- INDEX STYLES --- */
    .index-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px; width: 100%; max-height: 60vh; overflow-y: auto; padding: 10px;
    }
    .index-card {
      background: rgba(0,0,0,0.3); border: 2px solid #2a3d56; border-radius: 12px;
      padding: 15px; text-align: center; opacity: 0.4; filter: grayscale(1);
      transition: all 0.3s;
    }
    .index-card.unlocked {
      opacity: 1; filter: none; border-color: #5bc0be; background: rgba(91,192,190,0.1);
    }
    .index-name { font-size: 0.8rem; margin-top: 8px; font-weight: bold; }
    .index-rarity { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

    /* --- INDEX TABS --- */
    .index-tabs {
      display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;
    }
    .tab-btn {
      background: #2a3d56; border: 1px solid #5bc0be; color: #5bc0be;
      padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
    }
    .tab-btn:hover { background: rgba(91,192,190,0.2); }
    .tab-btn.active {
      background: #5bc0be; color: #1b2735; font-weight: bold; box-shadow: 0 0 10px rgba(91,192,190,0.4);
    }

    .market-sell-btn { margin-top: 8px; font-size: 0.8rem; padding: 4px 10px; width: 100%; background: #4caf50; color: white; }
    .market-sell-btn:hover { background: #66bb6a; }
    .market-header { margin-bottom: 10px; display: flex; gap: 10px; justify-content: center; }
    .sell-all-btn { background: #e53935; }
    .sell-all-btn:hover { background: #ef5350; }

    /* --- HOME / AQUARIUM STYLES --- */
    .home-header { display:flex; justify-content:space-between; align-items:center; width:100%; max-width:700px; margin-bottom:15px; }
    .passive-info { background:rgba(0,0,0,0.3); padding:8px 15px; border-radius:8px; font-size:0.9rem; border:1px solid rgba(255,255,255,0.1); }
    .claim-btn { background: #ffd700; color: #1b2735; font-weight:bold; padding: 0.6rem 1.2rem; }
    .claim-btn:hover { background: #ffea70; }
    .claim-btn:disabled { background: #555; color: #888; }
    .slot-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; width: 100%; max-width: 750px; }
    .home-slot {
      background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2); border-radius: 10px;
      height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center;
      cursor: pointer; position: relative; transition: all 0.2s;
    }
    .home-slot:hover { background: rgba(255,255,255,0.1); }
    .slot-locked { background: rgba(0,0,0,0.4); border-color: #444; opacity: 0.7; }
    .slot-locked:hover { opacity: 1; }
    .slot-locked-disabled { opacity: 0.3; cursor: not-allowed; border-color: #333; }
    .slot-locked-disabled:hover { opacity: 0.3; background: rgba(0,0,0,0.4); }
    .lock-icon { font-size: 1.5rem; margin-bottom: 5px; }
    .lock-cost { color: #ffd700; font-size: 0.8rem; font-weight: bold; }
    .slot-occupied { border-style: solid; border-color: #5bc0be; background: rgba(91,192,190,0.1); }
    .slot-fish-icon { font-size: 2rem; margin-bottom: 5px; }
    .slot-fish-name { font-size: 0.75rem; font-weight: bold; max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .slot-fish-val { font-size: 0.7rem; opacity: 0.8; color: #ffd700; }
    
    /* Selector & Profile */
    .selector-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(27, 39, 53, 0.95); z-index: 50; display: flex; flex-direction: column; align-items: center; padding-top: 40px;
    }
    .selector-close { position: absolute; top: 20px; right: 20px; }
    .profile-box { width: 600px; max-width: 95%; max-height: 90vh; overflow-y: auto; }
    .profile-header { margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .profile-stats { font-size: 0.9rem; opacity: 0.8; margin-top: 5px; }

    /* Mutations & Leaderboard */
    .mut-Shiny { border-color: #ffcc00; }
    .mut-Sparkling { border-color: #00ccff; box-shadow: 0 0 5px #00ccff; }
    .mut-Mythical { border-color: #ff00ff; }
    .mut-Albino { border-color: #ffffff; }
    .bp-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-top: 4px; font-weight: bold; background: rgba(255,255,255,0.1); }
    .txt-Shiny { color: #ffcc00; }
    .txt-Sparkling { color: #00ccff; }
    .txt-Mythical { color: #ff00ff; }
    .txt-Albino { color: #fff; }
    .lb-list { width: 100%; max-width: 500px; text-align: left; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; }
    .lb-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .lb-rank { width: 30px; font-weight: bold; }
    .lb-name { flex: 1; margin-left: 10px; color: #5bc0be; cursor: pointer; text-decoration: underline; }
    .lb-name:hover { color: #fff; }
    .rank-1 { color: #ffd700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
    .rank-2 { color: #c0c0c0; text-shadow: 0 0 5px rgba(192, 192, 192, 0.5); }
    .rank-3 { color: #cd7f32; text-shadow: 0 0 5px rgba(205, 127, 50, 0.5); }

  </style>
</head>
<body>

  <!-- Landing -->
  <a href="#" class="signin-top" id="signinLink">Sign In</a>
  <h1 id="title">Fishing Idly</h1>
  <button id="startButton">Start</button>

  <!-- Login Modal -->
  <div class="overlay" id="overlay" style="display:none;">
    <div class="signin-box">
      <div id="signinForm">
        <h2>Sign In</h2>
        <input type="text" id="signin-username" placeholder="Username"/>
        <input type="password" id="signin-password" placeholder="Password"/>
        <button id="loginButton">Log In</button>
        <span class="toggle-link" id="showSignup">Don‚Äôt have an account? Sign Up</span>
      </div>
      <div id="signupForm" style="display:none;">
        <h2>Create Account</h2>
        <input type="email" id="signup-email" placeholder="Email"/>
        <input type="text" id="signup-username" placeholder="Username"/>
        <input type="password" id="signup-password" placeholder="Password"/>
        <button id="signupButton">Sign Up</button>
        <span class="toggle-link" id="showSignin">Already have an account? Sign In</span>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="overlay" id="profileOverlay" style="display:none;">
    <div class="signin-box profile-box">
      <div style="text-align:right;"><button id="closeProfileBtn" style="padding:5px 10px; font-size:0.8rem;">X</button></div>
      <div class="profile-header">
        <h2 id="profName">Player</h2>
        <div class="profile-stats" id="profStats">Lv 1 ¬∑ 0g</div>
      </div>
      <h3>Home Aquarium</h3>
      <div class="passive-info" style="margin-bottom:10px;" id="profPassive">Generating: 0g/hr</div>
      <div class="slot-grid" id="profGrid"></div>
    </div>
  </div>

  <!-- Game UI -->
  <div class="game-container" id="gameContainer">
    <div class="sidebar">
      <div class="nav-buttons">
        <button id="homeBtn">üè† Home</button>
        <button id="fishingSpotBtn">üé£ Fishing Spot</button>
        <button id="backpackBtn">üéí Backpack</button>
        <button id="marketBtn">üè™ Market</button>
        <button id="shopBtn">üõí Rod Shop</button>
        <button id="indexBtn">üìñ Index</button>
        <button id="leaderboardBtn">üèÜ Leaderboard</button>
      </div>
      <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
        <div id="adminPanel" class="admin-panel" style="display:none;">
          <div class="admin-title">ADMIN TOOLS</div>
          <div class="admin-row"><span>Level</span><div><button class="btn-sm" id="admLvlDown">-</button><button class="btn-sm" id="admLvlUp">+</button></div></div>
          <div class="admin-row"><span>Gold</span><div><button class="btn-sm" id="admGoldDown">-</button><button class="btn-sm" id="admGoldUp">+</button></div></div>
        </div>
        <button class="admin-reset-btn" id="adminResetBtn" style="display:none;">‚ö† RESET ALL DB DATA</button>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
    <div class="main-content" id="mainContent">
      <div id="viewArea"></div>
    </div>
  </div>

  <!-- Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, getDocs, collection, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnoFqUUjddA6ipJSisLOS7MsFklhQKt_w",
      authDomain: "fishingidly-c1613.firebaseapp.com",
      projectId: "fishingidly-c1613",
      storageBucket: "fishingidly-c1613.firebasestorage.app",
      messagingSenderId: "531215063717",
      appId: "1:531215063717:web:dea4ce7aa7a64d3f374b4c",
      measurementId: "G-SR67MT90SE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DATA HELPERS ---
    function cleanForFirestore(obj) {
      const cleaned = { ...obj };
      Object.keys(cleaned).forEach(key => { if (cleaned[key] === undefined || cleaned[key] === null) delete cleaned[key]; });
      return cleaned;
    }
    function setCurrentUser(user) {
      if (!user) return;
      localStorage.setItem('currentUser', JSON.stringify(cleanForFirestore(user)));
    }
    function getCurrentUser() {
      try { return JSON.parse(localStorage.getItem('currentUser')); } catch { return null; }
    }
    async function savePlayerToCloud(user) {
      if (!user || !user.username) return;
      await setDoc(doc(db, "players", user.username), cleanForFirestore(user), { merge: true });
    }
    async function getAllPlayers() {
      const snap = await getDocs(collection(db, "players"));
      return snap.docs.map(d => d.data());
    }
    async function getPlayerProfile(username) {
      const snap = await getDoc(doc(db, "players", username));
      return snap.exists() ? snap.data() : null;
    }

    // --- ICON HELPER ---
    function getEntityIcon(item) {
        if (item.img && item.img !== "placeholder.png") {
            return `<img src="assets/fish/${item.img}" class="pixel-icon" alt="${item.name}">`;
        }
        if (item.type === 'trash') return `<span class="emoji-icon">üëû</span>`;
        return `<span class="emoji-icon">üêü</span>`;
    }

    // --- GAME CONFIG & RODS ---
    const RODS = [
      { id: 0, name: "Bamboo Rod", cost: 0, luck: 1.0, speed: 1.0, icon: "üéã" },
      { id: 1, name: "Fiberglass Rod", cost: 1500, luck: 1.2, speed: 1.1, icon: "üé£" },
      { id: 2, name: "Carbon Rod", cost: 5000, luck: 1.5, speed: 1.3, icon: "üî©" },
      { id: 3, name: "Lucky Rod", cost: 15000, luck: 2.5, speed: 1.0, icon: "üçÄ" },
      { id: 4, name: "Speedy Rod", cost: 15000, luck: 1.1, speed: 2.0, icon: "‚ö°" },
      { id: 5, name: "Golden Rod", cost: 50000, luck: 3.0, speed: 2.0, icon: "üëë" },
      { id: 6, name: "Poseidon's Trident", cost: 250000, luck: 5.0, speed: 3.0, icon: "üî±" }
    ];

    // --- LOCATION CONFIG (NEW: Global Multipliers) ---
    // Defines how much better a location is compared to the base pond.
    // 'mult': Multiplier for Selling Price and Passive Income
    // 'xpMult': Multiplier for XP gain
    const LOCATION_CONFIG = {
      pond:   { id: 'pond',   name: 'Pond',   mult: 1.0, xpMult: 1.0 },
      stream: { id: 'stream', name: 'Stream', mult: 1.5, xpMult: 1.5 }
      // Future Example:
      // ocean:  { id: 'ocean',  name: 'Ocean',  mult: 3.0, xpMult: 3.0 }
    };

    const pondTable = [
      { name: "Old Boot", type: "trash", img: "placeholder.png", minKg: 0.5, maxKg: 1.5, pricePerKg: 1, rarity: "trash", chanceWeight: 10 },
      { name: "Tin Can", type: "trash", img: "placeholder.png", minKg: 0.1, maxKg: 0.3, pricePerKg: 1, rarity: "trash", chanceWeight: 8 },
      { name: "Tangled Line", type: "trash", img: "placeholder.png", minKg: 0.1, maxKg: 0.5, pricePerKg: 1, rarity: "trash", chanceWeight: 8 },
      { name: "Broken Glass", type: "trash", img: "placeholder.png", minKg: 0.1, maxKg: 0.2, pricePerKg: 1, rarity: "trash", chanceWeight: 8 },
      { name: "Rusty Hook", type: "trash", img: "placeholder.png", minKg: 0.05, maxKg: 0.1, pricePerKg: 1, rarity: "trash", chanceWeight: 8 },
      { name: "Crappie", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 2.0, pricePerKg: 3, rarity: "common", chanceWeight: 20 },
      { name: "Pumpkinseed", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.4, pricePerKg: 4, rarity: "common", chanceWeight: 20 },
      { name: "Yellow Perch", type: "fish", img: "placeholder.png", minKg: 0.2, maxKg: 1.0, pricePerKg: 5, rarity: "common", chanceWeight: 20 },
      { name: "Bluegill", type: "fish", img: "placeholder.png", minKg: 0.3, maxKg: 1.2, pricePerKg: 6, rarity: "uncommon", chanceWeight: 12 },
      { name: "Catfish", type: "fish", img: "placeholder.png", minKg: 2.0, maxKg: 10.0, pricePerKg: 4, rarity: "uncommon", chanceWeight: 10 },
      { name: "Carp", type: "fish", img: "placeholder.png", minKg: 3.0, maxKg: 15.0, pricePerKg: 3, rarity: "uncommon", chanceWeight: 10 },
      { name: "Goldfish", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.8, pricePerKg: 20, rarity: "rare", chanceWeight: 8 },
      { name: "Largemouth Bass", type: "fish", img: "placeholder.png", minKg: 1.5, maxKg: 5.0, pricePerKg: 8, rarity: "epic", chanceWeight: 5 },
      { name: "Golden Koi", type: "fish", img: "placeholder.png", minKg: 2.0, maxKg: 8.0, pricePerKg: 15, rarity: "legendary", chanceWeight: 2 }
    ];

    const streamTable = [
      { name: "Waterlogged Branch", type: "trash", img: "placeholder.png", minKg: 1.0, maxKg: 5.0, pricePerKg: 1, rarity: "trash", chanceWeight: 10 },
      { name: "Torn Fishing Net", type: "trash", img: "placeholder.png", minKg: 0.5, maxKg: 2.0, pricePerKg: 1, rarity: "trash", chanceWeight: 8 },
      { name: "Muddy Bottle", type: "trash", img: "placeholder.png", minKg: 0.2, maxKg: 0.8, pricePerKg: 1, rarity: "trash", chanceWeight: 8 },
      { name: "Creek Chub", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.5, pricePerKg: 4, rarity: "common", chanceWeight: 20 },
      { name: "Fallfish", type: "fish", img: "placeholder.png", minKg: 0.2, maxKg: 1.0, pricePerKg: 4, rarity: "common", chanceWeight: 20 },
      { name: "White Sucker", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 2.5, pricePerKg: 5, rarity: "common", chanceWeight: 15 },
      { name: "Common Shiner", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.3, pricePerKg: 4, rarity: "common", chanceWeight: 15 },
      { name: "Redbreast Sunfish", type: "fish", img: "placeholder.png", minKg: 0.2, maxKg: 0.8, pricePerKg: 4, rarity: "common", chanceWeight: 15 },
      { name: "Smallmouth Bass", type: "fish", img: "placeholder.png", minKg: 0.8, maxKg: 4.0, pricePerKg: 10, rarity: "uncommon", chanceWeight: 12 },
      { name: "Rock Bass", type: "fish", img: "placeholder.png", minKg: 0.3, maxKg: 1.5, pricePerKg: 7, rarity: "uncommon", chanceWeight: 12 },
      { name: "Rainbow Darter", type: "fish", img: "placeholder.png", minKg: 0.02, maxKg: 0.15, pricePerKg: 20, rarity: "uncommon", chanceWeight: 8 }, 
      { name: "Brook Stickleback", type: "fish", img: "placeholder.png", minKg: 0.02, maxKg: 0.1, pricePerKg: 15, rarity: "uncommon", chanceWeight: 8 },
      { name: "Brook Trout", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 4.0, pricePerKg: 16, rarity: "rare", chanceWeight: 6 },
      { name: "Brown Trout", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 5.0, pricePerKg: 18, rarity: "rare", chanceWeight: 5 },
      { name: "Tiger Trout", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 4.0, pricePerKg: 19, rarity: "rare", chanceWeight: 4 },
      { name: "Atlantic Salmon", type: "fish", img: "placeholder.png", minKg: 2.0, maxKg: 12.0, pricePerKg: 28, rarity: "epic", chanceWeight: 3 },
      { name: "Ancient River Sturgeon", type: "fish", img: "placeholder.png", minKg: 10.0, maxKg: 50.0, pricePerKg: 45, rarity: "legendary", chanceWeight: 1 }
    ];

    const mutations = [
      { name: "Normal", mult: 1.0, chance: 0.85 },
      { name: "Shiny", mult: 1.85, chance: 0.08 },
      { name: "Sparkling", mult: 1.85, chance: 0.04 },
      { name: "Albino", mult: 1.15, chance: 0.02 },
      { name: "Mythical", mult: 4.5, chance: 0.01 }
    ];

    const difficultyMap = { trash: 2500, common: 2000, uncommon: 1700, rare: 1400, epic: 1100, legendary: 800 };
    const SLOT_COSTS = [0, 500, 1500, 3000, 5000, 10000, 20000, 50000, 100000, 250000];
    const PASSIVE_RATES = { trash: 0, common: 5, uncommon: 15, rare: 100, epic: 250, legendary: 500 };
    const XP_RATES = { trash: 2, common: 10, uncommon: 25, rare: 60, epic: 150, legendary: 500 };

    // --- DATA INIT ---
    function initUserData(user) {
      let changed = false;
      if (!user.home || !user.home.slots) {
        user.home = { lastClaim: Date.now(), slots: Array(10).fill(null).map((_, i) => ({ id: i, unlocked: i === 0, fish: null })) };
        changed = true;
      }
      if (!user.ownedRods) { user.ownedRods = [0]; changed = true; }
      if (user.equippedRod === undefined) { user.equippedRod = 0; changed = true; }
      if (!user.maxItems) { user.maxItems = 15; changed = true; }
      if (!user.unlockedLocations) { user.unlockedLocations = ["pond"]; changed = true; }
      if (!user.discoveredFish) { user.discoveredFish = []; changed = true; }

      if (changed) { setCurrentUser(user); savePlayerToCloud(user); }
      return user;
    }

    function getEquippedRod(user) {
      return RODS.find(r => r.id === user.equippedRod) || RODS[0];
    }

    // --- GENERATOR WITH LOCATION ---
    // UPDATED: Now multiplies value by the location multiplier
    function generateFish(locationTable, luckMultiplier = 1.0, locationName) {
      const adjustedTable = locationTable.map(item => {
        let weight = item.chanceWeight;
        if (item.rarity !== 'trash' && item.rarity !== 'common') { weight = weight * luckMultiplier; }
        return { ...item, activeWeight: weight };
      });
      const totalW = adjustedTable.reduce((sum, item) => sum + item.activeWeight, 0);
      let r = Math.random() * totalW;
      let species = adjustedTable[0];
      for (const item of adjustedTable) { if ((r -= item.activeWeight) <= 0) { species = item; break; } }
      const weightRaw = species.minKg + Math.random() * (species.maxKg - species.minKg);
      const weight = parseFloat(weightRaw.toFixed(2));
      let sizeLabel = "";
      const percent = (weight - species.minKg) / (species.maxKg - species.minKg);
      if (percent > 0.90) sizeLabel = "Giant";
      else if (percent > 0.70) sizeLabel = "Big";

      let mut = mutations[0]; 
      const rollRare = Math.random();
      if (rollRare < 0.01 * luckMultiplier) mut = mutations.find(m => m.name === "Mythical");
      else if (rollRare < 0.03 * luckMultiplier) mut = mutations.find(m => m.name === "Albino");
      else if (rollRare < 0.07 * luckMultiplier) mut = mutations.find(m => m.name === "Sparkling");
      else if (rollRare < 0.15 * luckMultiplier) mut = mutations.find(m => m.name === "Shiny");
      else mut = mutations[0];

      let sizeMult = 1.0;
      if (sizeLabel === "Giant") sizeMult = 2.0;
      else if (sizeLabel === "Big") sizeMult = 1.2;

      // --- NEW LOGIC: Apply Location Multiplier ---
      const locConfig = LOCATION_CONFIG[locationName] || LOCATION_CONFIG.pond;
      const locMult = locConfig.mult || 1.0;

      let val = Math.ceil(weight * species.pricePerKg * mut.mult * sizeMult * locMult);
      
      return {
        name: species.name, type: species.type, rarity: species.rarity,
        weight: weight, mutation: mut.name, size: sizeLabel, value: val,
        favorite: false, origin: locationName, img: species.img
      };
    }

    /* --- GLOBAL UI ELEMENTS --- */
    const overlay = document.getElementById('overlay');
    const profileOverlay = document.getElementById('profileOverlay');
    const startButton = document.getElementById('startButton');
    const signinLink = document.getElementById('signinLink');
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    const gameContainer = document.getElementById('gameContainer');
    const mainContent = document.getElementById('mainContent');
    const adminPanel = document.getElementById('adminPanel');
    const adminResetBtn = document.getElementById('adminResetBtn');

    document.getElementById('showSignup').onclick = () => { signinForm.style.display='none'; signupForm.style.display='block'; };
    document.getElementById('showSignin').onclick = () => { signupForm.style.display='none'; signinForm.style.display='block'; };
    const openModal = () => overlay.style.display = 'flex';
    signinLink.onclick = openModal;
    startButton.onclick = openModal;
    overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
    document.getElementById('closeProfileBtn').onclick = () => profileOverlay.style.display = 'none';
    profileOverlay.onclick = (e) => { if (e.target === profileOverlay) profileOverlay.style.display = 'none'; };

    // --- HUD ---
    function renderHudHTML() { return `<div class="hud" id="hudEl">Loading...</div>`; }
    function updateHud() {
      const u = getCurrentUser();
      const el = document.getElementById('hudEl');
      if (u && el) {
        const xpCurrent = u.xp || 0;
        const xpNeeded = u.level * 100;
        const pct = Math.min(100, Math.max(0, (xpCurrent / xpNeeded) * 100));
        const items = u.items ? u.items.length : 0;
        const max = u.maxItems || 15;
        const bagColor = items >= max ? '#ff7a7a' : '#aaa';
        el.innerHTML = `
          <div class="hud-row">
            <span style="font-weight:bold; color:#fff;">üë§ ${u.username}</span>
            <span style="font-weight:bold; color:#ffd700;">üí∞ ${u.coins}</span>
            <span style="font-weight:bold; color:#a06cd5;">‚≠ê ${u.level}</span>
          </div>
          <div class="xp-container"><div class="xp-fill" style="width:${pct}%"></div></div>
          <div style="font-size:0.7rem; color:#aaa; text-align:center; margin-top:4px;">${xpCurrent} / ${xpNeeded} XP</div>
          <div style="font-size:0.75rem; color:${bagColor}; text-align:right; margin-top:4px;">üéí ${items}/${max}</div>
        `;
      }
    }

    /* --- HOME / PASSIVE CALCULATION --- */
    // UPDATED: Now uses LOCATION_CONFIG to determine multiplier
    function calculatePassive(user) {
      const now = Date.now();
      const diffHours = (now - (user.home.lastClaim || now)) / (1000 * 60 * 60);
      let ratePerHour = 0;
      if(user.home && user.home.slots) {
        user.home.slots.forEach(slot => {
          if (slot.unlocked && slot.fish) {
            const baseRate = PASSIVE_RATES[slot.fish.rarity] || 5;
            const mutObj = mutations.find(m => m.name === slot.fish.mutation) || mutations[0];
            
            // Look up multiplier in config, fallback to pond (1.0)
            const locName = slot.fish.origin || 'pond';
            const locConfig = LOCATION_CONFIG[locName] || LOCATION_CONFIG.pond;
            const locMult = locConfig.mult || 1.0;
            
            ratePerHour += Math.ceil(baseRate * mutObj.mult * locMult);
          }
        });
      }
      return { rate: ratePerHour, pending: Math.floor(ratePerHour * diffHours) };
    }

    function renderHome() {
      let u = getCurrentUser(); u = initUserData(u);
      const passive = calculatePassive(u);
      const slotsHTML = u.home.slots.map(slot => {
        if (!slot.unlocked) {
          const cost = SLOT_COSTS[slot.id];
          const prevUnlocked = (slot.id === 0) || u.home.slots[slot.id - 1].unlocked;
          const lockClass = prevUnlocked ? "slot-locked" : "slot-locked slot-locked-disabled";
          return `<div class="home-slot ${lockClass}" onclick="window.unlockHomeSlot(${slot.id})"><div class="lock-icon">üîí</div><div class="lock-cost">${cost}g</div></div>`;
        } else if (slot.fish) {
          const fish = slot.fish;
          const mutClass = fish.mutation !== "Normal" ? `mut-${fish.mutation}` : "";
          const txtClass = fish.mutation !== "Normal" ? `txt-${fish.mutation}` : "";
          
          // Display Logic repeated here for UI
          const baseRate = PASSIVE_RATES[fish.rarity] || 5;
          const mutObj = mutations.find(m => m.name === fish.mutation) || mutations[0];
          const locName = fish.origin || 'pond';
          const locConfig = LOCATION_CONFIG[locName] || LOCATION_CONFIG.pond;
          const locMult = locConfig.mult || 1.0;

          const rate = Math.ceil(baseRate * mutObj.mult * locMult);
          return `<div class="home-slot slot-occupied ${mutClass}" onclick="window.removeFishFromSlot(${slot.id})">${getEntityIcon(fish)}<div class="slot-fish-name ${txtClass}">${fish.name}</div><div class="slot-fish-val">${rate}g/hr</div></div>`;
        } else {
          return `<div class="home-slot" onclick="window.openFishSelector(${slot.id})"><div style="font-size:1.5rem; opacity:0.5;">+</div><div style="font-size:0.8rem; opacity:0.7;">Empty</div></div>`;
        }
      }).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üè† Home Aquarium</h2><div class="home-header"><div class="passive-info">Generated: <b>${passive.pending}g</b> <span style="opacity:0.7">(${passive.rate}g/hr)</span></div><button class="claim-btn" id="claimBtn" ${passive.pending <= 0 ? 'disabled' : ''}>Claim Gold</button></div><div class="slot-grid">${slotsHTML}</div>`;
      updateHud();
      document.getElementById('claimBtn').onclick = claimPassiveGold;
    }

    window.unlockHomeSlot = function(id) {
      const u = getCurrentUser(); const cost = SLOT_COSTS[id];
      if (u.coins >= cost) { if(confirm(`Unlock Slot ${id+1} for ${cost} gold?`)) { u.coins -= cost; u.home.slots[id].unlocked = true; setCurrentUser(u); savePlayerToCloud(u); renderHome(); } } else { alert("Not enough gold!"); }
    };
    window.removeFishFromSlot = function(slotId) { const u = getCurrentUser(); const fish = u.home.slots[slotId].fish; if (!fish) return; u.items.push(fish); u.home.slots[slotId].fish = null; setCurrentUser(u); savePlayerToCloud(u); renderHome(); };
    
    // UPDATED: Fish Selector uses new calc logic
    window.openFishSelector = function(slotId) {
      const u = getCurrentUser(); 
      let validFish = u.items.map((item, idx) => {
        const baseRate = PASSIVE_RATES[item.rarity] || 5; 
        const mutObj = mutations.find(m => m.name === item.mutation) || mutations[0]; 
        
        const locName = item.origin || 'pond';
        const locConfig = LOCATION_CONFIG[locName] || LOCATION_CONFIG.pond;
        const locMult = locConfig.mult || 1.0;

        const rate = Math.ceil(baseRate * mutObj.mult * locMult);
        return { ...item, originalIdx: idx, calculatedRate: rate };
      }).filter(i => i.type === 'fish');
      validFish.sort((a, b) => b.calculatedRate - a.calculatedRate);
      let listHTML = validFish.length === 0 ? "<p>No fish in backpack.</p>" : validFish.map(f => `<div class="bp-item" style="width:300px; flex-direction:row; justify-content:space-between; margin:5px auto;"><div>${getEntityIcon(f)}</div><div style="text-align:left;"><b>${f.name}</b><br><small>${f.calculatedRate}g/hr</small></div><button class="btn-sm" style="background:#5bc0be" onclick="window.placeFish(${slotId}, ${f.originalIdx})">Select</button></div>`).join('');
      const selOverlay = document.createElement('div'); selOverlay.className = "selector-overlay"; selOverlay.innerHTML = `<button class="selector-close" id="closeSel">Close</button><h3>Select a Fish</h3><div style="overflow-y:auto; max-height:400px; width:100%;">${listHTML}</div>`; mainContent.appendChild(selOverlay); document.getElementById('closeSel').onclick = () => renderHome();
    };
    window.placeFish = function(sId, itemIdx) { const u = getCurrentUser(); const fishToMove = u.items[itemIdx]; if(!fishToMove) { renderHome(); return; } u.items.splice(itemIdx, 1); u.home.slots[sId].fish = fishToMove; setCurrentUser(u); savePlayerToCloud(u); renderHome(); };
    function claimPassiveGold() { const u = getCurrentUser(); const passive = calculatePassive(u); if (passive.pending > 0) { u.coins += passive.pending; u.home.lastClaim = Date.now(); setCurrentUser(u); savePlayerToCloud(u); renderHome(); } }

    /* --- FISHING SPOT --- */
    function renderFishingSpot() {
      const u = getCurrentUser();
      const currentRod = getEquippedRod(u);
      const streamUnlocked = u.unlockedLocations.includes("stream");
      let streamBtnHTML = streamUnlocked ? `<button class="location-btn" onclick="window.renderStream()">üåä Stream</button>` : (u.level < 5 ? `<button class="location-btn btn-locked" disabled>üîí Stream (Lv 5)</button>` : `<button class="location-btn btn-locked" onclick="window.unlockStream()">üîí Unlock Stream (2500g)</button>`);
      mainContent.innerHTML = `${renderHudHTML()}<h2>üé£ Fishing Spot</h2><p>Using: <b>${currentRod.icon} ${currentRod.name}</b></p><button class="location-btn" onclick="window.renderPond()">üêü Pond</button>${streamBtnHTML}`;
      updateHud();
    }
    window.unlockStream = function() { const u = getCurrentUser(); if(u.coins >= 2500) { if(confirm("Unlock Stream for 2500g?")) { u.coins -= 2500; u.unlockedLocations.push("stream"); setCurrentUser(u); savePlayerToCloud(u); renderFishingSpot(); } } else { alert("Not enough gold!"); } };
    window.renderPond = function() { mainContent.innerHTML = `${renderHudHTML()}<div class="pond-wrap"><div class="pond-header"><button class="back-inline" onclick="window.renderFishingSpot()">‚Üê Back</button><h2>üêü Pond</h2></div><div class="game-bar-container" id="gameBarContainer"><div class="game-bar-fill" id="gameBarFill"></div></div><div class="status" id="pondStatus">Scanning water...</div><div class="wait-bar" id="waitBar"><div class="wait-fill" id="waitFill"></div></div><div class="minigame-area" id="minigameArea"></div><button id="castBtn" onclick="window.handleCast('pond')">Cast Line</button></div>`; };
    window.renderStream = function() { mainContent.innerHTML = `${renderHudHTML()}<div class="pond-wrap"><div class="pond-header"><button class="back-inline" onclick="window.renderFishingSpot()">‚Üê Back</button><h2>üåä Stream</h2></div><div class="game-bar-container" id="gameBarContainer"><div class="game-bar-fill" id="gameBarFill"></div></div><div class="status" id="pondStatus">Current flows gently...</div><div class="wait-bar" id="waitBar"><div class="wait-fill" id="waitFill"></div></div><div class="minigame-area" id="minigameArea"></div><button id="castBtn" onclick="window.handleCast('stream')">Cast Line</button></div>`; };

    window.handleCast = function(locationType) {
      const u = getCurrentUser(); const rod = getEquippedRod(u);
      if (u.items.length >= (u.maxItems || 15)) return alert("Backpack full!");
      const waitFill = document.getElementById('waitFill'); document.getElementById('waitBar').style.display = 'block'; document.getElementById('castBtn').disabled = true;
      setTimeout(() => waitFill.style.width = '100%', 50);
      setTimeout(() => {
        document.getElementById('waitBar').style.display = 'none';
        const hookedFish = generateFish(locationType === 'stream' ? streamTable : pondTable, rod.luck, locationType);
        startMinigame(hookedFish);
      }, (1000 + Math.random() * 2000) / rod.speed);
    };

    /* --- MINIGAME --- */
    let minigameActive = false; let minigameProgress = 35; let spawnTimer = null; let gameLoop = null;
    function startMinigame(fish) {
      const area = document.getElementById('minigameArea'); const barFill = document.getElementById('gameBarFill');
      area.style.display = 'block'; document.getElementById('gameBarContainer').style.display = 'block'; document.getElementById('castBtn').style.display = 'none';
      minigameActive = true; minigameProgress = 35; barFill.style.width = '35%'; area.innerHTML = '';
      spawnTimer = setInterval(() => { if(!minigameActive) return; spawnCircle(area, difficultyMap[fish.rarity] || 2000); }, 800);
      gameLoop = requestAnimationFrame(function step() { if (!minigameActive) return; if (minigameProgress <= 0) { endMinigame(false, fish); return; } if (minigameProgress >= 100) { endMinigame(true, fish); return; } requestAnimationFrame(step); });
    }
    function spawnCircle(container, duration) {
      const size = 50; const x = 10 + Math.random() * (container.clientWidth - size - 20); const y = 10 + Math.random() * (container.clientHeight - size - 20);
      const target = document.createElement('div'); target.className = 'target-circle'; target.style.left = x + 'px'; target.style.top = y + 'px';
      const ring = document.createElement('div'); ring.className = 'target-ring'; ring.style.left = x + 'px'; ring.style.top = y + 'px';
      ring.style.transition = `width ${duration}ms linear, height ${duration}ms linear`; container.appendChild(target); container.appendChild(ring);
      requestAnimationFrame(() => { ring.style.width = '50px'; ring.style.height = '50px'; });
      let clicked = false;
      target.onmousedown = (e) => { e.stopPropagation(); if(clicked) return; clicked = true; minigameProgress += 15; document.getElementById('gameBarFill').style.width = minigameProgress+'%'; remove(); };
      setTimeout(() => { if (!clicked && document.body.contains(target)) { minigameProgress -= 10; document.getElementById('gameBarFill').style.width = minigameProgress+'%'; remove(); } }, duration);
      function remove() { if(target.parentNode) target.parentNode.removeChild(target); if(ring.parentNode) ring.parentNode.removeChild(ring); }
    }

    // UPDATED: Now multiplies XP gain by the location XP multiplier
    function endMinigame(won, fish) {
      minigameActive = false; clearInterval(spawnTimer); cancelAnimationFrame(gameLoop);
      const statusEl = document.getElementById('pondStatus'); document.getElementById('minigameArea').style.display = 'none'; document.getElementById('gameBarContainer').style.display = 'none'; const btn = document.getElementById('castBtn'); btn.style.display = 'block'; btn.disabled = false;
      if (won) {
        const u = getCurrentUser(); u.items.push(fish);
        // INDEX LOGIC: ADD TO DISCOVERED
        if (!u.discoveredFish.includes(fish.name)) { u.discoveredFish.push(fish.name); }
        
        // --- NEW LOGIC: XP Multiplier ---
        const locName = fish.origin || 'pond';
        const locConfig = LOCATION_CONFIG[locName] || LOCATION_CONFIG.pond;
        const xpMult = locConfig.xpMult || 1.0;
        const baseXP = XP_RATES[fish.rarity] || 1;
        
        u.xp = (u.xp || 0) + Math.ceil(baseXP * xpMult);

        if (u.xp >= u.level * 100) { u.xp -= u.level * 100; u.level++; u.coins += u.level * 50; }
        setCurrentUser(u); savePlayerToCloud(u); updateHud(); statusEl.textContent = `Caught a ${fish.name}!`;
      } else { statusEl.textContent = "It got away..."; }
    }

    /* --- BACKPACK & MARKET --- */
    function renderBackpack() {
      const u = getCurrentUser(); const items = u.items || [];
      let gridHTML = items.map((item, idx) => `<div class="bp-item ${item.mutation!=='Normal'?`mut-${item.mutation}`:''}"><button class="star-btn ${item.favorite?'fav-active':''}" onclick="window.toggleFav(${idx})">${item.favorite?'‚òÖ':'‚òÜ'}</button>${getEntityIcon(item)}<div class="${item.mutation!=='Normal'?`txt-${item.mutation}`:''}"><b>${item.size} ${item.name}</b><br>${item.weight}kg ¬∑ ${item.value}g</div></div>`).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üéí Backpack (${items.length}/${u.maxItems})</h2><div class="bp-grid">${gridHTML || 'Empty'}</div>`; updateHud();
    }
    window.toggleFav = function(i) { const u = getCurrentUser(); u.items[i].favorite = !u.items[i].favorite; setCurrentUser(u); savePlayerToCloud(u); renderBackpack(); };
    function renderMarket() {
      const u = getCurrentUser(); const profit = u.items.filter(i => !i.favorite).reduce((s, i) => s + i.value, 0);
      let gridHTML = u.items.map((item, idx) => `<div class="bp-item"><div class="${item.mutation!=='Normal'?`txt-${item.mutation}`:''}"><b>${item.name}</b><br>${item.value}g</div><button class="market-sell-btn" onclick="window.sellOne(${idx})" ${item.favorite?'disabled':''}>${item.favorite?'‚òÖ':'Sell'}</button></div>`).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üè™ Market</h2><button class="sell-all-btn" onclick="window.sellAll()">Sell All (${profit}g)</button><div class="bp-grid">${gridHTML}</div>`; updateHud();
    }
    window.sellOne = function(i) { const u = getCurrentUser(); u.coins += u.items[i].value; u.items.splice(i, 1); setCurrentUser(u); savePlayerToCloud(u); renderMarket(); };
    window.sellAll = function() { const u = getCurrentUser(); const sold = u.items.filter(i => !i.favorite); u.coins += sold.reduce((s,i) => s + i.value, 0); u.items = u.items.filter(i => i.favorite); setCurrentUser(u); savePlayerToCloud(u); renderMarket(); };

    /* --- INDEX (UPDATED WITH TABS) --- */
    window.renderIndex = function(filterType = 'all') {
      const u = getCurrentUser();
      
      // 1. Prepare lists with origin tags
      const pondItems = pondTable.map(i => ({...i, _origin: 'pond'}));
      const streamItems = streamTable.map(i => ({...i, _origin: 'stream'}));
      
      let displayList = [];

      // 2. Filter Logic
      if (filterType === 'pond') {
        displayList = pondItems;
      } else if (filterType === 'stream') {
        displayList = streamItems;
      } else {
        // 'all': Merge and remove duplicates (by name)
        const combined = [...pondItems, ...streamItems];
        displayList = combined.filter((v, i, a) => a.findIndex(t => t.name === v.name) === i);
      }

      // 3. Generate Tab Buttons HTML
      const tabs = ['all', 'pond', 'stream'];
      const tabsHTML = tabs.map(t => {
        const isActive = t === filterType ? 'active' : '';
        const label = t.charAt(0).toUpperCase() + t.slice(1);
        return `<button class="tab-btn ${isActive}" onclick="window.renderIndex('${t}')">${label}</button>`;
      }).join('');

      // 4. Generate Card Grid
      const gridHTML = displayList.map(item => {
        const isUnlocked = u.discoveredFish.includes(item.name);
        const cardClass = isUnlocked ? "index-card unlocked" : "index-card";
        const name = isUnlocked ? item.name : "???";
        const rarity = isUnlocked ? item.rarity : "Unknown";
        
        return `
          <div class="${cardClass}">
            ${getEntityIcon(item)}
            <div class="index-name">${name}</div>
            <div class="index-rarity" style="color:${isUnlocked?'#5bc0be':'#555'}">${rarity}</div>
          </div>`;
      }).join('');

      // 5. Calculate Total Discovery Count (Global)
      const uniqueAll = [...pondItems, ...streamItems].filter((v, i, a) => a.findIndex(t => t.name === v.name) === i);
      const discoveredCount = u.discoveredFish.length;
      const totalCount = uniqueAll.length;

      mainContent.innerHTML = `
        ${renderHudHTML()}
        <h2>üìñ Fish Index</h2>
        <div class="index-tabs">${tabsHTML}</div>
        <p style="margin-top:0;">Global Discovery: ${discoveredCount} / ${totalCount} species</p>
        <div class="index-grid">${gridHTML}</div>
      `;
      updateHud();
    };

    /* --- ROD SHOP --- */
    function renderShop() {
      const u = getCurrentUser();
      const upgradeCost = (u.maxItems || 15) * 50;
      const upgradeHTML = `<div class="bp-item upgrade-item"><h3>Expand Bag</h3><p>${u.maxItems} -> ${u.maxItems+5}</p><button class="shop-btn btn-buy" onclick="window.buyBag()">Buy ${upgradeCost}g</button></div>`;
      const rodsHTML = RODS.map(r => {
        const owned = u.ownedRods.includes(r.id); const eq = u.equippedRod === r.id;
        let btn = eq ? `<button class="shop-btn btn-owned">Equipped</button>` : (owned ? `<button class="shop-btn btn-equip" onclick="window.eqRod(${r.id})">Equip</button>` : `<button class="shop-btn btn-buy" onclick="window.buyRod(${r.id})">${r.cost}g</button>`);
        return `<div class="bp-item"><h3>${r.icon} ${r.name}</h3><p>${r.luck}x Luck</p>${btn}</div>`;
      }).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üõí Rod Shop</h2><div class="bp-grid">${upgradeHTML}${rodsHTML}</div>`; updateHud();
    }
    window.buyBag = function() { const u = getCurrentUser(); const c = u.maxItems * 50; if(u.coins >= c) { u.coins -= c; u.maxItems += 5; setCurrentUser(u); savePlayerToCloud(u); renderShop(); } };
    window.buyRod = function(id) { const u = getCurrentUser(); const r = RODS[id]; if(u.coins >= r.cost) { u.coins -= r.cost; u.ownedRods.push(id); u.equippedRod = id; setCurrentUser(u); savePlayerToCloud(u); renderShop(); } };
    window.eqRod = function(id) { const u = getCurrentUser(); u.equippedRod = id; setCurrentUser(u); savePlayerToCloud(u); renderShop(); };

    async function renderLeaderboard() {
      mainContent.innerHTML = `${renderHudHTML()}<h2>üèÜ Leaderboard</h2><p>Loading...</p>`;
      const p = await getAllPlayers(); p.sort((a,b) => b.level - a.level);
      const rows = p.slice(0, 10).map((u, i) => `<div class="lb-row"><div>#${i+1} ${u.username}</div><div>Lv ${u.level}</div></div>`).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üèÜ Leaderboard</h2><div class="lb-list">${rows}</div>`; updateHud();
    }

    /* --- ADMIN & CONTROLS --- */
    function startGame(user) { overlay.style.display = 'none'; title.style.display = 'none'; startButton.style.display = 'none'; signinLink.style.display = 'none'; gameContainer.style.display = 'flex'; if(user.username==="Llama"){adminPanel.style.display='block';adminResetBtn.style.display='block';} renderHome(); }
    document.getElementById('loginButton').onclick = async () => { 
      const u = document.getElementById('signin-username').value.trim(); const p = document.getElementById('signin-password').value.trim();
      if(u==="Llama" && p==="Helloworld") { const master = { username: "Llama", coins: 0, level: 1, items: [] }; setCurrentUser(master); startGame(master); return; }
      const snap = await getDoc(doc(db, "players", u)); if(snap.exists() && snap.data().password === p) { setCurrentUser(snap.data()); startGame(snap.data()); } else { alert("Error"); }
    };
    document.getElementById('signupButton').onclick = async () => {
      const u = document.getElementById('signup-username').value.trim(); const p = document.getElementById('signup-password').value.trim(); const e = document.getElementById('signup-email').value.trim();
      const newUser = { username: u, password: p, email: e, coins: 0, level: 1, items: [], discoveredFish: [] }; await savePlayerToCloud(newUser); alert("Created!"); location.reload();
    };
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('currentUser'); location.reload(); };
    document.getElementById('homeBtn').onclick = renderHome;
    document.getElementById('fishingSpotBtn').onclick = renderFishingSpot;
    document.getElementById('backpackBtn').onclick = renderBackpack;
    document.getElementById('marketBtn').onclick = renderMarket;
    document.getElementById('shopBtn').onclick = renderShop;
    
    // UPDATED: Calls renderIndex with default 'all'
    document.getElementById('indexBtn').onclick = () => window.renderIndex('all');
    
    document.getElementById('leaderboardBtn').onclick = renderLeaderboard;

    (async function() { const s = getCurrentUser(); if(s) startGame(s); })();
  </script>
</body>
</html>
