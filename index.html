<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fishing Idly - Base</title>
  <style>
    /* --- 1. Global Reset & Theme --- */
    body {
      background-color: #1b2735;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      margin: 0; 
      height: 100vh; 
      overflow: hidden; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
    }
    
    h1 { font-size: 3rem; margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 3px; }
    
    button {
      background-color: #3a506b; color: #fff; border: none; padding: 1rem 2rem;
      font-size: 1.1rem; border-radius: 10px; cursor: pointer; transition: background-color .2s;
    }
    button:hover { background-color: #5bc0be; color:#1b2735; }
    button:disabled { background-color: #2b394d; color: #9aa7b7; cursor: not-allowed; }

    /* --- 2. Landing Page Elements --- */
    .signin-top { position: absolute; top: 20px; right: 30px; background: #3a506b; color:#e0e0e0; padding:.5rem 1rem; border-radius:8px; text-decoration:none; }
    .overlay { position: fixed; inset:0; background: rgba(0,0,0,.65); display:flex; justify-content:center; align-items:center; z-index: 20; }
    .signin-box {
      background: linear-gradient(135deg, #2a3d56, #3a506b);
      padding: 2rem; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,.4);
      width: 300px; text-align:center; transform: scale(.8); opacity: 0; animation: pop .3s forwards;
    }
    .signin-box input { width: 90%; padding: .7rem; margin: .5rem 0; border: none; border-radius: 8px; outline: none; background:#1b2735; color:#e0e0e0; }
    .toggle-link { display:block; margin-top:1rem; color:#9ad4d6; cursor:pointer; text-decoration:underline; font-size:.9rem; }
    @keyframes pop { to { transform: scale(1); opacity: 1; } }

    /* --- 3. Game Layout --- */
    .game-container { 
      display: none; width: 100%; height: 100vh; flex-direction: row; background-color: #1b2735; 
    }

    /* Sidebar */
    .sidebar {
      width: 240px; background: #2a3d56; display: flex; flex-direction: column; 
      justify-content: space-between; align-items: center; padding: 16px 10px; border-right: 2px solid #5bc0be;
      box-sizing: border-box;
    }
    .nav-buttons { display: flex; flex-direction: column; align-items: center; width: 100%; }
    .nav-buttons button { width: 95%; margin: 6px 0; background: #3a506b; font-size: 0.95rem; padding: 0.8rem; text-align: left; }
    .nav-buttons button:hover { background: #5bc0be; color: #1b2735; }

    /* Admin Panel Styles (Sidebar) */
    .admin-panel {
      width: 95%; background: rgba(0,0,0,.18); border-radius: 10px; 
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; padding: 10px; margin-bottom: 10px; font-size: .9rem;
    }
    .admin-title { font-weight: 700; opacity: .9; margin-bottom: 6px; text-align: center; color: #ff7a7a; }
    .admin-row { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; }
    .btn-sm { padding: .3rem .6rem; border-radius: 6px; font-size: 0.8rem; min-width: auto; }
    .admin-reset-btn { background: #7a1f1b; width: 95%; margin-bottom: 10px; font-size: 0.9rem; padding: 0.6rem; }
    .admin-reset-btn:hover { background: #a52b25; }

    .logout-btn { background: #b0413e; width: 95%; font-size: 0.9rem; padding: 0.6rem; }
    .logout-btn:hover { background: #e24e4b; }

    /* Main Content */
    .main-content { 
      flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; 
      text-align: center; padding: 30px; position: relative; 
    }
    .hud {
      position: absolute; top: 12px; right: 16px;
      background: rgba(0,0,0,.35); padding: 8px 12px; border-radius: 10px; font-size: .95rem;
      box-shadow: 0 0 0 1px rgba(255,255,255,.08) inset;
      z-index: 10;
    }

    /* Pond & Location Styles */
    .pond-wrap { max-width: 640px; width: 100%; }
    .pond-header { position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }
    .back-inline { position: absolute; left: 0; padding: .5rem 1rem; border-radius: 8px; font-size: 0.9rem; }
    .location-btn { margin: 10px; width: 200px; }
    .status { margin: 10px 0 20px; font-size: 1.1rem; min-height: 1.5em; color: #9ad4d6; }
    
    /* Progress Bar for Casting */
    .progress {
      position: relative; height: 12px; width: 100%; max-width: 400px; background: #0f1824;
      border-radius: 8px; overflow: hidden; margin: 0 auto 20px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.1);
      display: none; /* Hidden by default */
    }
    .progress-fill { height: 100%; width: 0%; background: #5bc0be; transition: width 0.1s linear; }

    /* Rarity Colors for Text */
    .rarity-common { color: #e0e0e0; }
    .rarity-uncommon { color: #5bc0be; font-weight: bold; }
    .rarity-rare { color: #5084cc; font-weight: bold; }
    .rarity-epic { color: #b850cc; font-weight: bold; }
    .rarity-legendary { color: #ffd700; font-weight: bold; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
    .rarity-trash { color: #888; }

  </style>
</head>
<body>

  <!-- Landing -->
  <a href="#" class="signin-top" id="signinLink">Sign In</a>
  <h1 id="title">Fishing Idly</h1>
  <button id="startButton">Start</button>

  <!-- Login Modal -->
  <div class="overlay" id="overlay" style="display:none;">
    <div class="signin-box">
      <div id="signinForm">
        <h2>Sign In</h2>
        <input type="text" id="signin-username" placeholder="Username"/>
        <input type="password" id="signin-password" placeholder="Password"/>
        <button id="loginButton">Log In</button>
        <span class="toggle-link" id="showSignup">Don‚Äôt have an account? Sign Up</span>
      </div>
      <div id="signupForm" style="display:none;">
        <h2>Create Account</h2>
        <input type="email" id="signup-email" placeholder="Email"/>
        <input type="text" id="signup-username" placeholder="Username"/>
        <input type="password" id="signup-password" placeholder="Password"/>
        <button id="signupButton">Sign Up</button>
        <span class="toggle-link" id="showSignin">Already have an account? Sign In</span>
      </div>
    </div>
  </div>

  <!-- Game UI -->
  <div class="game-container" id="gameContainer">
    
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="nav-buttons">
        <button id="homeBtn">üè† Home</button>
        <button id="fishingSpotBtn">üé£ Fishing Spot</button>
        <button id="backpackBtn">üéí Backpack</button>
        <button id="shopBtn">üõí Shop</button>
        <button id="leaderboardBtn">üèÜ Leaderboard</button>
      </div>
      
      <!-- Admin Panel (Hidden by default) -->
      <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
        <div id="adminPanel" class="admin-panel" style="display:none;">
          <div class="admin-title">ADMIN TOOLS</div>
          <div class="admin-row">
            <span>Level</span>
            <div>
              <button class="btn-sm" id="admLvlDown">-</button>
              <button class="btn-sm" id="admLvlUp">+</button>
            </div>
          </div>
          <div class="admin-row">
            <span>Gold</span>
            <div>
              <button class="btn-sm" id="admGoldDown">-</button>
              <button class="btn-sm" id="admGoldUp">+</button>
            </div>
          </div>
        </div>
        <button class="admin-reset-btn" id="adminResetBtn" style="display:none;">‚ö† Reset All Data</button>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <div id="viewArea"></div>
    </div>

  </div>

  <!-- Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnoFqUUjddA6ipJSisLOS7MsFklhQKt_w",
      authDomain: "fishingidly-c1613.firebaseapp.com",
      projectId: "fishingidly-c1613",
      storageBucket: "fishingidly-c1613.firebasestorage.app",
      messagingSenderId: "531215063717",
      appId: "1:531215063717:web:dea4ce7aa7a64d3f374b4c",
      measurementId: "G-SR67MT90SE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* --- Data Helpers --- */
    function cleanForFirestore(obj) {
      const cleaned = { ...obj };
      Object.keys(cleaned).forEach(key => { if (cleaned[key] === undefined || cleaned[key] === null) delete cleaned[key]; });
      return cleaned;
    }
    function setCurrentUser(user) {
      if (!user) return;
      localStorage.setItem('currentUser', JSON.stringify(cleanForFirestore(user)));
    }
    function getCurrentUser() {
      try { return JSON.parse(localStorage.getItem('currentUser')); } catch { return null; }
    }
    async function savePlayerToCloud(user) {
      if (!user || !user.username) return;
      await setDoc(doc(db, "players", user.username), cleanForFirestore(user), { merge: true });
    }
    async function getAllPlayers() {
      const snap = await getDocs(collection(db, "players"));
      return snap.docs.map(d => d.data());
    }

    /* --- POND FISH DATA --- */
    /* Updated with full list from original game */
    const pondTable = [
      // Common
      { name: "Crappie", type: "fish", weight: 16, rarity: "common", value: 4, minWeight: 0.3, baseWeight: 1.8 },
      { name: "Pumpkinseed", type: "fish", weight: 12, rarity: "common", value: 4, minWeight: 0.2, baseWeight: 1.0 },
      { name: "Yellow Perch", type: "fish", weight: 12, rarity: "common", value: 4, minWeight: 0.3, baseWeight: 1.2 },
      
      // Uncommon
      { name: "Bluegill", type: "fish", weight: 9, rarity: "uncommon", value: 6, minWeight: 0.1, baseWeight: 0.8 },
      { name: "Catfish", type: "fish", weight: 7, rarity: "uncommon", value: 8, minWeight: 1.0, baseWeight: 6.0 },
      { name: "Carp", type: "fish", weight: 4, rarity: "uncommon", value:10, minWeight: 2.0, baseWeight: 15.0 },
      
      // Rare
      { name: "Goldfish", type: "fish", weight: 10, rarity: "rare", value:15, minWeight: 0.1, baseWeight: 0.6 },
      
      // Epic
      { name: "Largemouth Bass", type: "fish", weight: 4, rarity: "epic", value:20, minWeight: 1.0, baseWeight: 4.5 },
      
      // Legendary
      { name: "Golden Koi", type: "fish", weight: 1, rarity: "legendary", value:40, minWeight: 4.0, baseWeight: 25.0 },
      
      // Trash (Weight 5 each)
      { name: "Old Boot", type: "trash", weight: 5, value: 1, rarity: "trash" },
      { name: "Tin Can", type: "trash", weight: 5, value: 1, rarity: "trash" },
      { name: "Tangled Line", type: "trash", weight: 5, value: 1, rarity: "trash" },
      { name: "Broken Glass", type: "trash", weight: 5, value: 1, rarity: "trash" },
      { name: "Rusty Hook", type: "trash", weight: 5, value: 1, rarity: "trash" }
    ];

    function pickRandomFish() {
      // Calculate total weight
      const totalWeight = pondTable.reduce((sum, item) => sum + item.weight, 0);
      let random = Math.random() * totalWeight;
      for (const item of pondTable) {
        if ((random -= item.weight) <= 0) return item;
      }
      return pondTable[0];
    }

    /* --- UI & Logic --- */
    const overlay = document.getElementById('overlay');
    const startButton = document.getElementById('startButton');
    const signinLink = document.getElementById('signinLink');
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    const gameContainer = document.getElementById('gameContainer');
    const mainContent = document.getElementById('mainContent');

    // Admin Elements
    const adminPanel = document.getElementById('adminPanel');
    const adminResetBtn = document.getElementById('adminResetBtn');

    // Toggle Forms
    document.getElementById('showSignup').onclick = () => { signinForm.style.display='none'; signupForm.style.display='block'; };
    document.getElementById('showSignin').onclick = () => { signupForm.style.display='none'; signinForm.style.display='block'; };
    
    // Modal
    const openModal = () => overlay.style.display = 'flex';
    signinLink.onclick = openModal;
    startButton.onclick = openModal;
    overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };

    /* --- HUD Logic --- */
    function renderHudHTML() {
      // Returns HTML for the HUD
      return `<div class="hud" id="hudEl">Loading...</div>`;
    }

    function updateHud() {
      const u = getCurrentUser();
      const el = document.getElementById('hudEl');
      if (u && el) {
        el.innerHTML = `üë§ <b>${u.username}</b> ¬∑ üí∞ ${u.coins} ¬∑ ‚≠ê Lv ${u.level}`;
      }
    }

    /* --- Render Pages --- */
    function renderHome() {
      const u = getCurrentUser();
      mainContent.innerHTML = `
        ${renderHudHTML()}
        <h2>üè† Home</h2>
        <p>Welcome back, <b>${u.username}</b>.</p>
        <p>Select "Fishing Spot" to catch some fish!</p>
      `;
      updateHud();
    }

    function renderFishingSpot() {
      mainContent.innerHTML = `
        ${renderHudHTML()}
        <h2>üé£ Fishing Spot</h2>
        <p>Select a location:</p>
        <button class="location-btn" id="enterPondBtn">üêü Pond</button>
        <button class="location-btn" disabled>üåä Stream (Locked)</button>
      `;
      updateHud();
      document.getElementById('enterPondBtn').onclick = renderPond;
    }

    function renderPond() {
      mainContent.innerHTML = `
        ${renderHudHTML()}
        <div class="pond-wrap">
          <div class="pond-header">
            <button class="back-inline" id="backToSpot">‚Üê Back</button>
            <h2>üêü Pond</h2>
          </div>
          <div class="status" id="pondStatus">The water is calm...</div>
          <div class="progress" id="castProgress"><div class="progress-fill" id="castFill"></div></div>
          <button id="castBtn" style="min-width:150px;">Cast Line</button>
        </div>
      `;
      updateHud();
      
      document.getElementById('backToSpot').onclick = renderFishingSpot;
      document.getElementById('castBtn').onclick = handleCast;
    }

    function renderBackpack() {
      mainContent.innerHTML = `
        ${renderHudHTML()}
        <h2>üéí Backpack</h2>
        <p>Inventory logic goes here.</p>
      `;
      updateHud();
    }

    function renderShop() {
      mainContent.innerHTML = `
        ${renderHudHTML()}
        <h2>üõí Shop</h2>
        <p>Store logic goes here.</p>
      `;
      updateHud();
    }

    async function renderLeaderboard() {
      mainContent.innerHTML = `
        ${renderHudHTML()}
        <h2>üèÜ Leaderboard</h2>
        <p>Loading players...</p>
      `;
      updateHud();
      
      const players = await getAllPlayers();
      // Sort by Level desc, then Coins desc
      players.sort((a,b) => (b.level - a.level) || (b.coins - a.coins));
      
      const rows = players.slice(0, 10).map((p, i) => 
        `<div>#${i+1} <b>${p.username}</b> - Lv ${p.level} - ${p.coins}g</div>`
      ).join('');

      mainContent.innerHTML = `
        ${renderHudHTML()}
        <h2>üèÜ Leaderboard</h2>
        <div style="margin-top:20px; text-align:left; background:rgba(0,0,0,0.2); padding:20px; border-radius:10px;">
          ${rows || 'No players found.'}
        </div>
      `;
      updateHud();
    }

    /* --- Fishing Logic --- */
    function handleCast() {
      const statusEl = document.getElementById('pondStatus');
      const progEl = document.getElementById('castProgress');
      const fillEl = document.getElementById('castFill');
      const btn = document.getElementById('castBtn');

      // Disable button
      btn.disabled = true;
      btn.textContent = "Waiting...";
      statusEl.textContent = "Waiting for a bite...";
      
      // Animate Bar
      progEl.style.display = 'block';
      fillEl.style.width = '0%';
      
      // Simple 2-second wait logic
      setTimeout(() => { fillEl.style.width = '100%'; }, 50);

      setTimeout(() => {
        // Catch Logic
        const catchItem = pickRandomFish();
        const user = getCurrentUser();
        
        // Update User
        user.coins += catchItem.value;
        user.items.push(catchItem);
        setCurrentUser(user);
        savePlayerToCloud(user); // Async save
        
        // Update UI
        updateHud();
        
        // Formatting display name with Rarity color
        const rarityClass = `rarity-${catchItem.rarity || 'common'}`;
        const rarityLabel = catchItem.rarity ? `[${catchItem.rarity.charAt(0).toUpperCase() + catchItem.rarity.slice(1)}]` : '';
        
        statusEl.innerHTML = `You caught: <span class="${rarityClass}">${rarityLabel} ${catchItem.name}</span>! (+${catchItem.value}g)`;
        
        // Reset controls
        progEl.style.display = 'none';
        fillEl.style.width = '0%';
        btn.disabled = false;
        btn.textContent = "Cast Again";
        
      }, 2050); // Wait just over 2 seconds
    }

    /* --- Admin Logic --- */
    function renderAdminControls(user) {
      if (user.username === "Llama") {
        adminPanel.style.display = 'block';
        adminResetBtn.style.display = 'block';
      } else {
        adminPanel.style.display = 'none';
        adminResetBtn.style.display = 'none';
      }
    }

    // Admin Button Listeners
    function modifyUser(key, amount) {
      const u = getCurrentUser();
      if (!u) return;
      u[key] = Math.max(0, (u[key] || 0) + amount);
      setCurrentUser(u);
      savePlayerToCloud(u);
      updateHud();
    }
    document.getElementById('admLvlUp').onclick = () => modifyUser('level', 1);
    document.getElementById('admLvlDown').onclick = () => modifyUser('level', -1);
    document.getElementById('admGoldUp').onclick = () => modifyUser('coins', 100);
    document.getElementById('admGoldDown').onclick = () => modifyUser('coins', -100);
    
    document.getElementById('adminResetBtn').onclick = () => {
      if(confirm("‚ö† Reset ALL local data?")) {
        localStorage.removeItem('currentUser');
        location.reload();
      }
    };

    /* --- Auth & Start --- */
    function startGame(user) {
      overlay.style.display = 'none';
      title.style.display = 'none';
      startButton.style.display = 'none';
      signinLink.style.display = 'none';
      gameContainer.style.display = 'flex';
      
      renderAdminControls(user);
      renderHome();
    }

    document.getElementById('loginButton').onclick = async () => {
      const u = document.getElementById('signin-username').value.trim();
      const p = document.getElementById('signin-password').value.trim();

      if (u === "Llama" && p === "Helloworld") {
        const master = { username: "Llama", coins: 99999, level: 100, items: [] };
        setCurrentUser(master);
        startGame(master);
        return;
      }

      const snap = await getDoc(doc(db, "players", u));
      if (!snap.exists()) return alert("User not found.");
      const data = snap.data();
      if (data.password !== p) return alert("Wrong password.");
      
      setCurrentUser(data);
      startGame(data);
    };

    document.getElementById('signupButton').onclick = async () => {
      const u = document.getElementById('signup-username').value.trim();
      const p = document.getElementById('signup-password').value.trim();
      const e = document.getElementById('signup-email').value.trim();
      if(!u || !p || !e) return alert("Fill all fields");

      const snap = await getDoc(doc(db, "players", u));
      if (snap.exists()) return alert("Username taken.");

      const newUser = { username: u, password: p, email: e, coins: 0, level: 1, items: [] };
      await savePlayerToCloud(newUser);
      alert("Created! Log in now.");
      signupForm.style.display='none'; signinForm.style.display='block';
    };

    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('currentUser');
      location.reload();
    };

    /* --- Nav Listeners --- */
    document.getElementById('homeBtn').onclick = renderHome;
    document.getElementById('fishingSpotBtn').onclick = renderFishingSpot;
    document.getElementById('backpackBtn').onclick = renderBackpack;
    document.getElementById('shopBtn').onclick = renderShop;
    document.getElementById('leaderboardBtn').onclick = renderLeaderboard;
    
    // Auto-login
    (async function init() {
      const s = getCurrentUser();
      if (s) startGame(s);
    })();
  </script>
</body>
</html>
