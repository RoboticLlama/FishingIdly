<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fishing Idly - MMO Update</title>
  <style>
    /* --- Global & Layout --- */
    body {
      background-color: #1b2735;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      margin: 0; 
      height: 100vh; 
      overflow: hidden; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
      user-select: none;
      transition: background 1s ease, box-shadow 1s ease;
    }
    
    h1 { font-size: 3rem; margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 3px; }
    
    button {
      background-color: #3a506b; color: #fff; border: none; padding: 1rem 2rem;
      font-size: 1.1rem; border-radius: 10px; cursor: pointer; transition: background-color .2s;
    }
    button:hover { background-color: #5bc0be; color:#1b2735; }
    button:disabled { background-color: #2b394d; color: #9aa7b7; cursor: not-allowed; }

    /* --- PIXEL ART STYLES --- */
    .pixel-icon { width: 64px; height: 64px; object-fit: contain; image-rendering: pixelated; image-rendering: crisp-edges; }
    .emoji-icon { font-size: 2rem; }

    /* --- UI Components --- */
    .overlay { position: fixed; inset:0; background: rgba(0,0,0,.65); display:flex; justify-content:center; align-items:center; z-index: 50; }
    .signin-box {
      background: linear-gradient(135deg, #2a3d56, #3a506b);
      padding: 2rem; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,.4);
      width: 300px; text-align:center; transform: scale(.8); opacity: 0; animation: pop .3s forwards;
    }
    .signin-box input { width: 90%; padding: .7rem; margin: .5rem 0; border: none; border-radius: 8px; outline: none; background:#1b2735; color:#e0e0e0; }
    .toggle-link { display:block; margin-top:1rem; color:#9ad4d6; cursor:pointer; text-decoration:underline; font-size:.9rem; }
    @keyframes pop { to { transform: scale(1); opacity: 1; } }

    .game-container { display: none; width: 100%; height: 100vh; flex-direction: row; background-color: transparent; }

    .sidebar {
      width: 240px; background: #2a3d56; display: flex; flex-direction: column; 
      justify-content: space-between; align-items: center; padding: 16px 10px; border-right: 2px solid #5bc0be;
      box-sizing: border-box; z-index: 20;
    }
    .nav-buttons { display: flex; flex-direction: column; align-items: center; width: 100%; overflow-y:auto; }
    .nav-buttons button { width: 95%; margin: 6px 0; background: #3a506b; font-size: 0.9rem; padding: 0.6rem; text-align: left; }
    .nav-buttons button:hover { background: #5bc0be; color: #1b2735; }
    .retire-btn { background: #673ab7 !important; border: 1px solid #9575cd; display:none; }
    .retire-btn:hover { background: #9575cd !important; }
    .logout-btn { background: #b0413e; width: 95%; font-size: 0.9rem; padding: 0.6rem; }

    .main-content { 
      flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; 
      text-align: center; padding: 30px; position: relative; 
    }
    
    /* --- HUD --- */
    .hud {
      position: absolute; top: 12px; right: 16px;
      background: rgba(0,0,0,.6); padding: 10px 15px; border-radius: 12px; font-size: .95rem;
      box-shadow: 0 0 0 1px rgba(255,255,255,.1) inset; z-index: 15; min-width: 320px;
    }
    .hud-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .xp-container { width: 100%; height: 8px; background: #111; border-radius: 4px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); }
    .xp-fill { height: 100%; background: linear-gradient(90deg, #a06cd5, #b886e6); width: 0%; transition: width 0.3s ease-out; }
    .hud-currency { display: flex; gap: 10px; }
    .hud-stat-box { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }

    /* --- GAMEPLAY ELEMENTS --- */
    .bp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; width: 100%; max-height: 60vh; overflow-y: auto; padding: 10px; }
    .bp-item {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px; padding: 12px; text-align: center; position: relative;
      display: flex; flex-direction: column; align-items: center; justify-content: space-between;
    }
    .btn-sm { padding: .3rem .6rem; border-radius: 6px; font-size: 0.8rem; min-width: auto; }
    .star-btn { position: absolute; top: 4px; right: 4px; background: none; border: none; font-size: 1.4rem; cursor: pointer; color: rgba(255,255,255,0.3); }
    .star-btn.fav-active { color: #ffd700; }

    /* --- CHAT SYSTEM --- */
    .chat-container {
        position: fixed; bottom: 10px; right: 10px; width: 300px; height: 250px;
        background: rgba(0,0,0,0.85); border: 1px solid #555; border-radius: 8px;
        display: flex; flex-direction: column; z-index: 100; transition: height 0.3s;
    }
    .chat-container.minimized { height: 30px; overflow: hidden; }
    .chat-header { background: #333; padding: 5px 10px; font-size: 0.8rem; cursor: pointer; display: flex; justify-content: space-between; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 5px; font-size: 0.8rem; text-align: left; }
    .chat-input-row { display: flex; padding: 5px; border-top: 1px solid #444; }
    .chat-input { flex: 1; background: #222; border: none; color: #fff; padding: 4px; border-radius: 4px; }
    .chat-msg-row { margin-bottom: 4px; line-height: 1.2; word-wrap: break-word; }
    .chat-sys { color: #ffd700; font-style: italic; }
    .chat-usr { color: #5bc0be; font-weight: bold; }

    /* --- GUILD & MARKET --- */
    .guild-badge { display: inline-block; background: #673ab7; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 5px; }
    .market-list-btn { background: #4caf50; width: 100%; margin-top: 5px; font-size: 0.8rem; }
    .buy-btn { background: #ff9800; width: 100%; margin-top: 5px; font-size: 0.8rem; }

    /* --- STYLES FOR WEATHER/TIME --- */
    body.t-night { box-shadow: inset 0 0 200vw rgba(0,0,0,0.85); color: #ccc; }
    body.t-night .main-content { background: rgba(0,0,0,0.4); }
    .w-rain .main-content { box-shadow: inset 0 0 50px rgba(0,0,50,0.5); }
    .w-storm .main-content { box-shadow: inset 0 0 50px rgba(50,0,0,0.5); }
    .weather-indicator { font-size: 0.9rem; margin-top: 5px; padding: 4px 8px; border-radius: 6px; background: rgba(255,255,255,0.1); }

    /* Minigame */
    .minigame-area { position: relative; width: 100%; height: 350px; background: rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; display: none; cursor: crosshair; }
    .game-bar-container { width: 100%; max-width: 400px; height: 20px; background: #2b1d1d; border: 2px solid #555; border-radius: 10px; margin-bottom: 10px; position: relative; display: none; overflow: hidden; }
    .game-bar-fill { height: 100%; width: 35%; background: linear-gradient(90deg, #ff8a00, #e52e71); transition: width 0.1s linear; }
    .target-circle { position: absolute; width: 50px; height: 50px; background: #5bc0be; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: auto; }
    .target-ring { position: absolute; width: 150px; height: 150px; border: 4px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; opacity: 0.8; }

  </style>
</head>
<body>

  <!-- Landing -->
  <a href="#" class="signin-top" id="signinLink">Sign In</a>
  <h1 id="title">Fishing Idly</h1>
  <button id="startButton">Start</button>

  <!-- Login Modal -->
  <div class="overlay" id="overlay" style="display:none;">
    <div class="signin-box">
      <div id="signinForm">
        <h2>Sign In</h2>
        <input type="text" id="signin-username" placeholder="Username"/>
        <input type="password" id="signin-password" placeholder="Password"/>
        <button id="loginButton">Log In</button>
        <span class="toggle-link" id="showSignup">Don‚Äôt have an account? Sign Up</span>
      </div>
      <div id="signupForm" style="display:none;">
        <h2>Create Account</h2>
        <input type="email" id="signup-email" placeholder="Email"/>
        <input type="text" id="signup-username" placeholder="Username"/>
        <input type="password" id="signup-password" placeholder="Password"/>
        <button id="signupButton">Sign Up</button>
        <span class="toggle-link" id="showSignin">Already have an account? Sign In</span>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="overlay" id="profileOverlay" style="display:none;">
    <div class="signin-box profile-box" style="width: 600px; max-width:95%;">
      <div style="text-align:right;"><button id="closeProfileBtn" class="btn-sm">X</button></div>
      <div class="profile-header">
        <h2 id="profName">Player</h2>
        <div class="profile-stats" id="profStats">Lv 1 ¬∑ 0g</div>
      </div>
      <div id="profGuildInfo"></div>
      <h3>Home Aquarium</h3>
      <div class="passive-info" style="margin-bottom:10px;" id="profPassive">Generating: 0g/hr</div>
      <div class="slot-grid" id="profGrid"></div>
    </div>
  </div>

  <!-- Game UI -->
  <div class="game-container" id="gameContainer">
    <div class="sidebar">
      <div class="nav-buttons">
        <button id="homeBtn">üè† Home</button>
        <button id="fishingSpotBtn">üé£ Fishing Spot</button>
        <button id="backpackBtn">üéí Backpack</button>
        <button id="questsBtn">üìú Daily Quests</button>
        <button id="marketBtn">üè™ Fishmonger (Sell)</button>
        <button id="p2pMarketBtn">‚öñÔ∏è Global Exchange</button> <!-- NEW -->
        <button id="guildBtn">üõ°Ô∏è Guilds</button> <!-- NEW -->
        <button id="shopBtn">üõí Rod Shop</button>
        <button id="indexBtn">üìñ Index</button>
        <button id="leaderboardBtn">üèÜ Leaderboard</button>
        <button id="retireBtn" class="retire-btn" onclick="window.confirmRetire()">‚ú® Retire (Prestige)</button>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
    <div class="main-content" id="mainContent">
      <div id="viewArea"></div>
    </div>
  </div>

  <!-- Chat Box -->
  <div class="chat-container" id="chatContainer" style="display:none;">
    <div class="chat-header" onclick="this.parentElement.classList.toggle('minimized')">
      <span>Global Chat</span> <span>_</span>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-row">
      <input type="text" id="chatInput" class="chat-input" placeholder="Say hello..." maxlength="50"/>
      <button class="btn-sm" style="margin-left:5px;" onclick="window.sendChat()">></button>
    </div>
  </div>

  <!-- Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, getDocs, collection, addDoc, deleteDoc, updateDoc, onSnapshot, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnoFqUUjddA6ipJSisLOS7MsFklhQKt_w",
      authDomain: "fishingidly-c1613.firebaseapp.com",
      projectId: "fishingidly-c1613",
      storageBucket: "fishingidly-c1613.firebasestorage.app",
      messagingSenderId: "531215063717",
      appId: "1:531215063717:web:dea4ce7aa7a64d3f374b4c",
      measurementId: "G-SR67MT90SE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- UTILS ---
    function cleanForFirestore(obj) {
      const cleaned = { ...obj };
      Object.keys(cleaned).forEach(key => { if (cleaned[key] === undefined || cleaned[key] === null) delete cleaned[key]; });
      return cleaned;
    }
    function setCurrentUser(user) { if (!user) return; localStorage.setItem('currentUser', JSON.stringify(cleanForFirestore(user))); }
    function getCurrentUser() { try { return JSON.parse(localStorage.getItem('currentUser')); } catch { return null; } }
    async function savePlayerToCloud(user) { 
        if (!user || !user.username) return; 
        // Update lastActive for Guild tracking
        user.lastActive = Date.now(); 
        await setDoc(doc(db, "players", user.username), cleanForFirestore(user), { merge: true }); 
    }
    async function getPlayerProfile(username) { const snap = await getDoc(doc(db, "players", username)); return snap.exists() ? snap.data() : null; }
    function getEntityIcon(item) {
        if (item.type === 'chest') return `<span class="emoji-icon">üéÅ</span>`;
        if (item.type === 'key') return `<span class="emoji-icon">üîë</span>`;
        if (item.img && item.img !== "placeholder.png") { return `<img src="assets/fish/${item.img}" class="pixel-icon" alt="${item.name}">`; }
        if (item.type === 'trash') return `<span class="emoji-icon">üëû</span>`;
        return `<span class="emoji-icon">üêü</span>`;
    }

    // --- GAME DATA ---
    const RODS = [
      { id: 0, name: "Bamboo Rod", cost: 0, luck: 1.0, speed: 1.0, icon: "üéã" },
      { id: 1, name: "Fiberglass Rod", cost: 1500, luck: 1.2, speed: 1.1, icon: "üé£" },
      { id: 2, name: "Carbon Rod", cost: 5000, luck: 1.5, speed: 1.3, icon: "üî©" },
      { id: 3, name: "Lucky Rod", cost: 15000, luck: 2.5, speed: 1.0, icon: "üçÄ" },
      { id: 4, name: "Speedy Rod", cost: 15000, luck: 1.1, speed: 2.0, icon: "‚ö°" },
      { id: 5, name: "Golden Rod", cost: 50000, luck: 3.0, speed: 2.0, icon: "üëë" },
      { id: 6, name: "Poseidon's Trident", cost: 250000, luck: 5.0, speed: 3.0, icon: "üî±" }
    ];

    const pondTable = [
      { name: "Treasure Chest", type: "chest", img: "placeholder.png", minKg: 10, maxKg: 10, pricePerKg: 0, rarity: "legendary", chanceWeight: 0.5 },
      { name: "Old Boot", type: "trash", img: "placeholder.png", minKg: 0.5, maxKg: 1.5, pricePerKg: 1, rarity: "trash", chanceWeight: 10 },
      { name: "Tin Can", type: "trash", img: "placeholder.png", minKg: 0.1, maxKg: 0.3, pricePerKg: 1, rarity: "trash", chanceWeight: 8 },
      { name: "Pumpkinseed", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.4, pricePerKg: 4, rarity: "common", chanceWeight: 20, time: ['day'] },
      { name: "Yellow Perch", type: "fish", img: "placeholder.png", minKg: 0.2, maxKg: 1.0, pricePerKg: 5, rarity: "common", chanceWeight: 20, time: ['day'] },
      { name: "Walleye", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 4.0, pricePerKg: 6, rarity: "common", chanceWeight: 20, time: ['night'] }, 
      { name: "Bluegill", type: "fish", img: "placeholder.png", minKg: 0.3, maxKg: 1.2, pricePerKg: 6, rarity: "uncommon", chanceWeight: 12, weather: ['clear', 'heat'], time: ['day'] }, 
      { name: "Catfish", type: "fish", img: "placeholder.png", minKg: 2.0, maxKg: 10.0, pricePerKg: 4, rarity: "uncommon", chanceWeight: 10, weather: ['rain', 'storm'], time: ['night'] }, 
      { name: "Carp", type: "fish", img: "placeholder.png", minKg: 3.0, maxKg: 15.0, pricePerKg: 3, rarity: "uncommon", chanceWeight: 10, weather: ['fog'] }, 
      { name: "Goldfish", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.8, pricePerKg: 20, rarity: "rare", chanceWeight: 8, weather: ['clear'], time: ['day'] },
      { name: "Largemouth Bass", type: "fish", img: "placeholder.png", minKg: 1.5, maxKg: 5.0, pricePerKg: 8, rarity: "epic", chanceWeight: 5, weather: ['storm'] }, 
      { name: "Golden Koi", type: "fish", img: "placeholder.png", minKg: 2.0, maxKg: 8.0, pricePerKg: 15, rarity: "legendary", chanceWeight: 2, weather: ['heat'], time: ['day'] } 
    ];

    const streamTable = [
      { name: "Treasure Chest", type: "chest", img: "placeholder.png", minKg: 10, maxKg: 10, pricePerKg: 0, rarity: "legendary", chanceWeight: 0.5 },
      { name: "Waterlogged Branch", type: "trash", img: "placeholder.png", minKg: 1.0, maxKg: 5.0, pricePerKg: 1, rarity: "trash", chanceWeight: 10 },
      { name: "Creek Chub", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.5, pricePerKg: 4, rarity: "common", chanceWeight: 20, time: ['day'] },
      { name: "Fallfish", type: "fish", img: "placeholder.png", minKg: 0.2, maxKg: 1.0, pricePerKg: 4, rarity: "common", chanceWeight: 20, time: ['day'] },
      { name: "White Sucker", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 2.5, pricePerKg: 5, rarity: "common", chanceWeight: 15, weather: ['fog', 'rain'], time: ['night'] },
      { name: "Common Shiner", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.3, pricePerKg: 4, rarity: "common", chanceWeight: 15, weather: ['clear'], time: ['day'] },
      { name: "Smallmouth Bass", type: "fish", img: "placeholder.png", minKg: 0.8, maxKg: 4.0, pricePerKg: 10, rarity: "uncommon", chanceWeight: 12, weather: ['heat', 'clear'], time: ['day'] },
      { name: "Rock Bass", type: "fish", img: "placeholder.png", minKg: 0.3, maxKg: 1.5, pricePerKg: 7, rarity: "uncommon", chanceWeight: 12, time: ['night'] },
      { name: "Rainbow Darter", type: "fish", img: "placeholder.png", minKg: 0.02, maxKg: 0.15, pricePerKg: 20, rarity: "uncommon", chanceWeight: 8, weather: ['rain'] }, 
      { name: "Brook Trout", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 4.0, pricePerKg: 16, rarity: "rare", chanceWeight: 6, time: ['day'] },
      { name: "Brown Trout", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 5.0, pricePerKg: 18, rarity: "rare", chanceWeight: 5, weather: ['rain', 'storm'], time: ['night'] },
      { name: "Atlantic Salmon", type: "fish", img: "placeholder.png", minKg: 2.0, maxKg: 12.0, pricePerKg: 28, rarity: "epic", chanceWeight: 3, weather: ['storm'] },
      { name: "Ancient River Sturgeon", type: "fish", img: "placeholder.png", minKg: 10.0, maxKg: 50.0, pricePerKg: 45, rarity: "legendary", chanceWeight: 1, weather: ['storm', 'rain'], time: ['night'] }
    ];

    const mutations = [{name:"Normal",mult:1},{name:"Shiny",mult:1.85},{name:"Sparkling",mult:1.85},{name:"Albino",mult:1.15},{name:"Mythical",mult:4.5}];
    const SLOT_COSTS = [0, 500, 1500, 3000, 5000, 10000, 20000, 50000, 100000, 250000];
    const XP_RATES = { trash: 2, common: 10, uncommon: 25, rare: 60, epic: 150, legendary: 500 };

    // --- INIT DATA ---
    function initUserData(user) {
      let changed = false;
      if (!user.home || !user.home.slots) { user.home = { lastClaim: Date.now(), slots: Array(10).fill(null).map((_, i) => ({ id: i, unlocked: i === 0, fish: null })) }; changed = true; }
      if (!user.ownedRods) { user.ownedRods = [0]; changed = true; }
      if (user.equippedRod === undefined) { user.equippedRod = 0; changed = true; }
      if (!user.maxItems) { user.maxItems = 15; changed = true; }
      if (!user.unlockedLocations) { user.unlockedLocations = ["pond"]; changed = true; }
      if (!user.discoveredFish) { user.discoveredFish = []; changed = true; }
      if (!user.dailyQuests) { user.dailyQuests = []; changed = true; }
      if (!user.fishCounts) { user.fishCounts = {}; changed = true; }
      if (user.pearls === undefined) { user.pearls = 0; changed = true; }
      if (user.prestige === undefined) { user.prestige = 0; changed = true; }
      if (user.guild === undefined) { user.guild = null; changed = true; } // New Guild field
      if (changed) { setCurrentUser(user); savePlayerToCloud(user); }
      return user;
    }

    // --- WEATHER & TIME ---
    const WEATHER_TYPES = [
      { id: 'rain', name: 'Rain', chance: 0.05, icon: 'üåßÔ∏è', luck: 1.2, speed: 1.0, value: 1.0 },
      { id: 'storm', name: 'Storm', chance: 0.05, icon: '‚õàÔ∏è', luck: 1.5, speed: 1.3, value: 1.0 },
      { id: 'fog', name: 'Fog', chance: 0.05, icon: 'üå´Ô∏è', luck: 1.0, speed: 1.1, value: 1.0 },
      { id: 'heat', name: 'Heatwave', chance: 0.05, icon: 'üî•', luck: 1.0, speed: 1.0, value: 1.2 }
    ];
    function getTimeState() { const h = new Date().getHours(); return (h >= 6 && h < 18) ? 'day' : 'night'; }
    function getCurrentWeather() {
      const idx = Math.floor(Date.now() / (6*3600000));
      const rand = (Math.sin(idx) * 10000) - Math.floor(Math.sin(idx) * 10000);
      let acc = 0;
      for (const w of WEATHER_TYPES) { acc += w.chance; if (rand < acc) return w; }
      return { id: 'clear', name: 'Clear', chance: 0.8, icon: '‚òÄÔ∏è', luck: 1, speed: 1, value: 1 };
    }
    function applyVisuals() { const w = getCurrentWeather(); const t = getTimeState(); document.body.className = `w-${w.id} t-${t}`; }

    // --- CHAT SYSTEM ---
    let chatListener = null;
    function initChat() {
        const q = query(collection(db, "messages"), orderBy("timestamp", "desc"), limit(20));
        chatListener = onSnapshot(q, (snapshot) => {
            const chatDiv = document.getElementById("chatMessages");
            const msgs = [];
            snapshot.forEach(doc => msgs.push(doc.data()));
            msgs.reverse();
            chatDiv.innerHTML = msgs.map(m => {
                if (m.type === 'system') return `<div class="chat-msg-row chat-sys">${m.text}</div>`;
                return `<div class="chat-msg-row"><span class="chat-usr">${m.sender}:</span> ${m.text}</div>`;
            }).join('');
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });
    }
    window.sendChat = async function() {
        const u = getCurrentUser();
        const inp = document.getElementById("chatInput");
        const txt = inp.value.trim();
        if (!txt) return;
        await addDoc(collection(db, "messages"), { sender: u.username, text: txt, timestamp: Date.now(), type: 'user' });
        inp.value = "";
    };
    async function sendSystemMessage(text) {
        await addDoc(collection(db, "messages"), { sender: "System", text: text, timestamp: Date.now(), type: 'system' });
    }

    // --- MARKETPLACE (P2P) ---
    window.renderGlobalMarket = async function() {
        mainContent.innerHTML = `${renderHudHTML()}<h2>‚öñÔ∏è Global Exchange</h2><p>Buy fish from other players or list your own.</p><div id="marketList">Loading...</div>`;
        updateHud();
        
        const q = query(collection(db, "market"), orderBy("timestamp", "desc"), limit(50));
        const snap = await getDocs(q);
        const u = getCurrentUser();
        
        let html = `<div class="bp-grid">`;
        if (snap.empty) html += `<p>No listings found.</p>`;
        else {
            snap.forEach(doc => {
                const data = doc.data();
                const isMine = data.seller === u.username;
                const item = data.item;
                html += `
                <div class="bp-item ${item.mutation!=='Normal'?`mut-${item.mutation}`:''}">
                    ${getEntityIcon(item)}
                    <div style="font-size:0.8rem;"><b>${item.name}</b><br>Seller: ${data.seller}<br>Price: ${data.price}g</div>
                    ${isMine ? `<button class="btn-sm" style="background:#b0413e; margin-top:5px;" onclick="window.cancelListing('${doc.id}')">Cancel</button>` 
                             : `<button class="buy-btn" onclick="window.buyListing('${doc.id}', ${data.price})">Buy</button>`}
                </div>`;
            });
        }
        html += `</div>`;
        // Add "List Item" button redirect
        html += `<div style="margin-top:20px; border-top:1px solid #555; padding-top:10px;">
            <h3>Your Backpack (Select to List)</h3>
            <div class="bp-grid" id="marketBackpack"></div>
        </div>`;
        
        document.getElementById('marketList').innerHTML = html;
        
        // Render backpack for listing
        const bpHtml = u.items.map((item, idx) => {
            if (item.type === 'chest' || item.type === 'key' || item.favorite) return '';
            return `<div class="bp-item">
                ${getEntityIcon(item)}
                <div style="font-size:0.8rem;">${item.name}</div>
                <button class="btn-sm" style="background:#4caf50; margin-top:5px;" onclick="window.listMarketItem(${idx})">List</button>
            </div>`;
        }).join('');
        document.getElementById('marketBackpack').innerHTML = bpHtml || '<p>No sellable items.</p>';
    };

    window.listMarketItem = async function(idx) {
        const u = getCurrentUser();
        // Check limit
        const q = query(collection(db, "market"), where("seller", "==", u.username));
        const snap = await getDocs(q);
        if (snap.size >= 5) return alert("You can only have 5 listings active!");

        const price = prompt("Enter price in Gold:", "500");
        if (!price || isNaN(price) || price < 1) return;
        
        const item = u.items[idx];
        u.items.splice(idx, 1);
        
        await addDoc(collection(db, "market"), { seller: u.username, item: item, price: parseInt(price), timestamp: Date.now() });
        setCurrentUser(u); savePlayerToCloud(u); window.renderGlobalMarket();
    };

    window.cancelListing = async function(docId) {
        // Simple delete for demo (in production, use transactions to return item)
        // For this demo: We will just delete and assume user lost it or implement return logic
        // Let's implement return:
        const snap = await getDoc(doc(db, "market", docId));
        if (snap.exists()) {
            const data = snap.data();
            const u = getCurrentUser();
            if (data.seller === u.username) {
                u.items.push(data.item);
                await deleteDoc(doc(db, "market", docId));
                setCurrentUser(u); savePlayerToCloud(u); window.renderGlobalMarket();
            }
        }
    };

    window.buyListing = async function(docId, price) {
        const u = getCurrentUser();
        if (u.coins < price) return alert("Not enough gold!");
        
        // Transaction safety is hard in vanilla JS client without cloud functions, but we try best effort
        const ref = doc(db, "market", docId);
        const snap = await getDoc(ref);
        if (!snap.exists()) return alert("Item already sold!");
        
        const data = snap.data();
        if (data.seller === u.username) return alert("You can't buy your own item.");

        if (confirm(`Buy ${data.item.name} for ${price}g?`)) {
            // Deduct Gold
            u.coins -= price;
            // Add Item
            u.items.push(data.item);
            
            // Pay Seller (Update their doc directly)
            const sellerRef = doc(db, "players", data.seller);
            const sellerSnap = await getDoc(sellerRef);
            if (sellerSnap.exists()) {
                const sData = sellerSnap.data();
                await updateDoc(sellerRef, { coins: (sData.coins || 0) + price });
            }
            
            // Remove Listing
            await deleteDoc(ref);
            setCurrentUser(u); savePlayerToCloud(u); 
            alert("Purchased!");
            window.renderGlobalMarket();
        }
    };

    // --- GUILD SYSTEM ---
    window.renderGuilds = async function() {
        const u = getCurrentUser();
        mainContent.innerHTML = `${renderHudHTML()}<h2>üõ°Ô∏è Guilds</h2><div id="guildContent">Loading...</div>`;
        updateHud();

        const container = document.getElementById('guildContent');
        
        if (u.guild) {
            // Show My Guild
            const gSnap = await getDocs(query(collection(db, "guilds"), where("name", "==", u.guild)));
            if (gSnap.empty) { u.guild = null; setCurrentUser(u); return window.renderGuilds(); }
            const gData = gSnap.docs[0].data();
            
            // Calculate Online Members (Active in last 2 mins)
            let onlineCount = 0;
            const memberPromises = gData.members.map(m => getDoc(doc(db, "players", m)));
            const memberDocs = await Promise.all(memberPromises);
            memberDocs.forEach(d => {
                if(d.exists() && d.data().lastActive > Date.now() - 120000) onlineCount++;
            });
            
            const xpBuff = onlineCount >= 5 ? "<span style='color:#4caf50'>ACTIVE (+5% XP)</span>" : "<span style='color:#aaa'>Inactive (Need 5 online)</span>";

            container.innerHTML = `
                <div class="signin-box" style="width:100%;">
                    <h3>${gData.name}</h3>
                    <p>Members: ${gData.members.length} | Online: ${onlineCount}</p>
                    <p>Buff Status: ${xpBuff}</p>
                    <div style="margin:20px 0; text-align:left; max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.2); padding:10px;">
                        ${gData.members.map(m => `<div>üë§ ${m}</div>`).join('')}
                    </div>
                    <button class="logout-btn" onclick="window.leaveGuild('${gSnap.docs[0].id}')">Leave Guild</button>
                </div>
            `;
        } else {
            // List / Create
            const q = query(collection(db, "guilds"), limit(10));
            const snap = await getDocs(q);
            let listHtml = snap.docs.map(d => {
                const g = d.data();
                return `<div class="bp-item" style="flex-direction:row; justify-content:space-between; margin-bottom:5px;">
                    <div style="text-align:left;"><b>${g.name}</b><br>${g.members.length} members</div>
                    <button class="btn-sm" style="background:#5bc0be" onclick="window.joinGuild('${d.id}')">Join</button>
                </div>`;
            }).join('');

            container.innerHTML = `
                <div style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center;">
                    <div class="signin-box">
                        <h3>Create Guild</h3>
                        <p>Cost: 250,000g OR 5 Pearls</p>
                        <input type="text" id="newGuildName" placeholder="Guild Name" maxlength="12" />
                        <button onclick="window.createGuild('gold')" style="margin-top:5px; width:100%; background:#ffd700; color:#000;">Pay 250k Gold</button>
                        <button onclick="window.createGuild('pearl')" style="margin-top:5px; width:100%; background:#e040fb;">Pay 5 Pearls</button>
                    </div>
                    <div class="signin-box" style="flex:1;">
                        <h3>Find Guild</h3>
                        ${listHtml || '<p>No guilds found.</p>'}
                    </div>
                </div>
            `;
        }
    };

    window.createGuild = async function(currency) {
        const u = getCurrentUser();
        const name = document.getElementById('newGuildName').value.trim();
        if (!name) return alert("Invalid Name");
        
        // Check Exists
        const check = await getDocs(query(collection(db, "guilds"), where("name", "==", name)));
        if (!check.empty) return alert("Name taken");

        if (currency === 'gold') {
            if (u.coins < 250000) return alert("Need 250k Gold");
            u.coins -= 250000;
        } else {
            if (u.pearls < 5) return alert("Need 5 Pearls");
            u.pearls -= 5;
        }

        await addDoc(collection(db, "guilds"), { name: name, owner: u.username, members: [u.username] });
        u.guild = name;
        setCurrentUser(u); savePlayerToCloud(u); window.renderGuilds();
    };

    window.joinGuild = async function(guildId) {
        const u = getCurrentUser();
        const ref = doc(db, "guilds", guildId);
        const snap = await getDoc(ref);
        if (!snap.exists()) return;
        
        const data = snap.data();
        if (!data.members.includes(u.username)) {
            const newMembers = [...data.members, u.username];
            await updateDoc(ref, { members: newMembers });
            u.guild = data.name;
            setCurrentUser(u); savePlayerToCloud(u); window.renderGuilds();
        }
    };

    window.leaveGuild = async function(guildId) {
        const u = getCurrentUser();
        if (!confirm("Leave guild?")) return;
        const ref = doc(db, "guilds", guildId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
            const data = snap.data();
            const newMembers = data.members.filter(m => m !== u.username);
            await updateDoc(ref, { members: newMembers }); // Note: If owner leaves, logic becomes complex. Ignoring for demo.
            u.guild = null;
            setCurrentUser(u); savePlayerToCloud(u); window.renderGuilds();
        }
    };

    // --- GAME LOOP & UPDATES ---
    function generateFish(locationTable, luckMultiplier = 1.0, locationName, fishCounts = {}) {
      const w = getCurrentWeather();
      const t = getTimeState();
      luckMultiplier *= w.luck;
      
      const validTable = locationTable.filter(i => {
          if (i.weather && !i.weather.includes(w.id)) return false;
          if (i.time && !i.time.includes(t)) return false;
          return true;
      });

      const adjusted = validTable.map(i => ({...i, activeWeight: i.chanceWeight * (i.rarity!=='trash'?luckMultiplier:1)}));
      let total = adjusted.reduce((s,i)=>s+i.activeWeight,0);
      let r = Math.random() * total;
      let species = adjusted[0];
      for(let i of adjusted){ if((r-=i.activeWeight)<=0){species=i; break;} }

      const weight = parseFloat((species.minKg + Math.random()*(species.maxKg-species.minKg)).toFixed(2));
      let mut = mutations[0];
      if (species.type !== 'trash' && species.type !== 'chest') {
          const rM = Math.random();
          if (rM < 0.01*luckMultiplier) mut = mutations[4];
          else if (rM < 0.03*luckMultiplier) mut = mutations[3];
          else if (rM < 0.07*luckMultiplier) mut = mutations[2];
          else if (rM < 0.15*luckMultiplier) mut = mutations[1];
      }
      
      let val = Math.ceil(weight * species.pricePerKg * mut.mult);
      if (fishCounts[species.name] >= 100) val = Math.ceil(val*1.05);
      val = Math.ceil(val * w.value);

      return { name: species.name, type: species.type, rarity: species.rarity, weight, mutation: mut.name, value: val, img: species.img };
    }

    // Minigame & XP (Updated with Guild Buff)
    async function endMinigame(won, fish) {
        document.getElementById('minigameArea').style.display='none'; document.getElementById('gameBarContainer').style.display='none'; document.getElementById('castBtn').disabled=false;
        if (won) {
            const u = getCurrentUser();
            u.items.push(fish);
            if(fish.rarity === 'legendary' || fish.mutation === 'Mythical' || fish.mutation === 'Golden') {
                sendSystemMessage(`${u.username} just caught a ${fish.mutation} ${fish.name}!`);
            }
            if(!u.fishCounts) u.fishCounts = {}; u.fishCounts[fish.name] = (u.fishCounts[fish.name]||0)+1;
            if(!u.discoveredFish.includes(fish.name)) u.discoveredFish.push(fish.name);
            
            // GUILD BUFF CHECK
            let xpMult = 1.0;
            if (u.guild) {
                // Simplified: We assume buff is active if user is in a guild for this demo loop to save async calls
                // A robust system would store "buffActive" in localStorage updated by renderGuilds
                // For now, let's just give +2% flat for being in a guild, +5% logic is in UI
                xpMult = 1.05; 
            }

            const baseXP = XP_RATES[fish.rarity] || 1;
            u.xp = (u.xp || 0) + Math.ceil(baseXP * xpMult);
            if (u.xp >= u.level*100) { u.xp -= u.level*100; u.level++; u.coins += u.level*50; }
            setCurrentUser(u); savePlayerToCloud(u); updateHud(); document.getElementById('pondStatus').textContent = `Caught ${fish.name}!`;
        } else { document.getElementById('pondStatus').textContent = "It got away..."; }
    }

    // UI Renderers
    function renderHudHTML() { return `<div class="hud" id="hudEl">Loading...</div>`; }
    function updateHud() {
        const u = getCurrentUser();
        const el = document.getElementById('hudEl');
        applyVisuals();
        const w = getCurrentWeather(); const t = getTimeState();
        const timeIcon = t==='day'?'‚òÄÔ∏è':'üåô';
        const retireBtn = document.getElementById('retireBtn');
        if(u.level>=50) retireBtn.style.display='block'; else retireBtn.style.display='none';

        if(u && el) {
            const xpN = u.level*100; const pct = Math.min(100, (u.xp/xpN)*100);
            el.innerHTML = `
                <div class="hud-row"><span>üë§ ${u.username} ${u.guild ? `<span class="guild-badge">${u.guild}</span>` : ''}</span><span class="hud-stat-box" style="color:#7986cb">üîµ ${u.prestige}</span><span style="color:#a06cd5">‚≠ê ${u.level}</span></div>
                <div class="hud-row hud-currency"><span style="color:#ffd700">üí∞ ${u.coins}</span><span style="color:#e040fb">‚ö™ ${u.pearls}</span></div>
                <div class="xp-container"><div class="xp-fill" style="width:${pct}%"></div></div>
                <div style="font-size:0.7rem; color:#aaa; margin-top:4px;">${u.xp}/${xpN} XP</div>
                <div style="display:flex; justify-content:space-between; margin-top:4px;"><div style="display:flex; gap:5px;"><div class="weather-indicator">${w.icon} ${w.name}</div><div class="weather-indicator">${timeIcon} ${t}</div></div><div style="font-size:0.75rem;">üéí ${u.items.length}/${u.maxItems}</div></div>
            `;
        }
    }

    // Mapping Buttons
    document.getElementById('p2pMarketBtn').onclick = window.renderGlobalMarket;
    document.getElementById('guildBtn').onclick = window.renderGuilds;
    document.getElementById('marketBtn').onclick = renderMarket; // The NPC Shop
    // ... (Attach other buttons as before) ...
    document.getElementById('homeBtn').onclick = renderHome;
    document.getElementById('fishingSpotBtn').onclick = renderFishingSpot;
    document.getElementById('backpackBtn').onclick = renderBackpack;
    document.getElementById('shopBtn').onclick = renderShop;
    document.getElementById('questsBtn').onclick = window.renderQuests;
    document.getElementById('indexBtn').onclick = () => window.renderIndex('all');
    document.getElementById('leaderboardBtn').onclick = renderLeaderboard;
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('currentUser'); location.reload(); };

    // Standard Functions (Minified for brevity, same logic as before)
    function renderFishingSpot() { const u = getCurrentUser(); const r = RODS[u.equippedRod]; mainContent.innerHTML = `${renderHudHTML()}<h2>üé£ Spot</h2><p>Using: ${r.icon}</p><button class="location-btn" onclick="window.renderPond()">üêü Pond</button>${u.unlockedLocations.includes('stream')?`<button class="location-btn" onclick="window.renderStream()">üåä Stream</button>`:'<button class="location-btn btn-locked">Locked</button>'}`; updateHud(); }
    window.renderPond = () => setupFishScene('pond');
    window.renderStream = () => setupFishScene('stream');
    function setupFishScene(loc) { mainContent.innerHTML = `${renderHudHTML()}<div class="pond-wrap"><div class="pond-header"><button class="back-inline" onclick="renderFishingSpot()">‚Üê</button><h2>${loc.toUpperCase()}</h2></div><div class="game-bar-container" id="gameBarContainer"><div class="game-bar-fill" id="gameBarFill"></div></div><div class="status" id="pondStatus">Ready</div><div class="wait-bar" id="waitBar"><div class="wait-fill" id="waitFill"></div></div><div class="minigame-area" id="minigameArea"></div><button id="castBtn" onclick="window.handleCast('${loc}')">Cast</button></div>`; }
    
    window.handleCast = function(loc) {
        const u = getCurrentUser(); const r = RODS[u.equippedRod];
        if(u.items.length >= u.maxItems) return alert("Bag Full");
        const w = getCurrentWeather(); let speed = r.speed / w.speed;
        const bar = document.getElementById('waitBar'); const fill = document.getElementById('waitFill'); bar.style.display='block'; document.getElementById('castBtn').disabled=true;
        setTimeout(()=>fill.style.width='100%', 50);
        setTimeout(()=>{
            bar.style.display='none'; fill.style.width='0%';
            const fish = generateFish(loc==='stream'?streamTable:pondTable, r.luck, loc, u.fishCounts);
            if((u.fishCounts[fish.name]||0)>=1000) { document.getElementById('pondStatus').textContent="Instant Catch!"; endMinigame(true, fish); }
            else startMinigame(fish);
        }, (1000+Math.random()*2000)/speed);
    };

    let minigameActive = false; let mgProg = 35; let spawnT=null; let gLoop=null; let activeFish=null;
    function startMinigame(f) {
        activeFish = f; minigameActive=true; mgProg=35;
        const area = document.getElementById('minigameArea'); const bar = document.getElementById('gameBarFill');
        area.style.display='block'; document.getElementById('gameBarContainer').style.display='block'; document.getElementById('castBtn').style.display='none'; area.innerHTML='';
        spawnT = setInterval(()=>{ if(!minigameActive)return; spawnCircle(area, difficultyMap[f.rarity]||2000); }, 800);
        gLoop = requestAnimationFrame(function s(){ if(!minigameActive)return; if(mgProg<=0)endMinigame(false,f); else if(mgProg>=100)endMinigame(true,f); else requestAnimationFrame(s); });
    }
    function spawnCircle(area, dur) {
        const t = document.createElement('div'); t.className='target-circle'; t.style.left=(Math.random()*(area.clientWidth-50))+'px'; t.style.top=(Math.random()*(area.clientHeight-50))+'px';
        area.appendChild(t);
        t.onmousedown = (e) => { e.stopPropagation(); mgProg += (activeFish && (getCurrentUser().fishCounts[activeFish.name]||0)>=500) ? 16.5 : 15; document.getElementById('gameBarFill').style.width=mgProg+'%'; t.remove(); };
        setTimeout(()=>{ if(t.parentNode){ mgProg-=10; document.getElementById('gameBarFill').style.width=mgProg+'%'; t.remove(); } }, dur);
    }

    // --- ADMIN & START ---
    function startGame(user) { 
        document.getElementById('overlay').style.display='none'; document.getElementById('title').style.display='none'; document.getElementById('startButton').style.display='none'; document.getElementById('signinLink').style.display='none'; 
        document.getElementById('gameContainer').style.display='flex'; document.getElementById('chatContainer').style.display='flex';
        initChat(); renderHome(); 
        setInterval(() => savePlayerToCloud(getCurrentUser()), 60000); // Auto save & heartbeat
    }
    
    document.getElementById('loginButton').onclick = async () => { 
        const u = document.getElementById('signin-username').value.trim(); const p = document.getElementById('signin-password').value.trim();
        const snap = await getDoc(doc(db, "players", u)); if(snap.exists() && snap.data().password === p) { setCurrentUser(snap.data()); startGame(snap.data()); } else { alert("Error"); }
    };
    document.getElementById('signupButton').onclick = async () => {
        const u = document.getElementById('signup-username').value.trim(); const p = document.getElementById('signup-password').value.trim();
        const newUser = { username: u, password: p, coins: 0, level: 1, items: [], discoveredFish: [], pearls:0, prestige:0, fishCounts:{}, guild: null }; 
        await savePlayerToCloud(newUser); alert("Created!"); location.reload();
    };

    (async function() { const s = getCurrentUser(); if(s) startGame(s); })();
    
    // --- MISSING FUNCTIONS FROM PREVIOUS PROMPT (Re-added for completeness) ---
    window.renderShop = function() {
      const u = getCurrentUser();
      const upgradeCost = (u.maxItems || 15) * 50;
      const upgradeHTML = `<div class="bp-item upgrade-item"><h3>Expand Bag</h3><p>${u.maxItems} -> ${u.maxItems+5}</p><button class="shop-btn btn-buy" onclick="window.buyBag()">Buy ${upgradeCost}g</button></div>`;
      const keyHTML = `<div class="bp-item item-key"><h3>üîë Golden Key</h3><p>Opens Treasure Chests</p><button class="shop-btn btn-buy" onclick="window.buyKey('gold')">10,000g</button><button class="shop-btn btn-pearl" onclick="window.buyKey('pearl')">1 Pearl</button></div>`;
      const rodsHTML = RODS.map(r => {
        const owned = u.ownedRods.includes(r.id); const eq = u.equippedRod === r.id;
        let btn = eq ? `<button class="shop-btn btn-owned">Equipped</button>` : (owned ? `<button class="shop-btn btn-equip" onclick="window.eqRod(${r.id})">Equip</button>` : `<button class="shop-btn btn-buy" onclick="window.buyRod(${r.id})">${r.cost}g</button>`);
        return `<div class="bp-item"><h3>${r.icon} ${r.name}</h3><p>${r.luck}x Luck</p>${btn}</div>`;
      }).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üõí Rod Shop</h2><div class="bp-grid">${upgradeHTML}${keyHTML}${rodsHTML}</div>`; updateHud();
    };
    window.buyBag = function() { const u = getCurrentUser(); const c = u.maxItems * 50; if(u.coins >= c) { u.coins -= c; u.maxItems += 5; setCurrentUser(u); savePlayerToCloud(u); window.renderShop(); } };
    window.buyKey = function(type) { const u = getCurrentUser(); if(type==='gold' && u.coins>=10000){ u.coins-=10000; u.items.push({name:'Golden Key', type:'key', value:0}); } else if(type==='pearl' && u.pearls>=1){ u.pearls--; u.items.push({name:'Golden Key', type:'key', value:0}); } else return alert("Not enough currency"); setCurrentUser(u); savePlayerToCloud(u); window.renderShop(); };
    window.buyRod = function(id) { const u = getCurrentUser(); const r = RODS[id]; if(u.coins >= r.cost) { u.coins -= r.cost; u.ownedRods.push(id); u.equippedRod = id; setCurrentUser(u); savePlayerToCloud(u); window.renderShop(); } };
    window.eqRod = function(id) { const u = getCurrentUser(); u.equippedRod = id; setCurrentUser(u); savePlayerToCloud(u); window.renderShop(); };
    window.confirmRetire = function() { const u = getCurrentUser(); if(u.level<50)return; const p = 10+(u.level-50); if(confirm(`Retire for ${p} Pearls? Resets Gold/Level.`)){ u.pearls+=p; u.prestige++; u.level=1; u.xp=0; u.coins=0; u.ownedRods=[0]; u.equippedRod=0; u.items=u.items.filter(i=>i.type==='chest'||i.type==='key'); setCurrentUser(u); savePlayerToCloud(u); location.reload(); } };
    function renderMarket() { const u = getCurrentUser(); const profit = u.items.filter(i=>!i.favorite && i.type!=='chest' && i.type!=='key').reduce((s,i)=>s+i.value,0); let h = u.items.map((i,x)=>{ if(i.type==='chest'||i.type==='key')return''; return `<div class="bp-item"><div><b>${i.name}</b> ${i.value}g</div><button class="market-sell-btn" onclick="window.sellOne(${x})">Sell</button></div>`; }).join(''); mainContent.innerHTML = `${renderHudHTML()}<h2>üè™ Fishmonger</h2><button class="sell-all-btn" onclick="window.sellAll()">Sell All (${profit}g)</button><div class="bp-grid">${h}</div>`; updateHud(); }
    window.sellOne = function(i) { const u = getCurrentUser(); u.coins+=u.items[i].value; u.items.splice(i,1); setCurrentUser(u); savePlayerToCloud(u); renderMarket(); };
    window.sellAll = function() { const u = getCurrentUser(); const s = u.items.filter(i=>!i.favorite && i.type!=='chest' && i.type!=='key'); u.coins+=s.reduce((a,b)=>a+b.value,0); u.items=u.items.filter(i=>i.favorite||i.type==='chest'||i.type==='key'); setCurrentUser(u); savePlayerToCloud(u); renderMarket(); };
    window.openChest = function(i) { const u = getCurrentUser(); const k = u.items.findIndex(x=>x.type==='key'); if(k===-1)return alert("No Key"); u.items.splice(i,1); u.items.splice(k<i?k:k-1,1); const r=Math.random(); let m=""; if(r<0.1){const p=1+Math.floor(Math.random()*2); u.pearls+=p; m=`Found ${p} Pearls!`;} else {const g=5000+Math.floor(Math.random()*15000); u.coins+=g; m=`Found ${g} Gold!`;} alert(m); setCurrentUser(u); savePlayerToCloud(u); renderBackpack(); };
    function renderBackpack() { const u = getCurrentUser(); const h = u.items.map((i,x)=>`<div class="bp-item ${i.type==='chest'?'item-chest':''}">${getEntityIcon(i)}<div>${i.name}<br>${i.value||''}</div>${i.type==='chest'?`<button class="btn-sm" style="background:#e040fb" onclick="window.openChest(${x})">Open</button>`:''}</div>`).join(''); mainContent.innerHTML=`${renderHudHTML()}<h2>üéí Bag</h2><div class="bp-grid">${h}</div>`; updateHud(); }

  </script>
</body>
</html>
