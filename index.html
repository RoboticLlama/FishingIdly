<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fishing Idly</title>
  <style>
    /* --- Global & Layout --- */
    body {
      background-color: #1b2735;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      margin: 0; 
      height: 100vh; 
      overflow: hidden; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
      user-select: none;
      transition: background 1s ease, box-shadow 1s ease;
    }
    
    h1 { font-size: 3rem; margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 3px; }
    
    button {
      background-color: #3a506b; color: #fff; border: none; padding: 1rem 2rem;
      font-size: 1.1rem; border-radius: 10px; cursor: pointer; transition: background-color .2s;
    }
    button:hover { background-color: #5bc0be; color:#1b2735; }
    button:disabled { background-color: #2b394d; color: #9aa7b7; cursor: not-allowed; }

    /* --- PIXEL ART STYLES --- */
    .pixel-icon { width: 64px; height: 64px; object-fit: contain; image-rendering: pixelated; image-rendering: crisp-edges; }
    .emoji-icon { font-size: 2rem; }

    /* --- Landing & Overlay --- */
    .signin-top { position: absolute; top: 20px; right: 30px; background: #3a506b; color:#e0e0e0; padding:.5rem 1rem; border-radius:8px; text-decoration:none; }
    .overlay { position: fixed; inset:0; background: rgba(0,0,0,.65); display:flex; justify-content:center; align-items:center; z-index: 50; }
    .signin-box {
      background: linear-gradient(135deg, #2a3d56, #3a506b);
      padding: 2rem; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,.4);
      width: 300px; text-align:center; transform: scale(.8); opacity: 0; animation: pop .3s forwards;
    }
    .signin-box input { width: 90%; padding: .7rem; margin: .5rem 0; border: none; border-radius: 8px; outline: none; background:#1b2735; color:#e0e0e0; }
    .toggle-link { display:block; margin-top:1rem; color:#9ad4d6; cursor:pointer; text-decoration:underline; font-size:.9rem; }
    @keyframes pop { to { transform: scale(1); opacity: 1; } }

    /* --- Game UI Layout (Restored to Old Look) --- */
    .game-container { 
      display: none; 
      width: 100%; 
      height: 100vh; 
      flex-direction: row; 
      background-color: transparent; 
      position: relative; 
    }

    .sidebar {
      width: 240px; 
      background: #2a3d56; 
      display: flex; 
      flex-direction: column; 
      justify-content: space-between; /* Keeps Nav at top, Admin/Logout at bottom */
      align-items: center; 
      padding: 16px 10px; 
      border-right: 2px solid #5bc0be;
      box-sizing: border-box; 
      z-index: 10;
    }

    .nav-buttons { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      width: 100%; 
    }
    
    .nav-buttons button { 
      width: 95%; 
      margin: 6px 0; 
      background: #3a506b; 
      font-size: 0.95rem; 
      padding: 0.8rem; 
      text-align: left; 
    }
    .nav-buttons button:hover { background: #5bc0be; color: #1b2735; }
    
    .retire-btn { background: #673ab7 !important; border: 1px solid #9575cd; display:none; }
    .retire-btn:hover { background: #9575cd !important; }

    /* Admin & Logout Container at bottom */
    .sidebar-footer {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 10px;
    }

    .logout-btn { background: #b0413e; width: 95%; font-size: 0.9rem; padding: 0.6rem; }
    .logout-btn:hover { background: #e24e4b; }

    .admin-panel { width: 95%; background: rgba(0,0,0,.18); border-radius: 10px; padding: 10px; margin-bottom: 10px; font-size: .9rem; }
    .admin-title { font-weight: 700; opacity: .9; margin-bottom: 6px; text-align: center; color: #ff7a7a; }
    .admin-row { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; }
    .btn-sm { padding: .3rem .6rem; border-radius: 6px; font-size: 0.8rem; min-width: auto; }
    .admin-reset-btn { background: #7a1f1b; width: 95%; margin-bottom: 10px; font-size: 0.9rem; padding: 0.6rem; }
    .admin-reset-btn:hover { background: #a52b25; }

    .main-content { 
      flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; 
      text-align: center; padding: 30px; position: relative; 
    }
    
    /* --- HUD --- */
    .hud {
      position: absolute; top: 12px; right: 16px;
      background: rgba(15, 24, 36, 0.95); padding: 12px 18px; border-radius: 12px; font-size: .95rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,.1) inset;
      z-index: 100; min-width: 280px; border: 1px solid #5bc0be;
    }
    .hud-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 10px; }
    .hud-stat-box { 
      background: rgba(0,0,0,0.4); padding: 4px 10px; border-radius: 6px; 
      flex: 1; text-align: center; border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-label { display: block; font-size: 0.65rem; color: #aaa; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
    .stat-value { font-weight: bold; font-size: 1.1rem; }
    
    /* XP Bar Styles */
    .xp-container { 
        width: 100%; height: 14px; background: #111; border-radius: 4px; 
        overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1);
        cursor: help; 
    }
    .xp-fill { height: 100%; background: linear-gradient(90deg, #a06cd5, #b886e6); width: 0%; transition: width 0.3s ease-out; }
    /* XP Hover Tooltip */
    .xp-text {
        position: absolute; width: 100%; text-align: center; top: 0; left: 0;
        font-size: 0.65rem; line-height: 14px; color: #fff; font-weight: bold;
        opacity: 0; transition: opacity 0.2s; pointer-events: none;
        text-shadow: 0 0 3px #000; z-index: 2;
    }
    .xp-container:hover .xp-text { opacity: 1; }

    .hud-currency { display: flex; gap: 10px; }

    /* --- CHAT SYSTEM --- */
    .chat-container {
      position: absolute; bottom: 20px; right: 20px;
      width: 300px; height: 250px;
      background: rgba(15, 24, 36, 0.85);
      border: 1px solid #5bc0be; border-radius: 12px;
      display: flex; flex-direction: column; overflow: hidden;
      z-index: 200; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    .chat-messages { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column-reverse; font-size: 0.85rem; gap: 6px; text-align: left; }
    .chat-input-area { display: flex; border-top: 1px solid rgba(91,192,190,0.3); background: rgba(0,0,0,0.2); }
    .chat-input-area input { flex: 1; background: transparent; border: none; color: #fff; padding: 8px 12px; outline: none; font-family: inherit; font-size: 0.85rem; }
    .chat-send-btn { background: transparent; border:none; color: #5bc0be; padding: 0 12px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
    .msg-row { line-height: 1.3; }
    .msg-user { color: #5bc0be; font-weight: bold; margin-right: 5px; }
    .msg-system { color: #ffcc00; font-style: italic; background: rgba(255, 204, 0, 0.1); padding: 2px 4px; border-radius: 4px; display: block; border-left: 2px solid #ffcc00; }

    /* --- POND & MINIGAME --- */
    .pond-wrap { max-width: 800px; width: 100%; height: 500px; position: relative; display: flex; flex-direction: column; align-items: center; }
    .pond-header { width: 100%; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
    .back-inline { position: absolute; left: 0; padding: .5rem 1rem; border-radius: 8px; font-size: 0.9rem; }
    .location-btn { margin: 10px; width: 200px; }
    .status { margin: 10px 0; font-size: 1.1rem; min-height: 1.5em; color: #9ad4d6; }
    .wait-bar { position: relative; height: 10px; width: 200px; background: #0f1824; border-radius: 8px; overflow: hidden; margin: 10px auto; display: none; }
    .wait-fill { height: 100%; width: 0%; background: #5bc0be; transition: width 0.1s linear; }
    .minigame-area { position: relative; width: 100%; height: 350px; background: rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; display: none; cursor: crosshair; }
    .game-bar-container { width: 100%; max-width: 400px; height: 20px; background: #2b1d1d; border: 2px solid #555; border-radius: 10px; margin-bottom: 10px; position: relative; display: none; overflow: hidden; }
    .game-bar-fill { height: 100%; width: 35%; background: linear-gradient(90deg, #ff8a00, #e52e71); transition: width 0.1s linear; }
    .target-circle { position: absolute; width: 50px; height: 50px; background: #5bc0be; border-radius: 50%; transform: translate(-50%, -50%); z-index: 5; pointer-events: auto; box-shadow: 0 0 10px rgba(91,192,190,0.5); }
    .target-ring { position: absolute; width: 150px; height: 150px; border: 4px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); z-index: 4; pointer-events: none; opacity: 0.8; }

    /* --- MARKET & SHOP --- */
    .bp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; width: 100%; max-height: 60vh; overflow-y: auto; padding: 10px; }
    .bp-item { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
    .shop-btn { width: 100%; padding: 6px; font-size: 0.9rem; margin-top: 5px; }
    .btn-buy { background: #4caf50; } .btn-buy:hover { background: #66bb6a; }
    .btn-pearl { background: #e040fb; color: #fff; } .btn-pearl:hover { background: #ea80fc; }
    .btn-equip { background: #5bc0be; color: #1b2735; }
    .btn-owned { background: #555; color: #aaa; cursor: default; }
    .market-sell-btn { margin-top: 8px; font-size: 0.8rem; padding: 4px 10px; width: 100%; background: #4caf50; color: white; border:none; cursor: pointer; border-radius: 4px; }
    .market-sell-btn:hover { background: #66bb6a; }
    
    .item-chest { border: 1px solid #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.2); }
    .item-key { border: 1px solid #00e5ff; }
    .star-btn { position: absolute; top: 4px; right: 4px; background: none; border: none; padding: 0; font-size: 1.4rem; cursor: pointer; color: rgba(255,255,255,0.3); z-index: 10; }
    .star-btn.fav-active { color: #ffd700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.6); opacity: 1; }
    .market-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
    .market-price-input { width: 80%; background: #111; border: 1px solid #444; color: white; padding: 4px; border-radius: 4px; margin-top: 5px; text-align: center; }
    .listing-seller { font-size: 0.7rem; color: #aaa; position: absolute; top: 5px; left: 5px; }

    /* --- INDEX & QUESTS --- */
    .index-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; width: 100%; max-height: 60vh; overflow-y: auto; padding: 10px; }
    .index-card { background: rgba(0,0,0,0.3); border: 2px solid #2a3d56; border-radius: 12px; padding: 15px; text-align: center; opacity: 0.4; filter: grayscale(1); transition: all 0.3s; }
    .index-card.unlocked { opacity: 1; filter: none; border-color: #5bc0be; background: rgba(91,192,190,0.1); }
    .index-name { font-size: 0.8rem; margin-top: 8px; font-weight: bold; }
    .index-rarity { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
    .index-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
    .tab-btn { background: #2a3d56; border: 1px solid #5bc0be; color: #5bc0be; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
    .tab-btn:hover { background: rgba(91,192,190,0.2); }
    .tab-btn.active { background: #5bc0be; color: #1b2735; font-weight: bold; box-shadow: 0 0 10px rgba(91,192,190,0.4); }

    .quest-card { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; flex-direction: row; align-items: center; justify-content: space-between; }
    .quest-info { text-align: left; flex: 1; margin-left: 15px; }
    .quest-title { font-weight: bold; font-size: 1rem; color: #ffd700; margin-bottom: 4px; }
    .quest-desc { font-size: 0.85rem; color: #aaa; margin-bottom: 8px; }
    .quest-progress-bg { width: 100%; height: 10px; background: #222; border-radius: 5px; overflow: hidden; }
    .quest-progress-fill { height: 100%; background: #5bc0be; transition: width 0.3s; }
    .quest-reward-btn { background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
    .quest-reward-btn:disabled { background: #333; color: #666; cursor: default; }
    .quest-done-badge { background: #333; color: #888; padding: 8px 16px; border-radius: 8px; font-size:0.8rem; }
    .quest-turnin-btn { background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
    .quest-turnin-btn:hover { background: #42a5f5; }

    /* --- HOME & LEADERBOARD --- */
    .home-header { display:flex; justify-content:space-between; align-items:center; width:100%; max-width:700px; margin-bottom:15px; }
    .passive-info { background:rgba(0,0,0,0.3); padding:8px 15px; border-radius:8px; font-size:0.9rem; border:1px solid rgba(255,255,255,0.1); }
    .claim-btn { background: #ffd700; color: #1b2735; font-weight:bold; padding: 0.6rem 1.2rem; } .claim-btn:hover { background: #ffea70; } .claim-btn:disabled { background: #555; color: #888; }
    .slot-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; width: 100%; max-width: 750px; }
    .home-slot { background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2); border-radius: 10px; height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; transition: all 0.2s; }
    .slot-locked { background: rgba(0,0,0,0.4); border-color: #444; opacity: 0.7; }
    .slot-occupied { border-style: solid; border-color: #5bc0be; background: rgba(91,192,190,0.1); }
    .slot-fish-name { font-size: 0.75rem; font-weight: bold; max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Mutations */
    .mut-Shiny { border-color: #ffcc00; } .mut-Sparkling { border-color: #00ccff; box-shadow: 0 0 5px #00ccff; } .mut-Mythical { border-color: #ff00ff; } .mut-Albino { border-color: #ffffff; }
    .txt-Shiny { color: #ffcc00; } .txt-Sparkling { color: #00ccff; } .txt-Mythical { color: #ff00ff; } .txt-Albino { color: #fff; }
    
    .lb-list { width: 100%; max-width: 500px; text-align: left; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; }
    .lb-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); align-items: center; }
    .lb-rank { width: 40px; font-weight: bold; text-align: center; }
    .rank-1 { color: #ffd700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }

    /* --- CLUBS --- */
    .club-header { margin-bottom: 20px; border-bottom: 2px solid #5bc0be; padding-bottom: 10px; }
    .club-buff { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; padding: 10px; border-radius: 8px; margin-bottom: 15px; color: #81c784; }
    .club-buff.inactive { background: rgba(255, 255, 255, 0.05); border-color: #555; color: #888; }
    .club-member-list { width: 100%; max-width: 500px; margin: 0 auto; text-align: left; }
    .member-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); align-items: center; }
    .online-dot { height: 10px; width: 10px; background-color: #555; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .online-dot.active { background-color: #4caf50; box-shadow: 0 0 5px #4caf50; }
    
    /* Selector & Profile */
    .selector-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(27, 39, 53, 0.95); z-index: 50; display: flex; flex-direction: column; align-items: center; padding-top: 40px; }
    .selector-close { position: absolute; top: 20px; right: 20px; }
    .profile-box { width: 600px; max-width: 95%; max-height: 90vh; overflow-y: auto; }
    .profile-header { margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .profile-stats { font-size: 0.9rem; opacity: 0.8; margin-top: 5px; }
    
    /* Weather & Time */
    .weather-indicator { font-size: 0.9rem; margin-top: 5px; padding: 4px 8px; border-radius: 6px; background: rgba(255,255,255,0.1); display:inline-block; }
    body.w-rain { background: radial-gradient(circle, #2a3d56 0%, #1b2735 100%); }
    body.w-storm { background: radial-gradient(circle, #2b1d1d 0%, #0f0f0f 100%); }
    body.w-fog { background: radial-gradient(circle, #4a5a6b 0%, #2f3a46 100%); }
    body.w-heat { background: radial-gradient(circle, #563d2a 0%, #35231b 100%); }
    body.t-night { box-shadow: inset 0 0 200vw rgba(0,0,0,0.85); color: #ccc; }
    body.t-night .main-content { background: rgba(0,0,0,0.4); }
    .time-icon-day { color: #ffd700; } .time-icon-night { color: #b886e6; }
    
    .mastery-info { font-size: 0.7rem; margin-top: 5px; color: #aaa; }
    .mastery-bar-bg { width: 80%; height: 6px; background: #222; margin: 4px auto; border-radius: 3px; overflow: hidden; }
    .mastery-bar-fill { height: 100%; background: #5bc0be; }
    .badge-bronze { border: 2px solid #cd7f32; box-shadow: 0 0 8px rgba(205, 127, 50, 0.4); }
    .badge-silver { border: 2px solid #c0c0c0; box-shadow: 0 0 8px rgba(192, 192, 192, 0.4); }
    .badge-gold { border: 2px solid #ffd700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); animation: pulseGold 2s infinite; }
  </style>
</head>
<body>

  <!-- Landing -->
  <a href="#" class="signin-top" id="signinLink">Sign In</a>
  <h1 id="title">Fishing Idly</h1>
  <button id="startButton">Start</button>

  <!-- Login Modal -->
  <div class="overlay" id="overlay" style="display:none;">
    <div class="signin-box">
      <div id="signinForm">
        <h2>Sign In</h2>
        <input type="text" id="signin-username" placeholder="Username"/>
        <input type="password" id="signin-password" placeholder="Password"/>
        <button id="loginButton">Log In</button>
        <span class="toggle-link" id="showSignup">Don‚Äôt have an account? Sign Up</span>
      </div>
      <div id="signupForm" style="display:none;">
        <h2>Create Account</h2>
        <input type="email" id="signup-email" placeholder="Email"/>
        <input type="text" id="signup-username" placeholder="Username"/>
        <input type="password" id="signup-password" placeholder="Password"/>
        <button id="signupButton">Sign Up</button>
        <span class="toggle-link" id="showSignin">Already have an account? Sign In</span>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="overlay" id="profileOverlay" style="display:none;">
    <div class="signin-box profile-box">
      <div style="text-align:right;"><button id="closeProfileBtn" style="padding:5px 10px; font-size:0.8rem;">X</button></div>
      <div class="profile-header">
        <h2 id="profName">Player</h2>
        <div class="profile-stats" id="profStats">Lv 1 ¬∑ 0g</div>
      </div>
      <h3>Home Aquarium</h3>
      <div class="passive-info" style="margin-bottom:10px;" id="profPassive">Generating: 0g/hr</div>
      <div class="slot-grid" id="profGrid"></div>
    </div>
  </div>

  <!-- Game UI -->
  <div class="game-container" id="gameContainer">
    <div class="sidebar">
      <div class="nav-buttons">
        <button id="homeBtn">üè† Home</button>
        <button id="fishingSpotBtn">üé£ Fishing Spot</button>
        <button id="backpackBtn">üéí Backpack</button>
        <button id="questsBtn">üìú Daily Quests</button>
        <button id="marketBtn">üè™ Marketplace</button>
        <button id="shopBtn">üõí Rod Shop</button>
        <button id="clubsBtn">‚öîÔ∏è Clubs</button>
        <button id="indexBtn">üìñ Index</button>
        <button id="leaderboardBtn">üèÜ Leaderboard</button>
        <button id="retireBtn" class="retire-btn" onclick="window.confirmRetire()">‚ú® Retire (Prestige)</button>
      </div>
      
      <!-- Footer with Admin and Logout -->
      <div class="sidebar-footer">
        <div id="adminPanel" class="admin-panel" style="display:none;">
          <div class="admin-title">ADMIN TOOLS</div>
          <div class="admin-row"><span>Level</span><div><button class="btn-sm" id="admLvlDown">-</button><button class="btn-sm" id="admLvlUp">+</button></div></div>
          <div class="admin-row"><span>Gold</span><div><button class="btn-sm" id="admGoldDown">-</button><button class="btn-sm" id="admGoldUp">+</button></div></div>
        </div>
        <button class="admin-reset-btn" id="adminResetBtn" style="display:none;">‚ö† RESET ALL DB DATA</button>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
    
    <!-- Main Content (Views load here) -->
    <div class="main-content" id="mainContent">
      <div id="viewArea"></div>
    </div>

    <!-- Global Chat -->
    <div class="chat-container" id="chatContainer" style="display:none;">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Type to chat..." maxlength="80">
        <button class="chat-send-btn" id="chatSendBtn">SEND</button>
      </div>
    </div>
  </div>

  <!-- Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, getDocs, collection, query, orderBy, limit, addDoc, onSnapshot, serverTimestamp, deleteDoc, where, updateDoc, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnoFqUUjddA6ipJSisLOS7MsFklhQKt_w",
      authDomain: "fishingidly-c1613.firebaseapp.com",
      projectId: "fishingidly-c1613",
      storageBucket: "fishingidly-c1613.firebasestorage.app",
      messagingSenderId: "531215063717",
      appId: "1:531215063717:web:dea4ce7aa7a64d3f374b4c",
      measurementId: "G-SR67MT90SE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Track Club Buff Locally
    window.clubBuffActive = false;
    let unsubscribePlayerDoc = null;

    function cleanForFirestore(obj) {
      const cleaned = { ...obj };
      Object.keys(cleaned).forEach(key => { if (cleaned[key] === undefined || cleaned[key] === null) delete cleaned[key]; });
      return cleaned;
    }
    function setCurrentUser(user) { if (!user) return; localStorage.setItem('currentUser', JSON.stringify(cleanForFirestore(user))); }
    function getCurrentUser() { try { return JSON.parse(localStorage.getItem('currentUser')); } catch { return null; } }
    async function savePlayerToCloud(user) { if (!user || !user.username) return; await setDoc(doc(db, "players", user.username), cleanForFirestore(user), { merge: true }); }
    async function getAllPlayers() { const snap = await getDocs(collection(db, "players")); return snap.docs.map(d => d.data()); }
    async function getPlayerProfile(username) { const snap = await getDoc(doc(db, "players", username)); return snap.exists() ? snap.data() : null; }

    function getEntityIcon(item) {
        if (item.type === 'chest') return `<span class="emoji-icon">üéÅ</span>`;
        if (item.type === 'key') return `<span class="emoji-icon">üîë</span>`;
        if (item.img && item.img !== "placeholder.png") { return `<img src="assets/fish/${item.img}" class="pixel-icon" alt="${item.name}">`; }
        if (item.type === 'trash') return `<span class="emoji-icon">üëû</span>`;
        return `<span class="emoji-icon">üêü</span>`;
    }

    const RODS = [
      { id: 0, name: "Bamboo Rod", cost: 0, luck: 1.0, speed: 1.0, icon: "üéã" },
      { id: 1, name: "Fiberglass Rod", cost: 1500, luck: 1.2, speed: 1.1, icon: "üé£" },
      { id: 2, name: "Carbon Rod", cost: 5000, luck: 1.5, speed: 1.3, icon: "üî©" },
      { id: 3, name: "Lucky Rod", cost: 15000, luck: 2.5, speed: 1.0, icon: "üçÄ" },
      { id: 4, name: "Speedy Rod", cost: 15000, luck: 1.1, speed: 2.0, icon: "‚ö°" },
      { id: 5, name: "Golden Rod", cost: 50000, luck: 3.0, speed: 2.0, icon: "üëë" },
      { id: 6, name: "Poseidon's Trident", cost: 250000, luck: 5.0, speed: 3.0, icon: "üî±" }
    ];

    const LOCATION_CONFIG = {
      pond:   { id: 'pond',   name: 'Pond',   mult: 1.0, xpMult: 1.0 },
      stream: { id: 'stream', name: 'Stream', mult: 1.5, xpMult: 1.5 }
    };

    const pondTable = [
      { name: "Treasure Chest", type: "chest", img: "placeholder.png", minKg: 10, maxKg: 10, pricePerKg: 0, rarity: "legendary", chanceWeight: 0.5 },
      { name: "Old Boot", type: "trash", img: "placeholder.png", minKg: 0.5, maxKg: 1.5, pricePerKg: 1, rarity: "trash", chanceWeight: 10 },
      { name: "Tin Can", type: "trash", img: "placeholder.png", minKg: 0.1, maxKg: 0.3, pricePerKg: 1, rarity: "trash", chanceWeight: 8 },
      { name: "Pumpkinseed", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.4, pricePerKg: 4, rarity: "common", chanceWeight: 20, time: ['day'] },
      { name: "Yellow Perch", type: "fish", img: "placeholder.png", minKg: 0.2, maxKg: 1.0, pricePerKg: 5, rarity: "common", chanceWeight: 20, time: ['day'] },
      { name: "Walleye", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 4.0, pricePerKg: 6, rarity: "common", chanceWeight: 20, time: ['night'] }, 
      { name: "Bluegill", type: "fish", img: "placeholder.png", minKg: 0.3, maxKg: 1.2, pricePerKg: 6, rarity: "uncommon", chanceWeight: 12, weather: ['clear', 'heat'], time: ['day'] }, 
      { name: "Catfish", type: "fish", img: "placeholder.png", minKg: 2.0, maxKg: 10.0, pricePerKg: 4, rarity: "uncommon", chanceWeight: 10, weather: ['rain', 'storm'], time: ['night'] }, 
      { name: "Carp", type: "fish", img: "placeholder.png", minKg: 3.0, maxKg: 15.0, pricePerKg: 3, rarity: "uncommon", chanceWeight: 10, weather: ['fog'] }, 
      { name: "Goldfish", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.8, pricePerKg: 20, rarity: "rare", chanceWeight: 8, weather: ['clear'], time: ['day'] },
      { name: "Largemouth Bass", type: "fish", img: "placeholder.png", minKg: 1.5, maxKg: 5.0, pricePerKg: 8, rarity: "epic", chanceWeight: 5, weather: ['storm'] }, 
      { name: "Golden Koi", type: "fish", img: "placeholder.png", minKg: 2.0, maxKg: 8.0, pricePerKg: 15, rarity: "legendary", chanceWeight: 2, weather: ['heat'], time: ['day'] } 
    ];

    const streamTable = [
      { name: "Treasure Chest", type: "chest", img: "placeholder.png", minKg: 10, maxKg: 10, pricePerKg: 0, rarity: "legendary", chanceWeight: 0.5 },
      { name: "Waterlogged Branch", type: "trash", img: "placeholder.png", minKg: 1.0, maxKg: 5.0, pricePerKg: 1, rarity: "trash", chanceWeight: 10 },
      { name: "Creek Chub", type: "fish", img: "placeholder.png", minKg: 0.1, maxKg: 0.5, pricePerKg: 4, rarity: "common", chanceWeight: 20, time: ['day'] },
      { name: "Fallfish", type: "fish", img: "placeholder.png", minKg: 0.2, maxKg: 1.0, pricePerKg: 4, rarity: "common", chanceWeight: 20, time: ['day'] },
      { name: "White Sucker", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 2.5, pricePerKg: 5, rarity: "common", chanceWeight: 15, weather: ['fog', 'rain'], time: ['night'] },
      { name: "Smallmouth Bass", type: "fish", img: "placeholder.png", minKg: 0.8, maxKg: 4.0, pricePerKg: 10, rarity: "uncommon", chanceWeight: 12, weather: ['heat', 'clear'], time: ['day'] },
      { name: "Rock Bass", type: "fish", img: "placeholder.png", minKg: 0.3, maxKg: 1.5, pricePerKg: 7, rarity: "uncommon", chanceWeight: 12, time: ['night'] },
      { name: "Rainbow Darter", type: "fish", img: "placeholder.png", minKg: 0.02, maxKg: 0.15, pricePerKg: 20, rarity: "uncommon", chanceWeight: 8, weather: ['rain'] }, 
      { name: "Brook Trout", type: "fish", img: "placeholder.png", minKg: 0.5, maxKg: 4.0, pricePerKg: 16, rarity: "rare", chanceWeight: 6, time: ['day'] },
      { name: "Atlantic Salmon", type: "fish", img: "placeholder.png", minKg: 2.0, maxKg: 12.0, pricePerKg: 28, rarity: "epic", chanceWeight: 3, weather: ['storm'] },
      { name: "Ancient River Sturgeon", type: "fish", img: "placeholder.png", minKg: 10.0, maxKg: 50.0, pricePerKg: 45, rarity: "legendary", chanceWeight: 1, weather: ['storm', 'rain'], time: ['night'] }
    ];

    const mutations = [
      { name: "Normal", mult: 1.0, chance: 0.85 },
      { name: "Shiny", mult: 1.85, chance: 0.08 },
      { name: "Sparkling", mult: 1.85, chance: 0.04 },
      { name: "Albino", mult: 1.15, chance: 0.02 },
      { name: "Mythical", mult: 4.5, chance: 0.01 }
    ];

    const difficultyMap = { trash: 2500, common: 2000, uncommon: 1700, rare: 1400, epic: 1100, legendary: 800 };
    const SLOT_COSTS = [0, 500, 1500, 3000, 5000, 10000, 20000, 50000, 100000, 250000];
    const XP_RATES = { trash: 2, common: 10, uncommon: 25, rare: 60, epic: 150, legendary: 500 };

    function getTimeState() {
      const hour = new Date().getHours();
      return (hour >= 6 && hour < 18) ? 'day' : 'night';
    }

    const WEATHER_TYPES = [
      { id: 'rain',  name: 'Rain',     chance: 0.05, icon: 'üåßÔ∏è', luck: 1.2, speed: 1.0, value: 1.0 },
      { id: 'storm', name: 'Storm',    chance: 0.05, icon: '‚õàÔ∏è', luck: 1.5, speed: 1.3, value: 1.0 },
      { id: 'fog',   name: 'Fog',      chance: 0.05, icon: 'üå´Ô∏è', luck: 1.0, speed: 1.1, value: 1.0 },
      { id: 'heat',  name: 'Heatwave', chance: 0.05, icon: 'üî•', luck: 1.0, speed: 1.0, value: 1.2 }
    ];

    function getCurrentWeather() {
      const now = Date.now();
      const sixHours = 6 * 60 * 60 * 1000;
      const blockIndex = Math.floor(now / sixHours);
      const x = Math.sin(blockIndex) * 10000;
      const rand = x - Math.floor(x);
      let accumulated = 0;
      for (const w of WEATHER_TYPES) {
        accumulated += w.chance;
        if (rand < accumulated) return w;
      }
      return { id: 'clear', name: 'Clear', chance: 0.80, icon: '‚òÄÔ∏è', luck: 1.0, speed: 1.0, value: 1.0 };
    }

    function applyVisuals() {
      const w = getCurrentWeather();
      const t = getTimeState();
      document.body.className = `w-${w.id} t-${t}`;
    }

    function initUserData(user) {
      let changed = false;
      if (!user.home || !user.home.slots) {
        user.home = { lastClaim: Date.now(), slots: Array(10).fill(null).map((_, i) => ({ id: i, unlocked: i === 0, fish: null })) };
        changed = true;
      }
      if (!user.ownedRods) { user.ownedRods = [0]; changed = true; }
      if (user.equippedRod === undefined) { user.equippedRod = 0; changed = true; }
      if (!user.maxItems) { user.maxItems = 15; changed = true; }
      if (!user.unlockedLocations) { user.unlockedLocations = ["pond"]; changed = true; }
      if (!user.discoveredFish) { user.discoveredFish = []; changed = true; }
      if (!user.dailyQuests) { user.dailyQuests = []; changed = true; }
      if (!user.lastQuestReset) { user.lastQuestReset = 0; changed = true; }
      if (!user.fishCounts) { user.fishCounts = {}; changed = true; }
      if (user.pearls === undefined) { user.pearls = 0; changed = true; }
      if (user.prestige === undefined) { user.prestige = 0; changed = true; }
      // CLUBS INIT
      if (user.clubName === undefined) { user.clubName = null; changed = true; }
      if (user.clubTag === undefined) { user.clubTag = null; changed = true; } // NEW: Ensure clubTag exists on player
      if (user.lastSeen === undefined) { user.lastSeen = Date.now(); changed = true; }
      
      if (changed) { setCurrentUser(user); savePlayerToCloud(user); }
      return user;
    }

    function getEquippedRod(user) {
      return RODS.find(r => r.id === user.equippedRod) || RODS[0];
    }

    function generateFish(locationTable, luckMultiplier = 1.0, locationName, fishCounts = {}) {
      const w = getCurrentWeather();
      const t = getTimeState();
      luckMultiplier *= w.luck;
      const validFishTable = locationTable.filter(item => {
        if (item.weather && !item.weather.includes(w.id)) return false;
        if (item.time && !item.time.includes(t)) return false;
        return true;
      });
      const adjustedTable = validFishTable.map(item => {
        let weight = item.chanceWeight;
        if (item.rarity !== 'trash' && item.rarity !== 'common' && item.type !== 'chest') { weight = weight * luckMultiplier; }
        return { ...item, activeWeight: weight };
      });
      const totalW = adjustedTable.reduce((sum, item) => sum + item.activeWeight, 0);
      let r = Math.random() * totalW;
      let species = adjustedTable[0];
      for (const item of adjustedTable) { if ((r -= item.activeWeight) <= 0) { species = item; break; } }
      const weightRaw = species.minKg + Math.random() * (species.maxKg - species.minKg);
      const weight = parseFloat(weightRaw.toFixed(2));
      let sizeLabel = "";
      const percent = (weight - species.minKg) / (species.maxKg - species.minKg);
      if (percent > 0.90) sizeLabel = "Giant";
      else if (percent > 0.70) sizeLabel = "Big";
      let mut = mutations[0]; 
      if (species.type !== 'trash' && species.type !== 'chest') {
        const rollRare = Math.random();
        if (rollRare < 0.01 * luckMultiplier) mut = mutations.find(m => m.name === "Mythical");
        else if (rollRare < 0.03 * luckMultiplier) mut = mutations.find(m => m.name === "Albino");
        else if (rollRare < 0.07 * luckMultiplier) mut = mutations.find(m => m.name === "Sparkling");
        else if (rollRare < 0.15 * luckMultiplier) mut = mutations.find(m => m.name === "Shiny");
      }
      let sizeMult = 1.0;
      if (sizeLabel === "Giant") sizeMult = 2.0;
      else if (sizeLabel === "Big") sizeMult = 1.2;
      const locConfig = LOCATION_CONFIG[locationName] || LOCATION_CONFIG.pond;
      const locMult = locConfig.mult || 1.0;
      let val = Math.ceil(weight * species.pricePerKg * mut.mult * sizeMult * locMult);
      const count = fishCounts[species.name] || 0;
      if (count >= 100) val = Math.ceil(val * 1.05);
      val = Math.ceil(val * w.value);
      return {
        name: species.name, type: species.type, rarity: species.rarity,
        weight: weight, mutation: mut.name, size: sizeLabel, value: val,
        favorite: false, origin: locationName, img: species.img
      };
    }

    function checkAndResetQuests(user) {
      const now = new Date();
      const last = new Date(user.lastQuestReset || 0);
      const isNextDay = now.getDate() !== last.getDate() || now.getMonth() !== last.getMonth() || now.getFullYear() !== last.getFullYear();
      if (isNextDay || user.dailyQuests.length === 0) { generateNewQuests(user); return true; }
      return false;
    }

    function generateNewQuests(user) {
      let pool = [...pondTable];
      if (user.unlockedLocations.includes("stream")) { pool = [...pool, ...streamTable]; }
      const fishOnly = pool.filter(i => i.type === 'fish');
      const newQuests = [];
      const questCount = 3; 
      for(let i=0; i < questCount; i++) {
        const randomFish = fishOnly[Math.floor(Math.random() * fishOnly.length)];
        let needed = 1;
        if (randomFish.rarity === 'common') needed = Math.floor(Math.random() * 3) + 3;
        else if (randomFish.rarity === 'uncommon') needed = Math.floor(Math.random() * 2) + 2;
        else needed = 1;
        const reward = Math.ceil(randomFish.pricePerKg * 1.5 * 10 * needed) + 100;
        newQuests.push({ id: Date.now() + i, target: randomFish.name, img: randomFish.img, needed: needed, current: 0, reward: reward, claimed: false });
      }
      user.dailyQuests = newQuests;
      user.lastQuestReset = Date.now();
    }

    // --- GLOBAL UI ELEMENTS ---
    const overlay = document.getElementById('overlay');
    const profileOverlay = document.getElementById('profileOverlay');
    const startButton = document.getElementById('startButton');
    const signinLink = document.getElementById('signinLink');
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    const gameContainer = document.getElementById('gameContainer');
    const mainContent = document.getElementById('mainContent');
    const adminPanel = document.getElementById('adminPanel');
    const adminResetBtn = document.getElementById('adminResetBtn');

    document.getElementById('showSignup').onclick = () => { signinForm.style.display='none'; signupForm.style.display='block'; };
    document.getElementById('showSignin').onclick = () => { signupForm.style.display='none'; signinForm.style.display='block'; };
    const openModal = () => overlay.style.display = 'flex';
    signinLink.onclick = openModal;
    startButton.onclick = openModal;
    overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
    document.getElementById('closeProfileBtn').onclick = () => profileOverlay.style.display = 'none';
    profileOverlay.onclick = (e) => { if (e.target === profileOverlay) profileOverlay.style.display = 'none'; };

    function renderHudHTML() { return `<div class="hud" id="hudEl">Loading...</div>`; }
    
    function updateHud() {
      const u = getCurrentUser();
      const el = document.getElementById('hudEl');
      applyVisuals();
      const w = getCurrentWeather();
      const t = getTimeState(); 
      const timeIcon = t === 'day' ? '‚òÄÔ∏è' : 'üåô';

      const retireBtn = document.getElementById('retireBtn');
      if (u.level >= 50) { retireBtn.style.display = 'block'; }
      else { retireBtn.style.display = 'none'; }

      if (u && el) {
        const xpCurrent = u.xp || 0;
        const xpNeeded = u.level * 100;
        const pct = Math.min(100, Math.max(0, (xpCurrent / xpNeeded) * 100));
        const items = u.items ? u.items.length : 0;
        const max = u.maxItems || 15;
        const bagColor = items >= max ? '#ff7a7a' : '#5bc0be';
        
        el.innerHTML = `
          <div class="hud-row">
            <span style="font-weight:bold; color:#fff; font-size: 1.1rem;">üë§ ${u.username}</span>
            <span style="font-size:0.75rem; color:${bagColor}; background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">üéí ${items}/${max}</span>
          </div>
          <div class="hud-row">
            <div class="hud-stat-box" style="border-color: #7986cb;">
              <span class="stat-label" style="color:#7986cb;">Prestige</span>
              <span class="stat-value" style="color:#fff;">üîµ ${u.prestige || 0}</span>
            </div>
            <div class="hud-stat-box" style="border-color: #a06cd5;">
              <span class="stat-label" style="color:#a06cd5;">Level</span>
              <span class="stat-value" style="color:#fff;">‚≠ê ${u.level}</span>
            </div>
          </div>
          <div class="hud-row hud-currency">
            <span style="font-weight:bold; color:#ffd700; font-size:1rem;">üí∞ ${u.coins.toLocaleString()}</span>
            <span style="font-weight:bold; color:#e040fb; font-size:1rem;">‚ö™ ${u.pearls || 0}</span>
          </div>
          
          <div class="xp-container" title="${xpCurrent} / ${xpNeeded} XP">
              <div class="xp-fill" style="width:${pct}%"></div>
              <div class="xp-text">${xpCurrent} / ${xpNeeded} XP</div>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
            <div class="weather-indicator" style="margin:0; font-size:0.8rem;">${w.icon} ${w.name}</div>
            <div class="weather-indicator" style="margin:0; font-size:0.8rem;">${timeIcon} ${t.toUpperCase()}</div>
          </div>
          ${window.clubBuffActive ? '<div style="margin-top:5px; font-size:0.7rem; color:#81c784; text-align:center;">‚öîÔ∏è Clan XP Active! (+5%)</div>' : ''}
        `;
      }
    }

    // --- CHAT SYSTEM ---
    async function sendChatMessage(text, isSystem = false) {
      const u = getCurrentUser();
      if (!u || !u.username) return;
      await addDoc(collection(db, "messages"), {
        username: u.username,
        text: text,
        timestamp: serverTimestamp(),
        isSystem: isSystem
      });
    }

    function initChat() {
      const chatEl = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      
      const q = query(collection(db, "messages"), orderBy("timestamp", "desc"), limit(30));
      onSnapshot(q, (snapshot) => {
        chatEl.innerHTML = '';
        snapshot.forEach((doc) => {
          const m = doc.data();
          const row = document.createElement('div');
          row.className = 'msg-row';
          if (m.isSystem) {
            row.innerHTML = `<span class="msg-system">üì¢ ${m.text}</span>`;
          } else {
            row.innerHTML = `<span class="msg-user">${m.username}:</span><span class="msg-text">${m.text}</span>`;
          }
          chatEl.appendChild(row);
        });
      });

      const handleSend = () => {
        const txt = chatInput.value.trim();
        if (txt) { sendChatMessage(txt); chatInput.value = ''; }
      };

      chatSendBtn.onclick = handleSend;
      chatInput.onkeydown = (e) => { if (e.key === 'Enter') handleSend(); };
    }

    // --- MINIGAME LOGIC ---
    let minigameActive = false; let minigameProgress = 35; let spawnTimer = null; let gameLoop = null;

    window.handleCast = function(locationType) {
      const u = getCurrentUser(); const rod = getEquippedRod(u);
      if (u.items.length >= (u.maxItems || 15)) return alert("Backpack full!");
      const waitFill = document.getElementById('waitFill'); document.getElementById('waitBar').style.display = 'block'; document.getElementById('castBtn').disabled = true;
      const w = getCurrentWeather();
      let speedMult = rod.speed / w.speed; 
      setTimeout(() => waitFill.style.width = '100%', 50);
      setTimeout(() => {
        document.getElementById('waitBar').style.display = 'none';
        const hookedFish = generateFish(locationType === 'stream' ? streamTable : pondTable, rod.luck, locationType, u.fishCounts);
        const count = (u.fishCounts || {})[hookedFish.name] || 0;
        if (count >= 1000) {
          document.getElementById('pondStatus').textContent = "‚ú® Gold Mastery: Instant Catch! ‚ú®";
          endMinigame(true, hookedFish);
        } else {
          startMinigame(hookedFish);
        }
      }, (1000 + Math.random() * 2000) / speedMult);
    };

    function startMinigame(fish) {
      window.currentActiveFish = fish; 
      const area = document.getElementById('minigameArea'); const barFill = document.getElementById('gameBarFill');
      area.style.display = 'block'; document.getElementById('gameBarContainer').style.display = 'block'; document.getElementById('castBtn').style.display = 'none';
      minigameActive = true; minigameProgress = 35; barFill.style.width = '35%'; area.innerHTML = '';
      spawnTimer = setInterval(() => { if(!minigameActive) return; spawnCircle(area, difficultyMap[fish.rarity] || 2000); }, 800);
      gameLoop = requestAnimationFrame(function step() { if (!minigameActive) return; if (minigameProgress <= 0) { endMinigame(false, fish); return; } if (minigameProgress >= 100) { endMinigame(true, fish); return; } requestAnimationFrame(step); });
    }

    function spawnCircle(container, duration) {
      const size = 50; const x = 10 + Math.random() * (container.clientWidth - size - 20); const y = 10 + Math.random() * (container.clientHeight - size - 20);
      const target = document.createElement('div'); target.className = 'target-circle'; target.style.left = x + 'px'; target.style.top = y + 'px';
      const ring = document.createElement('div'); ring.className = 'target-ring'; ring.style.left = x + 'px'; ring.style.top = y + 'px';
      ring.style.transition = `width ${duration}ms linear, height ${duration}ms linear`; container.appendChild(target); container.appendChild(ring);
      requestAnimationFrame(() => { ring.style.width = '50px'; ring.style.height = '50px'; });
      let clicked = false;
      target.onmousedown = (e) => { 
        e.stopPropagation(); if(clicked) return; clicked = true; 
        let prog = 15;
        const u = getCurrentUser();
        if (window.currentActiveFish && (u.fishCounts||{})[window.currentActiveFish.name] >= 500) { prog = 16.5; }
        minigameProgress += prog; 
        document.getElementById('gameBarFill').style.width = minigameProgress+'%'; remove(); 
      };
      setTimeout(() => { if (!clicked && document.body.contains(target)) { minigameProgress -= 10; document.getElementById('gameBarFill').style.width = minigameProgress+'%'; remove(); } }, duration);
      function remove() { if(target.parentNode) target.parentNode.removeChild(target); if(ring.parentNode) ring.parentNode.removeChild(ring); }
    }

    function endMinigame(won, fish) {
      minigameActive = false; clearInterval(spawnTimer); cancelAnimationFrame(gameLoop);
      const statusEl = document.getElementById('pondStatus'); document.getElementById('minigameArea').style.display = 'none'; document.getElementById('gameBarContainer').style.display = 'none'; const btn = document.getElementById('castBtn'); btn.style.display = 'block'; btn.disabled = false;
      if (won) {
        const u = getCurrentUser(); u.items.push(fish);
        
        if (fish.mutation === 'Mythical' || fish.rarity === 'legendary') {
            sendChatMessage(`${u.username} just caught a ${fish.mutation !== 'Normal' ? fish.mutation + ' ' : ''}${fish.name}!`, true);
        }

        if(!u.fishCounts) u.fishCounts = {};
        u.fishCounts[fish.name] = (u.fishCounts[fish.name] || 0) + 1;
        if (!u.discoveredFish.includes(fish.name)) { u.discoveredFish.push(fish.name); }
        const locName = fish.origin || 'pond'; const locConfig = LOCATION_CONFIG[locName] || LOCATION_CONFIG.pond; const xpMult = locConfig.xpMult || 1.0; const baseXP = XP_RATES[fish.rarity] || 1;
        
        let xpGain = Math.ceil(baseXP * xpMult);
        
        // APPLY CLUB BUFF
        if (window.clubBuffActive) {
            xpGain = Math.ceil(xpGain * 1.05);
        }

        u.xp = (u.xp || 0) + xpGain;
        if (u.xp >= u.level * 100) { u.xp -= u.level * 100; u.level++; u.coins += u.level * 50; }
        setCurrentUser(u); savePlayerToCloud(u); updateHud(); statusEl.textContent = `Caught a ${fish.name}! (+${xpGain}xp)`;
      } else { statusEl.textContent = "It got away..."; }
    }

    // --- CLUBS SYSTEM ---
    window.renderClubs = async function() {
        const u = getCurrentUser();
        mainContent.innerHTML = `${renderHudHTML()}<h2>‚öîÔ∏è Fishing Clubs</h2><div id="clubArea">Loading...</div>`;
        updateHud();

        const clubArea = document.getElementById('clubArea');

        // Requirement Check
        if (u.level < 5) {
            clubArea.innerHTML = `<div style="opacity:0.6; margin-top:50px;">
                <div style="font-size:3rem;">üîí</div>
                <h3>Locked</h3>
                <p>Reach Level 5 to access Clubs.</p>
            </div>`;
            return;
        }

        // If not in a club
        if (!u.clubName) {
            const q = query(collection(db, "clubs"), limit(20));
            const snap = await getDocs(q);
            
            let clubsHTML = "";
            if (snap.empty) {
                clubsHTML = "<p>No clubs found.</p>";
            } else {
                clubsHTML = snap.docs.map(doc => {
                    const data = doc.data();
                    const memCount = data.members ? data.members.length : 0;
                    const tag = data.tag ? `[${data.tag}]` : '';
                    return `<div class="bp-item" style="flex-direction:row; width:100%; max-width:400px; justify-content:space-between; margin:5px auto;">
                        <div style="text-align:left;"><b>${tag} ${doc.id}</b><br><small>${memCount} members</small></div>
                        <button class="btn-sm" style="background:#5bc0be;" onclick="window.joinClub('${doc.id}')">Join</button>
                    </div>`;
                }).join('');
            }

            clubArea.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:20px;">
                    <div style="background:rgba(0,0,0,0.2); padding:20px; border-radius:10px;">
                        <h3>Create a Club</h3>
                        <div style="display:flex; gap:10px; justify-content:center;">
                            <input type="text" id="newClubTag" placeholder="Tag (3-5)" maxlength="5" style="padding:8px; border-radius:5px; border:none; width:30%; text-transform:uppercase;">
                            <input type="text" id="newClubName" placeholder="Club Name (Max 15)" maxlength="15" style="padding:8px; border-radius:5px; border:none; width:60%;">
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
                            <button class="btn-sm" onclick="window.createClub('gold')">100k Gold</button>
                            <button class="btn-sm" style="background:#e040fb;" onclick="window.createClub('pearl')">5 Pearls</button>
                        </div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2); padding:20px; border-radius:10px;">
                        <h3>Join a Club</h3>
                        <div style="max-height:300px; overflow-y:auto;">${clubsHTML}</div>
                    </div>
                </div>
            `;
        } else {
            // User is in a club
            try {
                const clubRef = doc(db, "clubs", u.clubName);
                const clubSnap = await getDoc(clubRef);
                
                if (!clubSnap.exists()) {
                    // Cleanup glitch
                    u.clubName = null;
                    setCurrentUser(u);
                    savePlayerToCloud(u);
                    window.renderClubs();
                    return;
                }

                const clubData = clubSnap.data();
                
                // Get Member Details to check Online Status
                const membersSnap = await getDocs(query(collection(db, "players"), where("clubName", "==", u.clubName)));
                const members = membersSnap.docs.map(d => d.data());
                
                const now = Date.now();
                const onlineThreshold = 5 * 60 * 1000; // 5 mins
                let onlineCount = 0;
                
                const memberListHTML = members.map(m => {
                    const isOnline = (now - (m.lastSeen || 0)) < onlineThreshold;
                    if(isOnline) onlineCount++;
                    const isOwner = clubData.owner === m.username;
                    return `<div class="member-row">
                        <div><span class="online-dot ${isOnline?'active':''}"></span> ${m.username} ${isOwner ? 'üëë' : ''}</div>
                        <div style="font-size:0.8rem; opacity:0.7;">Lv ${m.level}</div>
                    </div>`;
                }).join('');

                const buffActive = onlineCount >= 5;
                window.clubBuffActive = buffActive; // Sync global state
                
                const displayTag = clubData.tag ? `[${clubData.tag}]` : '';

                clubArea.innerHTML = `
                    <div class="club-header">
                        <h1>${displayTag} ${u.clubName}</h1>
                        <p>Owner: ${clubData.owner}</p>
                    </div>
                    
                    <div class="club-buff ${buffActive ? '' : 'inactive'}">
                        <h3>‚öîÔ∏è Clan Synergy</h3>
                        <p>5+ Members Online: +5% XP to everyone</p>
                        <div style="font-weight:bold; font-size:1.2rem; margin-top:5px;">${onlineCount} / 5 Online</div>
                        <div>${buffActive ? 'ACTIVE' : 'INACTIVE'}</div>
                    </div>

                    <div class="club-member-list">
                        <h4>Members (${members.length})</h4>
                        ${memberListHTML}
                    </div>

                    <button style="background:#b0413e; margin-top:30px; font-size:0.9rem; padding:0.5rem 1rem;" onclick="window.leaveClub('${u.clubName}')">Leave Club</button>
                `;

            } catch (e) {
                console.error(e);
                clubArea.innerHTML = "Error loading club data.";
            }
        }
    };

    window.createClub = async function(currency) {
        const u = getCurrentUser();
        const nameInput = document.getElementById('newClubName');
        const tagInput = document.getElementById('newClubTag');
        const name = nameInput.value.trim();
        const tag = tagInput.value.trim().toUpperCase();

        if (name.length < 3) return alert("Name too short (3-15 chars).");
        if (name.length > 15) return alert("Name too long (Max 15).");
        if (tag.length < 3 || tag.length > 5) return alert("Tag must be 3-5 characters.");

        // Cost Check
        if (currency === 'gold') {
            if (u.coins < 100000) return alert("Not enough Gold (100k required).");
            u.coins -= 100000;
        } else {
            if (u.pearls < 5) return alert("Not enough Pearls (5 required).");
            u.pearls -= 5;
        }

        // DB Check
        const clubRef = doc(db, "clubs", name);
        const clubSnap = await getDoc(clubRef);
        if (clubSnap.exists()) return alert("Club name taken!");

        await setDoc(clubRef, {
            name: name,
            tag: tag,
            owner: u.username,
            members: [u.username],
            created: serverTimestamp()
        });

        u.clubName = name;
        u.clubTag = tag;
        setCurrentUser(u);
        savePlayerToCloud(u);
        
        alert(`Club [${tag}] ${name} created!`);
        window.renderClubs();
    };

    window.joinClub = async function(clubId) {
        const u = getCurrentUser();
        try {
            const clubRef = doc(db, "clubs", clubId);
            const clubSnap = await getDoc(clubRef);
            if(!clubSnap.exists()) { alert("Club not found"); return; }
            const cData = clubSnap.data();

            await updateDoc(clubRef, {
                members: arrayUnion(u.username)
            });
            
            u.clubName = clubId;
            u.clubTag = cData.tag;
            setCurrentUser(u);
            savePlayerToCloud(u);
            window.renderClubs();
        } catch (e) {
            alert("Could not join club. It might be full or deleted.");
        }
    };

    window.leaveClub = async function(clubId) {
        if(!confirm("Are you sure you want to leave?")) return;
        
        const u = getCurrentUser();
        try {
            const clubRef = doc(db, "clubs", clubId);
            // If owner leaves, just remove them for now (simplified logic)
            // Ideally, pass ownership or delete club, but simplified for this request:
            await updateDoc(clubRef, {
                members: arrayRemove(u.username)
            });

            u.clubName = null;
            u.clubTag = null;
            setCurrentUser(u);
            savePlayerToCloud(u);
            window.renderClubs();
        } catch(e) {
            console.error(e);
        }
    };

    // --- MARKET SYSTEM ---
    window.renderMarket = async function(tab = 'global') {
      const u = getCurrentUser();
      mainContent.innerHTML = `${renderHudHTML()}<h2>üè™ Marketplace</h2>
        <div class="market-tabs">
          <button class="tab-btn ${tab==='global'?'active':''}" onclick="window.renderMarket('global')">Global Listings</button>
          <button class="tab-btn ${tab==='sell'?'active':''}" onclick="window.renderMarket('sell')">My Listings / Sell</button>
        </div>
        <div id="marketArea">Loading...</div>`;
      updateHud();

      const area = document.getElementById('marketArea');
      
      try {
        if (tab === 'sell') {
            const q = query(collection(db, "market_listings"), where("seller", "==", u.username));
            const snap = await getDocs(q);
            const myListings = snap.docs.map(d => ({id: d.id, ...d.data()}));
            
            let activeHTML = myListings.length === 0 ? '<p>No active listings.</p>' : myListings.map(l => 
              `<div class="bp-item" style="border-color:#5bc0be;">
                 ${getEntityIcon(l.fish)}
                 <div class="${l.fish.mutation!=='Normal'?`txt-${l.fish.mutation}`:''}"><b>${l.fish.name}</b><br>${l.price}g</div>
                 <button class="market-sell-btn" style="background:#e53935;" onclick="window.cancelListing('${l.id}')">Cancel</button>
               </div>`
            ).join('');

            // Map items to preserve original index
            let invHTML = u.items.map((item, idx) => {
              if (item.type === 'chest' || item.type === 'key') return ''; 
              return `<div class="bp-item">
                ${getEntityIcon(item)}
                <div class="${item.mutation!=='Normal'?`txt-${item.mutation}`:''}"><b>${item.name}</b><br>Val: ${item.value}g</div>
                <input type="number" id="price-${idx}" class="market-price-input" placeholder="Price" min="1">
                <button class="market-sell-btn" onclick="window.listForSale(${idx})">List Item</button>
                <button class="market-sell-btn" style="background:#444; margin-top:4px;" onclick="window.npcSell(${idx})">Quick Sell (${item.value}g)</button>
              </div>`
            }).join('');

            area.innerHTML = `
              <h3>Active Listings (${myListings.length}/5)</h3>
              <div class="bp-grid">${activeHTML}</div>
              <hr style="border:1px solid rgba(255,255,255,0.1); margin:20px 0;">
              <h3>Sell from Inventory</h3>
              <div class="bp-grid">${invHTML || 'Inventory Empty'}</div>
            `;
        } else {
            const q = query(collection(db, "market_listings"), limit(50));
            const snap = await getDocs(q);
            
            if (snap.empty) { area.innerHTML = "<p>No items for sale.</p>"; return; }
            
            let gridHTML = snap.docs.map(doc => {
                const l = doc.data();
                const isMe = l.seller === u.username;
                const canAfford = u.coins >= l.price;
                const locationLocked = !u.unlockedLocations.includes(l.fish.origin);
                
                let btnHTML = "";
                if (isMe) {
                    btnHTML = `<button class="market-sell-btn" style="background:#555; cursor:default;">Yours</button>`;
                } else if (locationLocked) {
                    btnHTML = `<button class="market-sell-btn" style="background:#7a1f1b; cursor:not-allowed;" disabled>Locked (${l.fish.origin})</button>`;
                } else if (!canAfford) {
                    btnHTML = `<button class="market-sell-btn" style="background:#555; cursor:not-allowed;" disabled>Need Gold</button>`;
                } else {
                    btnHTML = `<button class="market-sell-btn" onclick="window.buyItem('${doc.id}', ${l.price}, '${l.seller}')">Buy</button>`;
                }

                return `<div class="bp-item">
                  <span class="listing-seller">Seller: ${l.seller}</span>
                  ${getEntityIcon(l.fish)}
                  <div class="${l.fish.mutation!=='Normal'?`txt-${l.fish.mutation}`:''}"><b>${l.fish.name}</b><br><span style="color:#ffd700;">${l.price}g</span></div>
                  ${btnHTML}
                </div>`;
            }).join('');
            area.innerHTML = `<div class="bp-grid">${gridHTML}</div>`;
        }
      } catch (error) {
          console.error("Market Error:", error);
          if (tab === 'sell') {
              let invHTML = u.items.map((item, idx) => {
                  if (item.type === 'chest' || item.type === 'key') return ''; 
                  return `<div class="bp-item">
                    ${getEntityIcon(item)}
                    <div class="${item.mutation!=='Normal'?`txt-${item.mutation}`:''}"><b>${item.name}</b><br>Val: ${item.value}g</div>
                    <button class="market-sell-btn" style="background:#444; margin-top:4px;" onclick="window.npcSell(${idx})">Quick Sell (${item.value}g)</button>
                  </div>`
              }).join('');
              area.innerHTML = `<h3>Sell from Inventory (Offline Mode)</h3><div class="bp-grid">${invHTML || 'Inventory Empty'}</div>`;
          } else {
              area.innerHTML = `<p>Error loading market. Check console.</p>`;
          }
      }
    };

    window.listForSale = async function(idx) {
        const u = getCurrentUser();
        const priceInput = document.getElementById(`price-${idx}`);
        const price = parseInt(priceInput.value);
        if (!price || price < 1) return alert("Invalid price.");

        try {
            const q = query(collection(db, "market_listings"), where("seller", "==", u.username));
            const snap = await getDocs(q);
            if (snap.size >= 5) return alert("You can only have 5 active listings.");

            const item = u.items[idx];
            u.items.splice(idx, 1); // Remove from inventory
            
            await addDoc(collection(db, "market_listings"), {
                seller: u.username,
                fish: item,
                price: price,
                timestamp: serverTimestamp()
            });
            
            setCurrentUser(u); savePlayerToCloud(u);
            alert("Item listed!");
            window.renderMarket('sell');
        } catch (e) {
            console.error(e);
            alert("Listing failed. Check permissions.");
        }
    };

    window.cancelListing = async function(listingId) {
        const u = getCurrentUser();
        const docRef = doc(db, "market_listings", listingId);
        const snap = await getDoc(docRef);
        if (!snap.exists()) return alert("Listing not found.");
        
        const data = snap.data();
        if (data.seller !== u.username) return alert("Not your listing.");

        await deleteDoc(docRef);
        u.items.push(data.fish); // Return to inventory
        setCurrentUser(u); savePlayerToCloud(u);
        window.renderMarket('sell');
    };

    window.buyItem = async function(listingId, price, sellerName) {
        const u = getCurrentUser();
        if (u.coins < price) return alert("Not enough gold.");

        const docRef = doc(db, "market_listings", listingId);
        const snap = await getDoc(docRef);
        if (!snap.exists()) {
            alert("Item already sold!");
            window.renderMarket('global');
            return;
        }

        const data = snap.data();
        u.coins -= price;
        u.items.push(data.fish);
        setCurrentUser(u); savePlayerToCloud(u);

        await deleteDoc(docRef);

        try {
            // FIX: Use atomic increment to ensure seller gets gold even if concurrent writes happen
            const sellerRef = doc(db, "players", sellerName);
            await updateDoc(sellerRef, {
                coins: increment(price)
            });
        } catch(e) { console.error("Error paying seller:", e); }

        alert(`Bought ${data.fish.name} for ${price}g!`);
        window.renderMarket('global');
    };

    window.npcSell = function(idx) {
        const u = getCurrentUser();
        u.coins += u.items[idx].value;
        u.items.splice(idx, 1);
        setCurrentUser(u); savePlayerToCloud(u);
        window.renderMarket('sell');
    };

    // --- QUESTS LOGIC ---
    window.renderQuests = function() {
      let u = getCurrentUser();
      const resetNeeded = checkAndResetQuests(u);
      if(resetNeeded) { setCurrentUser(u); savePlayerToCloud(u); }
      
      const listHTML = u.dailyQuests.map(q => {
        if (q.current === undefined) q.current = 0;
        
        const heldCount = u.items.filter(i => i.name === q.target).length;
        const pct = Math.min(100, (q.current / q.needed) * 100);
        const isDone = q.current >= q.needed;
        
        let actionBtn;
        if (q.claimed) { 
            actionBtn = `<span class="quest-done-badge">Completed</span>`; 
        } else if (isDone) {
            actionBtn = `<button class="quest-reward-btn" onclick="window.claimReward(${q.id})">Claim ${q.reward}g</button>`;
        } else if (heldCount > 0) { 
            actionBtn = `<button class="quest-turnin-btn" onclick="window.turnInOne(${q.id})">Turn In (1)</button>`; 
        } else { 
            actionBtn = `<span style="font-size:0.8rem; opacity:0.7;">Need ${q.target}</span>`; 
        }
        
        return `
          <div class="quest-card">
            <div style="font-size:2rem;">${q.claimed ? '‚úÖ' : 'üêü'}</div>
            <div class="quest-info">
              <div class="quest-title">Deliver ${q.target}</div>
              <div class="quest-desc">Progress: ${q.current} / ${q.needed} (Have: ${heldCount})</div>
              <div class="quest-progress-bg"><div class="quest-progress-fill" style="width:${pct}%"></div></div>
            </div>
            <div>${actionBtn}</div>
          </div>
        `;
      }).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üìú Daily Quests</h2><p style="font-size:0.8rem; opacity:0.7; margin-bottom:20px;">Turn in fish one by one to complete the order.</p><div style="width:100%; max-width:600px;">${listHTML}</div>`;
      updateHud();
    };

    window.turnInOne = function(qId) {
        const u = getCurrentUser();
        const quest = u.dailyQuests.find(q => q.id === qId);
        if (!quest || quest.claimed || quest.current >= quest.needed) return;
        const fishIdx = u.items.findIndex(i => i.name === quest.target);
        if (fishIdx === -1) return alert("You don't have this fish!");
        u.items.splice(fishIdx, 1);
        quest.current = (quest.current || 0) + 1;
        setCurrentUser(u); savePlayerToCloud(u);
        window.renderQuests();
    };

    window.claimReward = function(qId) {
        const u = getCurrentUser();
        const quest = u.dailyQuests.find(q => q.id === qId);
        if (!quest || quest.claimed || quest.current < quest.needed) return;
        quest.claimed = true;
        u.coins += quest.reward;
        setCurrentUser(u); savePlayerToCloud(u);
        window.renderQuests();
    };

    // --- OTHER UI RENDERS ---
    window.renderBackpack = function() {
      const u = getCurrentUser(); const items = u.items || [];
      let gridHTML = items.map((item, idx) => {
        let actionBtn = "";
        if (item.type === "chest") {
            const hasKey = items.some(i => i.type === 'key');
            if (hasKey) { actionBtn = `<button class="btn-sm" style="background:#e040fb; margin-top:5px; width:100%;" onclick="window.openChest(${idx})">Open</button>`; }
            else { actionBtn = `<div style="font-size:0.7rem; color:#aaa; margin-top:5px;">Needs Key</div>`; }
        }
        else if (item.favorite) { actionBtn = `<button class="star-btn fav-active" onclick="window.toggleFav(${idx})">‚òÖ</button>`; }
        else { actionBtn = `<button class="star-btn" onclick="window.toggleFav(${idx})">‚òÜ</button>`; }
        const classMod = item.type === 'chest' ? 'item-chest' : (item.type === 'key' ? 'item-key' : '');
        const valText = item.type === 'chest' || item.type === 'key' ? '' : `¬∑ ${item.value}g`;
        return `<div class="bp-item ${item.mutation!=='Normal'?`mut-${item.mutation}`:''} ${classMod}">
            ${item.type !== 'chest' && item.type !== 'key' ? actionBtn : ''}
            ${getEntityIcon(item)}
            <div class="${item.mutation!=='Normal'?`txt-${item.mutation}`:''}"><b>${item.size || ''} ${item.name}</b><br>${valText}</div>
            ${item.type === 'chest' ? actionBtn : ''}
        </div>`;
      }).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üéí Backpack (${items.length}/${u.maxItems})</h2><div class="bp-grid">${gridHTML || 'Empty'}</div>`; updateHud();
    };
    
    window.toggleFav = function(i) { const u = getCurrentUser(); u.items[i].favorite = !u.items[i].favorite; setCurrentUser(u); savePlayerToCloud(u); window.renderBackpack(); };
    window.openChest = function(chestIdx) { const u = getCurrentUser(); const keyIdx = u.items.findIndex(i => i.type === 'key'); if (keyIdx === -1) return alert("No key found!"); if (keyIdx > chestIdx) { u.items.splice(keyIdx, 1); u.items.splice(chestIdx, 1); } else { u.items.splice(chestIdx, 1); u.items.splice(keyIdx, 1); } const r = Math.random(); let msg = ""; if (r < 0.1) { const p = 1 + Math.floor(Math.random()*2); u.pearls += p; msg = `üéâ Found ${p} Pearls!`; } else if (r < 0.4) { const g = 20000 + Math.floor(Math.random()*10000); u.coins += g; msg = `üí∞ Found ${g} Gold!`; } else { const g = 5000 + Math.floor(Math.random()*5000); u.coins += g; msg = `üí∞ Found ${g} Gold.`; } setCurrentUser(u); savePlayerToCloud(u); alert(msg); window.renderBackpack(); };

    window.renderPond = function() { mainContent.innerHTML = `${renderHudHTML()}<div class="pond-wrap"><div class="pond-header"><button class="back-inline" onclick="window.renderFishingSpot()">‚Üê Back</button><h2>üêü Pond</h2></div><div class="game-bar-container" id="gameBarContainer"><div class="game-bar-fill" id="gameBarFill"></div></div><div class="status" id="pondStatus">Scanning water...</div><div class="wait-bar" id="waitBar"><div class="wait-fill" id="waitFill"></div></div><div class="minigame-area" id="minigameArea"></div><button id="castBtn" onclick="window.handleCast('pond')">Cast Line</button></div>`; };
    window.renderStream = function() { mainContent.innerHTML = `${renderHudHTML()}<div class="pond-wrap"><div class="pond-header"><button class="back-inline" onclick="window.renderFishingSpot()">‚Üê Back</button><h2>üåä Stream</h2></div><div class="game-bar-container" id="gameBarContainer"><div class="game-bar-fill" id="gameBarFill"></div></div><div class="status" id="pondStatus">Current flows gently...</div><div class="wait-bar" id="waitBar"><div class="wait-fill" id="waitFill"></div></div><div class="minigame-area" id="minigameArea"></div><button id="castBtn" onclick="window.handleCast('stream')">Cast Line</button></div>`; };
    
    window.renderFishingSpot = function() {
      const u = getCurrentUser(); const currentRod = getEquippedRod(u); const streamUnlocked = u.unlockedLocations.includes("stream");
      let streamBtnHTML = streamUnlocked ? `<button class="location-btn" onclick="window.renderStream()">üåä Stream</button>` : (u.level < 5 ? `<button class="location-btn btn-locked" disabled>üîí Stream (Lv 5)</button>` : `<button class="location-btn btn-locked" onclick="window.unlockStream()">üîí Unlock Stream (2500g)</button>`);
      mainContent.innerHTML = `${renderHudHTML()}<h2>üé£ Fishing Spot</h2><p>Using: <b>${currentRod.icon} ${currentRod.name}</b></p><button class="location-btn" onclick="window.renderPond()">üêü Pond</button>${streamBtnHTML}`; updateHud();
    };
    window.unlockStream = function() { const u = getCurrentUser(); if(u.coins >= 2500) { if(confirm("Unlock Stream for 2500g?")) { u.coins -= 2500; u.unlockedLocations.push("stream"); setCurrentUser(u); savePlayerToCloud(u); window.renderFishingSpot(); } } else { alert("Not enough gold!"); } };

    window.confirmRetire = function() { const u = getCurrentUser(); if (u.level < 50) return; const pearlReward = 10 + (u.level - 50); if (confirm(`Are you sure you want to RETIRE?\n\nRewards:\n- Prestige Rank +1\n- ${pearlReward} Pearls\n\nYou will keep Chests and Keys, but LOSE all Gold, Rods, and Levels.`)) { u.pearls += pearlReward; u.prestige++; u.items = u.items.filter(i => i.type === 'chest' || i.type === 'key'); u.level = 1; u.xp = 0; u.coins = 0; u.ownedRods = [0]; u.equippedRod = 0; setCurrentUser(u); savePlayerToCloud(u); alert("You have retired!"); location.reload(); } };

    window.renderShop = function() {
      const u = getCurrentUser();
      const upgradeCost = (u.maxItems || 15) * 50;
      const upgradeHTML = `<div class="bp-item upgrade-item"><h3>Expand Bag</h3><p>${u.maxItems} -> ${u.maxItems+5}</p><button class="shop-btn btn-buy" onclick="window.buyBag()">Buy ${upgradeCost}g</button></div>`;
      const keyHTML = `<div class="bp-item item-key">
        <h3>üîë Golden Key</h3>
        <p>Opens Treasure Chests</p>
        <button class="shop-btn btn-buy" onclick="window.buyKey('gold')">10,000g</button>
        <button class="shop-btn btn-pearl" onclick="window.buyKey('pearl')">1 Pearl</button>
      </div>`;
      const rodsHTML = RODS.map(r => {
        const owned = u.ownedRods.includes(r.id); const eq = u.equippedRod === r.id;
        let btn = eq ? `<button class="shop-btn btn-owned">Equipped</button>` : (owned ? `<button class="shop-btn btn-equip" onclick="window.eqRod(${r.id})">Equip</button>` : `<button class="shop-btn btn-buy" onclick="window.buyRod(${r.id})">${r.cost}g</button>`);
        return `<div class="bp-item"><h3>${r.icon} ${r.name}</h3><p>${r.luck}x Luck</p>${btn}</div>`;
      }).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üõí Rod Shop</h2><div class="bp-grid">${upgradeHTML}${keyHTML}${rodsHTML}</div>`; updateHud();
    };

    window.buyBag = function() { const u = getCurrentUser(); const c = u.maxItems * 50; if(u.coins >= c) { u.coins -= c; u.maxItems += 5; setCurrentUser(u); savePlayerToCloud(u); window.renderShop(); } };
    window.buyRod = function(id) { const u = getCurrentUser(); const r = RODS[id]; if(u.coins >= r.cost) { u.coins -= r.cost; u.ownedRods.push(id); u.equippedRod = id; setCurrentUser(u); savePlayerToCloud(u); window.renderShop(); } };
    window.eqRod = function(id) { const u = getCurrentUser(); u.equippedRod = id; setCurrentUser(u); savePlayerToCloud(u); window.renderShop(); };
    window.buyKey = function(currency) { const u = getCurrentUser(); if (currency === 'gold') { if (u.coins >= 10000) { u.coins -= 10000; u.items.push({ name: "Golden Key", type: "key", value: 0 }); setCurrentUser(u); savePlayerToCloud(u); window.renderShop(); } else alert("Not enough Gold!"); } else { if (u.pearls >= 1) { u.pearls -= 1; u.items.push({ name: "Golden Key", type: "key", value: 0 }); setCurrentUser(u); savePlayerToCloud(u); window.renderShop(); } else alert("Not enough Pearls!"); } };
    
    window.renderIndex = function(filterType = 'all') {
      const u = getCurrentUser();
      const pondItems = pondTable.map(i => ({...i, _origin: 'pond'}));
      const streamItems = streamTable.map(i => ({...i, _origin: 'stream'}));
      
      const allFish = [...pondItems, ...streamItems];
      const uniqueAll = allFish.filter((v, i, a) => a.findIndex(t => t.name === v.name) === i);

      let displayList = [];
      if (filterType === 'pond') { displayList = pondItems; }
      else if (filterType === 'stream') { displayList = streamItems; }
      else { displayList = uniqueAll; } 
      
      const tabs = ['all', 'pond', 'stream'];
      const tabsHTML = tabs.map(t => `<button class="tab-btn ${t===filterType?'active':''}" onclick="window.renderIndex('${t}')">${t.charAt(0).toUpperCase()+t.slice(1)}</button>`).join('');
      function getWeatherIcons(weatherArr) { if(!weatherArr) return ''; const map = { 'rain': 'üåßÔ∏è', 'storm': '‚õàÔ∏è', 'fog': 'üå´Ô∏è', 'heat': 'üî•', 'clear': '‚òÄÔ∏è' }; return weatherArr.map(w => map[w]).join(' '); }
      function getTimeIcons(timeArr) { if(!timeArr) return ''; const map = { 'day': '<span class="time-icon-day">‚òÄÔ∏è</span>', 'night': '<span class="time-icon-night">üåô</span>' }; return timeArr.map(t => map[t]).join(' '); }
      const gridHTML = displayList.map(item => {
        const isUnlocked = u.discoveredFish.includes(item.name) || item.type === 'chest';
        const count = (u.fishCounts || {})[item.name] || 0;
        let badgeClass = ""; let nextReq = 100;
        if (count >= 1000) { badgeClass = "badge-gold"; nextReq = "MAX"; }
        else if (count >= 500) { badgeClass = "badge-silver"; nextReq = 1000; }
        else if (count >= 100) { badgeClass = "badge-bronze"; nextReq = 500; }
        const pct = nextReq === "MAX" ? 100 : Math.min(100, (count / nextReq) * 100);
        let reqHtml = '';
        if (item.weather) reqHtml += `<div>${getWeatherIcons(item.weather)}</div>`;
        if (item.time) reqHtml += `<div>${getTimeIcons(item.time)}</div>`;
        if (reqHtml) reqHtml = `<div style="font-size:0.8rem; margin-top:4px;">${reqHtml}</div>`;
        return `
          <div class="${isUnlocked?'index-card unlocked':'index-card'} ${isUnlocked ? badgeClass : ''}">
            ${getEntityIcon(item)}
            <div class="index-name">${isUnlocked?item.name:'???'}</div>
            <div class="index-rarity" style="color:${isUnlocked?'#5bc0be':'#555'}">${isUnlocked?item.rarity:'Unknown'}</div>
            ${isUnlocked ? reqHtml : ''}
            ${isUnlocked ? `<div class="mastery-info"><div>Caught: ${count}</div><div class="mastery-bar-bg"><div class="mastery-bar-fill" style="width:${pct}%"></div></div></div>` : ''}
          </div>`;
      }).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üìñ Fish Index</h2><div class="index-tabs">${tabsHTML}</div><p style="margin-top:0;">Global Discovery: ${u.discoveredFish.length} / ${uniqueAll.length} species</p><div class="index-grid">${gridHTML}</div>`;
      updateHud();
    };

    window.renderLeaderboard = async function() {
      mainContent.innerHTML = `${renderHudHTML()}<h2>üèÜ Leaderboard</h2><p>Loading ranking...</p>`;
      const p = await getAllPlayers(); 
      p.sort((a, b) => {
        const prestigeA = a.prestige || 0;
        const prestigeB = b.prestige || 0;
        if (prestigeB !== prestigeA) { return prestigeB - prestigeA; }
        return (b.level || 0) - (a.level || 0);
      });
      const rows = p.slice(0, 10).map((player, i) => {
        let rankClass = ""; 
        if (i === 0) rankClass = "rank-1"; else if (i === 1) rankClass = "rank-2"; else if (i === 2) rankClass = "rank-3";
        
        // --- TAG DISPLAY LOGIC ---
        const tagDisplay = player.clubTag ? `<span style="color:#81c784; font-weight:bold; margin-right:5px;">[${player.clubTag}]</span> ` : '';

        return `
          <div class="lb-row">
            <div class="lb-rank ${rankClass}">#${i+1}</div>
            <div class="lb-name" onclick="window.viewProfile('${player.username}')">
               ${tagDisplay}${player.username}
            </div>
            <div style="font-weight:bold; letter-spacing:1px; min-width:140px; text-align:right;">
               <span style="color:#7986cb;">P ${player.prestige || 0}</span> 
               <span style="color:#a06cd5; margin-left:10px;">LV ${player.level}</span>
            </div>
          </div>`;
      }).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üèÜ Leaderboard</h2><div class="lb-list">${rows}</div>`; updateHud();
    }

    function calculatePassive(user) {
      const now = Date.now();
      const diffHours = (now - (user.home.lastClaim || now)) / (1000 * 60 * 60);
      let ratePerHour = 0;
      if(user.home && user.home.slots) {
        user.home.slots.forEach(slot => {
          if (slot.unlocked && slot.fish) {
            ratePerHour += Math.ceil(slot.fish.value * 0.4);
          }
        });
      }
      return { rate: ratePerHour, pending: Math.floor(ratePerHour * diffHours) };
    }

    window.renderHome = function() {
      let u = getCurrentUser(); u = initUserData(u);
      const passive = calculatePassive(u);
      const slotsHTML = u.home.slots.map(slot => {
        if (!slot.unlocked) {
          const cost = SLOT_COSTS[slot.id];
          const prevUnlocked = (slot.id === 0) || u.home.slots[slot.id - 1].unlocked;
          const lockClass = prevUnlocked ? "slot-locked" : "slot-locked slot-locked-disabled";
          return `<div class="home-slot ${lockClass}" onclick="window.unlockHomeSlot(${slot.id})"><div class="lock-icon">üîí</div><div class="lock-cost">${cost}g</div></div>`;
        } else if (slot.fish) {
          const fish = slot.fish;
          const mutClass = fish.mutation !== "Normal" ? `mut-${fish.mutation}` : "";
          const txtClass = fish.mutation !== "Normal" ? `txt-${fish.mutation}` : "";
          const rate = Math.ceil(fish.value * 0.4);
          return `<div class="home-slot slot-occupied ${mutClass}" onclick="window.removeFishFromSlot(${slot.id})">${getEntityIcon(fish)}<div class="slot-fish-name ${txtClass}">${fish.name}</div><div class="slot-fish-val">${rate}g/hr</div></div>`;
        } else {
          return `<div class="home-slot" onclick="window.openFishSelector(${slot.id})"><div style="font-size:1.5rem; opacity:0.5;">+</div><div style="font-size:0.8rem; opacity:0.7;">Empty</div></div>`;
        }
      }).join('');
      mainContent.innerHTML = `${renderHudHTML()}<h2>üè† Home Aquarium</h2><div class="home-header"><div class="passive-info">Generated: <b>${passive.pending}g</b> <span style="opacity:0.7">(${passive.rate}g/hr)</span></div><button class="claim-btn" id="claimBtn" ${passive.pending <= 0 ? 'disabled' : ''}>Claim Gold</button></div><div class="slot-grid">${slotsHTML}</div>`;
      updateHud();
      document.getElementById('claimBtn').onclick = claimPassiveGold;
    }
    
    function claimPassiveGold() { const u = getCurrentUser(); const passive = calculatePassive(u); if (passive.pending > 0) { u.coins += passive.pending; u.home.lastClaim = Date.now(); setCurrentUser(u); savePlayerToCloud(u); window.renderHome(); } }
    window.unlockHomeSlot = function(id) { const u = getCurrentUser(); const cost = SLOT_COSTS[id]; if (u.coins >= cost) { if(confirm(`Unlock Slot ${id+1} for ${cost} gold?`)) { u.coins -= cost; u.home.slots[id].unlocked = true; setCurrentUser(u); savePlayerToCloud(u); window.renderHome(); } } else { alert("Not enough gold!"); } };
    window.removeFishFromSlot = function(slotId) { const u = getCurrentUser(); const fish = u.home.slots[slotId].fish; if (!fish) return; u.items.push(fish); u.home.slots[slotId].fish = null; setCurrentUser(u); savePlayerToCloud(u); window.renderHome(); };
    window.openFishSelector = function(slotId) {
      const u = getCurrentUser(); 
      let validFish = u.items.map((item, idx) => {
        const rate = Math.ceil(item.value * 0.4);
        return { ...item, originalIdx: idx, calculatedRate: rate };
      }).filter(i => i.type === 'fish');
      validFish.sort((a, b) => b.calculatedRate - a.calculatedRate);
      let listHTML = validFish.length === 0 ? "<p>No fish in backpack.</p>" : validFish.map(f => `<div class="bp-item" style="width:300px; flex-direction:row; justify-content:space-between; margin:5px auto;"><div>${getEntityIcon(f)}</div><div style="text-align:left;"><b>${f.name}</b><br><small>${f.calculatedRate}g/hr</small></div><button class="btn-sm" style="background:#5bc0be" onclick="window.placeFish(${slotId}, ${f.originalIdx})">Select</button></div>`).join('');
      const selOverlay = document.createElement('div'); selOverlay.className = "selector-overlay"; selOverlay.innerHTML = `<button class="selector-close" id="closeSel">Close</button><h3>Select a Fish</h3><div style="overflow-y:auto; max-height:400px; width:100%;">${listHTML}</div>`; mainContent.appendChild(selOverlay); document.getElementById('closeSel').onclick = () => window.renderHome();
    };
    window.placeFish = function(sId, itemIdx) { const u = getCurrentUser(); const fishToMove = u.items[itemIdx]; if(!fishToMove) { window.renderHome(); return; } u.items.splice(itemIdx, 1); u.home.slots[sId].fish = fishToMove; setCurrentUser(u); savePlayerToCloud(u); window.renderHome(); };
    window.viewProfile = async function(username) {
      const data = await getPlayerProfile(username);
      if(!data) return alert("Player not found");
      const safeUser = { ...data, home: data.home || { slots: [] } };
      document.getElementById('profName').textContent = safeUser.username;
      document.getElementById('profStats').textContent = `Lv ${safeUser.level} ¬∑ ${safeUser.coins}g`;
      const passive = calculatePassive(safeUser);
      document.getElementById('profPassive').textContent = `Generating: ${passive.rate}g/hr`;
      const grid = document.getElementById('profGrid');
      grid.innerHTML = (safeUser.home.slots || []).map(slot => {
         if (slot.unlocked && slot.fish) {
           const fish = slot.fish; const mutClass = fish.mutation !== "Normal" ? `mut-${fish.mutation}` : "";
           return `<div class="home-slot slot-occupied ${mutClass}">${getEntityIcon(fish)}<div class="slot-fish-name">${fish.name}</div></div>`;
         } else if (slot.unlocked) { return `<div class="home-slot" style="opacity:0.5; font-size:0.8rem;">Empty</div>`;
         } else { return `<div class="home-slot slot-locked"><div class="lock-icon">üîí</div></div>`; }
      }).join('');
      profileOverlay.style.display = 'flex';
    };

    function updateHeartbeat() {
        const u = getCurrentUser();
        if(u) {
            // Update local storage
            u.lastSeen = Date.now();
            setCurrentUser(u);
            // Update Cloud
            const ref = doc(db, "players", u.username);
            updateDoc(ref, { lastSeen: Date.now() }).catch(e => console.log("Heartbeat fail", e));
        }
    }

    function startGame(user) { 
        overlay.style.display = 'none'; 
        title.style.display = 'none'; 
        startButton.style.display = 'none'; 
        signinLink.style.display = 'none'; 
        gameContainer.style.display = 'flex'; 
        
        // Show Admin Panel if user is Llama
        if(user.username === "Llama") {
            adminPanel.style.display = 'block';
            adminResetBtn.style.display = 'block';
        } else {
            adminPanel.style.display = 'none';
            adminResetBtn.style.display = 'none';
        }
        
        document.getElementById('chatContainer').style.display = 'flex';
        initChat(); 
        window.renderHome(); 

        // Start Heartbeat
        updateHeartbeat();
        setInterval(updateHeartbeat, 60000); // Every minute

        // START REALTIME LISTENER FOR USER DATA (For Gold Sync on Sale)
        if(unsubscribePlayerDoc) unsubscribePlayerDoc();
        unsubscribePlayerDoc = onSnapshot(doc(db, "players", user.username), (docSnap) => {
            if (docSnap.exists()) {
                const cloudData = docSnap.data();
                const localUser = getCurrentUser();
                
                // SYNC CHECK: If cloud has significantly more gold than local, we likely sold something while online.
                // We only sync UP gold to avoid overwriting local progress with old cloud data.
                if (cloudData.coins > localUser.coins) {
                    const diff = cloudData.coins - localUser.coins;
                    localUser.coins = cloudData.coins; // Update local gold
                    
                    setCurrentUser(localUser);
                    updateHud(); // Refresh UI
                    
                    // Notify User
                    const chatEl = document.getElementById('chatMessages');
                    const notif = document.createElement('div');
                    notif.className = 'msg-row';
                    notif.innerHTML = `<span class="msg-system" style="color:#4caf50; border-color:#4caf50; background:rgba(76, 175, 80, 0.1);">üí∞ Market Update: You received ${diff} gold!</span>`;
                    chatEl.appendChild(notif);
                    chatEl.scrollTop = chatEl.scrollHeight;
                }
            }
        });
    }

    document.getElementById('loginButton').onclick = async () => { 
      const u = document.getElementById('signin-username').value.trim(); const p = document.getElementById('signin-password').value.trim();
      if(u==="Llama" && p==="Helloworld") { 
          const masterData = await getPlayerProfile("Llama");
          if(masterData) { setCurrentUser(masterData); startGame(masterData); }
          else { const master = { username: "Llama", password: "Helloworld", coins: 250000, level: 50, items: [], prestige: 0, pearls: 0 }; setCurrentUser(master); startGame(master); }
          return; 
      }
      const snap = await getDoc(doc(db, "players", u)); if(snap.exists() && snap.data().password === p) { setCurrentUser(snap.data()); startGame(snap.data()); } else { alert("Error"); }
    };
    document.getElementById('signupButton').onclick = async () => {
      const u = document.getElementById('signup-username').value.trim(); const p = document.getElementById('signup-password').value.trim(); const e = document.getElementById('signup-email').value.trim();
      const newUser = { username: u, password: p, email: e, coins: 0, level: 1, items: [], discoveredFish: [], prestige: 0, pearls: 0 }; await savePlayerToCloud(newUser); alert("Created!"); location.reload();
    };
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('currentUser'); location.reload(); };
    document.getElementById('homeBtn').onclick = window.renderHome;
    document.getElementById('fishingSpotBtn').onclick = window.renderFishingSpot;
    document.getElementById('backpackBtn').onclick = window.renderBackpack;
    document.getElementById('questsBtn').onclick = window.renderQuests;
    document.getElementById('marketBtn').onclick = () => window.renderMarket('global');
    document.getElementById('shopBtn').onclick = window.renderShop;
    document.getElementById('clubsBtn').onclick = window.renderClubs;
    document.getElementById('indexBtn').onclick = () => window.renderIndex('all');
    document.getElementById('leaderboardBtn').onclick = window.renderLeaderboard;

    (async function() { const s = getCurrentUser(); if(s) startGame(s); })();
  </script>
</body>
</html>
